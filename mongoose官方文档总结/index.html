<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="六个周的博客"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="六个周"><meta name="twitter:creator" content="@liugezhou"><meta name="twitter:title" content="mongoose官方文档总结"><meta name="twitter:description" content="&lt;p&gt;&lt;font color=blue&gt;更新说明：对文章目录排版做了调整。&lt;/font&gt;&lt;br&gt;
&lt;font color=blue&gt; 更新时间：2022-05-04&lt;/font&gt;&lt;/p&gt;
&lt;h2 id=&quot;一、mongoose&quot;&gt;一、mongoose&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;安装：npm install  mongoose&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 1，引入mongoose&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; mongoose = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;mongoose&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 2. 连接本地数据库&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; db = mongoose.&lt;span class=&quot;title function_&quot;&gt;connect&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;mongodb://localhost/test&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; db = mongoose.&lt;span class=&quot;property&quot;&gt;connection&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;db.&lt;span class=&quot;title function_&quot;&gt;on&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;error&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;error&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;bind&lt;/span&gt;(&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;#x27;connection error:&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;db.&lt;span class=&quot;title function_&quot;&gt;once&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;open&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// we&amp;#x27;re connected!&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;mongoose里，一切始于Schema：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; tomSchema = mongoose.&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//接着，把这个Schema编译成一个Model&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Tom&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Tom&amp;#x27;&lt;/span&gt;,tomSchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 给这个model加一个code方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Tom&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;methods&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;code&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; nickname = &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt; ? &lt;span class=&quot;string&quot;&gt;&amp;quot;The programmar name is :&amp;quot;&lt;/span&gt; + &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;I don&amp;#x27;&lt;/span&gt;t have name&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  console.log(nickname)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;//model是我们构造document的class，每个document都是一个Tom对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;let Tomliu = new Tom(&amp;#123;name:&amp;#x27;&lt;/span&gt;liugezhou&lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#125;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;Tomliu.code() //The programmar name is :liugezhou&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;// save&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;Tomliu.save(function(err,item)&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	if (err) return console.error(err);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;   item.speak();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;// 获取所有的Tom&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;Tom.find(function(err,tomlius)&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	if(err) return console.error(err);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;  console.log(tomlius)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;//获取特定数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;Tom.find(&amp;#123;name:/^liugezhou/&amp;#125;,callback)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;二、Schema-模式&quot;&gt;二、Schema-模式&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;每个Schema都会映射到MongoDB 的collection，并定义这个collection里的文档构成&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;语法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;const shcema = mongoose.Schema({})&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;允许使用的Schematypes有：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;String&lt;/li&gt;
&lt;li&gt;Boolean&lt;/li&gt;
&lt;li&gt;Date&lt;/li&gt;
&lt;li&gt;Number&lt;/li&gt;
&lt;li&gt;Array&lt;/li&gt;
&lt;li&gt;Buffer&lt;/li&gt;
&lt;li&gt;Mixed&lt;/li&gt;
&lt;li&gt;ObjectId&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;除了映射collection外，还可以定义&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;document的instance methods&lt;/li&gt;
&lt;li&gt;model的static Model methods&lt;/li&gt;
&lt;li&gt;复合索引&lt;/li&gt;
&lt;li&gt;文档的生命周期钩子，也成为中间件&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;model&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我们要把一个Schema转化为一个model，要使用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;let model = mongoose.model(modelName,schema)  函数&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;collection和document&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;collection相当于关系型数据库中的表&lt;/li&gt;
&lt;li&gt;document相当于一条数据，在这里有特别需要注意的一点是：&lt;/li&gt;
&lt;li&gt;collection不要求文档有相同的结构，在一个collection文档中不必具有相同的fileds，对于单个field在一个collection中的不同文档中可以是不同的数据类型&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;实例方法methods&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;documents是model的实例,document有自带的实例方法，当然也可以自定义我们自己的方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; animalSchema = mongoose.&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;animalSchema.&lt;span class=&quot;property&quot;&gt;methods&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;findSameType&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;cb&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Animal&amp;#x27;&lt;/span&gt;).&lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;(&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;type&lt;/span&gt;,cb)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Animal&amp;#x27;&lt;/span&gt;,animalSchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; dog = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;dog&amp;#x27;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dog.&lt;span class=&quot;title function_&quot;&gt;findSameType&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,dogs&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(dogs)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;静态方法&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;静态方法与实例方法的区别是，实例方法是在每个model的实例中可以访问，而静态方法是每个model直接访问&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;animalSchema.&lt;span class=&quot;property&quot;&gt;statics&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;findByName&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;name,cb&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;RegExp&lt;/span&gt;(name,&lt;span class=&quot;string&quot;&gt;&amp;#x27;i&amp;#x27;&lt;/span&gt;)&amp;#125;,cb)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Animal&amp;#x27;&lt;/span&gt;,animalSchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;findByName&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;fido&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,animal&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(animals)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;查询助手&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;查询助手作用于query实例，方便定义自己的查询扩展&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;animalSchema.&lt;span class=&quot;property&quot;&gt;query&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;byName&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;name&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;(&amp;#123; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;RegExp&lt;/span&gt;(name, &lt;span class=&quot;string&quot;&gt;&amp;#x27;i&amp;#x27;&lt;/span&gt;) &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Animal&amp;#x27;&lt;/span&gt;, animalSchema);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Animal&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;().&lt;span class=&quot;title function_&quot;&gt;byName&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;fido&amp;#x27;&lt;/span&gt;).&lt;span class=&quot;title function_&quot;&gt;exec&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err, animals&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(animals);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;索引&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Mongodb支持secondary indexes,在mongoose中，我们在Schema中定义索引，索引字段级别和shcema级别&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; animalSchema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;tags&lt;/span&gt;: &amp;#123; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;: [&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;], &lt;span class=&quot;attr&quot;&gt;index&lt;/span&gt;: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &amp;#125; &lt;span class=&quot;comment&quot;&gt;// field level&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;animalSchema.&lt;span class=&quot;title function_&quot;&gt;index&lt;/span&gt;(&amp;#123; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;: -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;#125;); &lt;span class=&quot;comment&quot;&gt;// schema level&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;虚拟值 Virtual&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;[ ]  Virtual是document的属性，但是不会保存到MongoDB，getter可以用于格式化和组合字段数据，setter可以很方便的分解一个值到多个字段。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// define a schema&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; personSchema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;first&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;last&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// compile our model&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Person&amp;#x27;&lt;/span&gt;, personSchema);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// create a document&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; axl = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &amp;#123; &lt;span class=&quot;attr&quot;&gt;first&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;#x27;Axl&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;attr&quot;&gt;last&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;#x27;Rose&amp;#x27;&lt;/span&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;如果你要log出全名，可以这么做：&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight arcade&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;(axl.name.&lt;span class=&quot;built_in&quot;&gt;first&lt;/span&gt; + &lt;span class=&quot;string&quot;&gt;&amp;#x27; &amp;#x27;&lt;/span&gt; + axl.name.last); &lt;span class=&quot;comment&quot;&gt;// Axl Rose&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;但是每次都这么拼接实在太麻烦了， 推荐你使用&lt;a href=&quot;http://www.mongoosejs.net/docs/api.html#virtualtype_VirtualType-get&quot;&gt;virtual property getter&lt;/a&gt;， 这个方法允许你定义一个 fullName 属性，但不必保存到数据库。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;personSchema.&lt;span class=&quot;title function_&quot;&gt;virtual&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;fullName&amp;#x27;&lt;/span&gt;).&lt;span class=&quot;title function_&quot;&gt;get&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; (&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;first&lt;/span&gt; + &lt;span class=&quot;string&quot;&gt;&amp;#x27; &amp;#x27;&lt;/span&gt; + &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;last&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;现在, mongoose 可以调用 getter 函数访问 fullName 属性：&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight arcade&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;(axl.fullName); &lt;span class=&quot;comment&quot;&gt;// Axl Rose&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;如果对 document 使用 toJSON() 或 toObject()，默认不包括虚拟值， 你需要额外向 &lt;a href=&quot;http://www.mongoosejs.net/docs/api.html#document_Document-toObject&quot;&gt;toObject()&lt;/a&gt; 或者 toJSON() 传入参数** { virtuals: true }**。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;你也可以设定虚拟值的 setter ，下例中，当你赋值到虚拟值时，它可以自动拆分到其他属性：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;personSchema.&lt;span class=&quot;title function_&quot;&gt;virtual&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;fullName&amp;#x27;&lt;/span&gt;).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;get&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;first&lt;/span&gt; + &lt;span class=&quot;string&quot;&gt;&amp;#x27; &amp;#x27;&lt;/span&gt; + &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;last&lt;/span&gt;; &amp;#125;).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;set&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;v&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;first&lt;/span&gt; = v.&lt;span class=&quot;title function_&quot;&gt;substr&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, v.&lt;span class=&quot;title function_&quot;&gt;indexOf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27; &amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;last&lt;/span&gt; = v.&lt;span class=&quot;title function_&quot;&gt;substr&lt;/span&gt;(v.&lt;span class=&quot;title function_&quot;&gt;indexOf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27; &amp;#x27;&lt;/span&gt;) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;axl.&lt;span class=&quot;property&quot;&gt;fullName&lt;/span&gt; = &lt;span class=&quot;string&quot;&gt;&amp;#x27;William Rose&amp;#x27;&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;// Now `axl.name.first` is &amp;quot;William&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;再次强调，虚拟值不能用于查询和字段选择，因为虚拟值不储存于 MongoDB。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;选项&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Schema有很多可配置选项，你可以在构造时传入或者直接set，选项较多，暂不学习整理。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;..&amp;#125;, options);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// or&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; schema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;..&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;set&lt;/span&gt;(option, value);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;三、SchemaTypes-模式类型&quot;&gt;三、SchemaTypes-模式类型&lt;/h2&gt;
&lt;p&gt;以下是mongoose的所有合法SchemaTypes：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;String&lt;/li&gt;
&lt;li&gt;Boolean&lt;/li&gt;
&lt;li&gt;Number&lt;/li&gt;
&lt;li&gt;Array&lt;/li&gt;
&lt;li&gt;Buffer&lt;/li&gt;
&lt;li&gt;Date&lt;/li&gt;
&lt;li&gt;Schema.Types.ObjectId&lt;/li&gt;
&lt;li&gt;Schema.Types.Mixed&lt;/li&gt;
&lt;li&gt;Schema.Types.Decimal128&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;SchemeType选项&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;你可以直接声明schema type为某一种type，或者赋值一个含有type属性的对象&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; schema1 = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;test&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// `test` is a path of type String&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; schema2 = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;test&lt;/span&gt;: &amp;#123; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt; &amp;#125; &lt;span class=&quot;comment&quot;&gt;// `test` is a path of type string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;除了type属性，还可以对这个字段路径指定其它属性，比如在保存之前全部转换为小写&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; shema2 = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;test&lt;/span&gt;:&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;lowercase&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;全部可用&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;required:布尔值或者函数 如果值为真，为此属性添加require验证器&lt;/li&gt;
&lt;li&gt;default: 任何值或函数 设置此路径默认值，如果是函数m，函数返回值为默认值&lt;/li&gt;
&lt;li&gt;select: 布尔值 指定query的默认projections&lt;/li&gt;
&lt;li&gt;validate: 函数校验&lt;/li&gt;
&lt;li&gt;get:函数，使用Object.defineProperty()定义自定义getter&lt;/li&gt;
&lt;li&gt;set：同上&lt;/li&gt;
&lt;li&gt;alias：别名&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;索引相关&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;可以使用 schema type定义索引相关&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;index：布尔值    是否对这个属性创建索引&lt;/li&gt;
&lt;li&gt;unique:布尔值    是否对这个属性创建唯一索引&lt;/li&gt;
&lt;li&gt;sparse:布尔值    是否对这个属性创建稀疏索引&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;四、Connections-连接&quot;&gt;四、Connections-连接&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;可以使用 mongoose.connect()连接MongoDB，默认端口27017&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;操作缓存&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;就是说不必等待上面的connect连接成功后，就可以使用创建的 Mongoose models&lt;br&gt;
禁用缓存，要修改 bufferCommands配置，mongoose.set(‘bufferCommands’,fasle)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;选项&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;connect 方法也接受 options 参数，这些参数会传入底层 MongoDB 驱动。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;回调&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;connect()函数接受回调函数，或返回一个Promise&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;keepAlive&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;对于长期运行的后台应用，启用毫秒级 keepAlive 是一个精明的操作。不这么做你可能会经常 收到看似毫无原因的 “connection closed” 错误。&lt;br&gt;
mongoose.connect(uri,{keepAlive:120})&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;五、models-模型&quot;&gt;五、models-模型&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.mongoosejs.net/docs/api.html#model-js&quot;&gt;Models&lt;/a&gt; 是从 &lt;code&gt;Schema&lt;/code&gt; 编译来的构造函数。 它们的实例就代表着可以从数据库保存和读取的 &lt;a href=&quot;http://www.mongoosejs.net/docs/documents.html&quot;&gt;documents&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;从数据库创建和读取 document 的所有操作都是通过 model 进行的。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; schema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; mongoose.&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;attr&quot;&gt;size&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt; &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Tank&amp;#x27;&lt;/span&gt;, schema);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;上面的参数 Tank是跟model对应的集合(collection)对应的单数形式。&lt;br&gt;
Mongoose会自动找到名称是model的名字的复数形式。&lt;br&gt;
比如上例，Tank这个model对应数据库中tanks这个collection&lt;br&gt;
.model()这个函数是对 schema做了拷贝&lt;br&gt;
确保在调用.model()之前把所有需要的东西都加进shema里。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;构造documents&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;documents是model的实例，创建谈并保存到数据库非常简单：&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Tank&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;title class_&quot;&gt;TankSchema&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; small = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt;(&amp;#123; &lt;span class=&quot;attr&quot;&gt;size&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27; small&amp;#x27;&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;small.&lt;span class=&quot;title function_&quot;&gt;save&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;hanldeError&lt;/span&gt;(err) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// or&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;create&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;size&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;small&amp;#x27;&lt;/span&gt;&amp;#125;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,small&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;查询&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;查询文档可以用model的find、findbyId,findOne，和where这些静态方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;删除&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;model的remove方法可以删除所有匹配查询条件(condition)的文档&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;remove&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;size&lt;/span&gt;:small&amp;#125;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handler&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;更新&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;model&lt;/code&gt; 的 &lt;code&gt;update&lt;/code&gt; 方法可以修改数据库中的文档，不过不会把文档返回给应用层。&lt;/li&gt;
&lt;li&gt;如果想更新单独一条文档并且返回给应用层，可以使用 &lt;a href=&quot;http://www.mongoosejs.net/docs/api.html#model_Model.findOneAndUpdate&quot;&gt;findOneAndUpdate&lt;/a&gt; 方法。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;六、文档-Documents&quot;&gt;六、文档-Documents&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Mongoose document代表着MongoDB文档的一对一映射。每个document都是他的Model的实例。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;更新&lt;/strong&gt;&lt;br&gt;
使用findById:&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;findById&lt;/span&gt;(id,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,tank&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handlerError&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  tank.&lt;span class=&quot;property&quot;&gt;size&lt;/span&gt; = &lt;span class=&quot;string&quot;&gt;&amp;#x27;large&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//tank.set(&amp;#123;size:&amp;#x27;large&amp;#x27;&amp;#125;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  tank.&lt;span class=&quot;title function_&quot;&gt;save&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,updateTank&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handlerError&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    res.&lt;span class=&quot;title function_&quot;&gt;send&lt;/span&gt;(updateTank)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;若仅仅需要更新数据,而不需要获取数据再去更新：&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Tank.update({_id:id},{$set:{size:‘large’}},callback)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;更新后我们还需要返回这个文档：findByIdAndUpdate&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Tank&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;findByIdAndUpdate&lt;/span&gt;(id,&amp;#123;&lt;span class=&quot;attr&quot;&gt;$set&lt;/span&gt;:&amp;#123;&lt;span class=&quot;attr&quot;&gt;size&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;large&amp;#x27;&lt;/span&gt;&amp;#125;&amp;#125;,&amp;#123;&lt;span class=&quot;attr&quot;&gt;new&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&amp;#125;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,tank&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handlerError&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  res.&lt;span class=&quot;title function_&quot;&gt;send&lt;/span&gt;(tank)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;七、子文档-SubDocuments&quot;&gt;七、子文档-SubDocuments&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;子文档是指嵌套在另一个文档中的文档。&lt;br&gt;
在Mongoose中，意味着你可以在里嵌套另一个schema。&lt;br&gt;
Mongoose子文档有两种不同的概念：子文档数组和单个嵌套子文档&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; chidlSchema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; parentSchema =  &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;children&lt;/span&gt;:[childSchema],&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;child&lt;/span&gt;:childSchema&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;子文档与文档的区别是 子文档不能单独保存，他们会在他们的顶级文档保存时保存。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Parent&lt;/span&gt; = mongoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Parent&amp;#x27;&lt;/span&gt;,parentSchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; parent = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Parent&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;children&lt;/span&gt;:[&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;liu&amp;#x27;&lt;/span&gt;&amp;#125;,&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;ge&amp;#x27;&lt;/span&gt;&amp;#125;,&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;zhou;&amp;#125;]&amp;#125;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;parent.children[0].name = &amp;#x27;&lt;/span&gt;liu&lt;span class=&quot;string&quot;&gt;&amp;#x27;       &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;parent.save(callback)         &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;八、Queries-查询&quot;&gt;八、Queries 查询&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Model的多个静态辅助方法都可以查询文档&lt;/li&gt;
&lt;li&gt;Query实例有一个.then()函数，用法类似Promise&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们看一下demo，查询persons表中name中属性last为Ghost值的文档，只查询 name和occupation两个字段&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt; = mpngoose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Pseron&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;title class_&quot;&gt;PersonSchema&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;findOne&lt;/span&gt;(&amp;#123;name.&lt;span class=&quot;property&quot;&gt;last&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;Ghost&amp;#x27;&lt;/span&gt;&amp;#125;,&lt;span class=&quot;string&quot;&gt;&amp;#x27;name occupation&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,person&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;%s %s is a %s&amp;#x27;&lt;/span&gt;,person.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;fisrt&lt;/span&gt;,person.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;last&lt;/span&gt;,person.&lt;span class=&quot;property&quot;&gt;occupation&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;查询结果的格式取决于做什么操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;findOne()是单个文档&lt;/li&gt;
&lt;li&gt;find() 是文档列表&lt;/li&gt;
&lt;li&gt;count() 是文档数量&lt;/li&gt;
&lt;li&gt;update() 是更新的文档数量&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;九-中间件–Middleware&quot;&gt;九 中间件–Middleware&lt;/h2&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;中间件(pre 和 post 钩子)是在异步函数执行时函数传入的控制函数。&lt;/li&gt;
&lt;li&gt;Middleware is specified on the shema.&lt;/li&gt;
&lt;li&gt;Mongoose4.x有四种中间件：&lt;strong&gt;doucument&lt;/strong&gt;中间件、&lt;strong&gt;model&lt;/strong&gt;中间件、&lt;strong&gt;aggregate&lt;/strong&gt;中间件、&lt;strong&gt;quer&lt;/strong&gt;y中间件。&lt;/li&gt;
&lt;li&gt;document 中间件支持以下document操作：
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;init&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;validate&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;save&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;remove&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;query 中间件支持以下 Model 和 Query 操作
&lt;ol&gt;
&lt;li&gt;count&lt;/li&gt;
&lt;li&gt;find&lt;/li&gt;
&lt;li&gt;findOne&lt;/li&gt;
&lt;li&gt;findOneAndUpdate&lt;/li&gt;
&lt;li&gt;findOneAndRemove&lt;/li&gt;
&lt;li&gt;updade&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;aggregate 中间件作用于MyModel.aggregate()，他会在你对 aggregate 对象调用 exec()时执行
&lt;ol&gt;
&lt;li&gt;aggregate&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;Model中间件支持以下操作：
&lt;ol&gt;
&lt;li&gt;insertMany&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;所有中间件支持 pre 和 post 钩子。&lt;/li&gt;
&lt;li&gt;Query 没有 remove()钩子，只有 docuemnt 有，如果设定了remove钩子，他将会在你调用 myDoc.remove()触发，而不是 myModel.remove(),另外，create()函数会触发 save()钩子。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;pre&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;pre钩子分为『串行』和『并行』两种&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;串行：&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;串行中间件一个接一个的执行。具体来说，上一个中间件调用 next 的时候下一个执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; schema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(..);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;pre&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;next&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// to stuff&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在 mongoose5.x 中，除了手动调用 next 函数，还可以返回一个 Promise，甚至是 async/await。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;pre&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;doStuff&lt;/span&gt;().&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					&lt;span class=&quot;title function_&quot;&gt;then&lt;/span&gt;(&lt;span class=&quot;function&quot;&gt;()=&amp;gt;&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;doMoreStuff&lt;/span&gt;())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// or&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;shcema.&lt;span class=&quot;title function_&quot;&gt;pre&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;doStuff&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;doMoreStuff&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;并行&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;并行中间件提供细粒度流控制。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; schema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(..)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;shcema.&lt;span class=&quot;title function_&quot;&gt;pre&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;next,done&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;setTimeout&lt;/span&gt;(done,&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在这个例子中，save 方法将在所有中间件都调用了 done 方法的时候才会执行。&lt;br&gt;
使用场景:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;复杂的数据校验&lt;/li&gt;
&lt;li&gt;删除依赖文档(删除用户后删除他的所有文档)&lt;/li&gt;
&lt;li&gt;asynchronous defaults&lt;/li&gt;
&lt;li&gt;asynchronous tasks that a certain action triggers&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Post&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Post中间件在方法执行之后调用，这个时候每个 pre 中间件都已完成&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;init&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;%s has been initialized from the db&amp;#x27;&lt;/span&gt;, doc.&lt;span class=&quot;property&quot;&gt;_id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;validate&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;%s has been validated (but not saved yet)&amp;#x27;&lt;/span&gt;, doc.&lt;span class=&quot;property&quot;&gt;_id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;%s has been saved&amp;#x27;&lt;/span&gt;, doc.&lt;span class=&quot;property&quot;&gt;_id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;remove&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;%s has been removed&amp;#x27;&lt;/span&gt;, doc.&lt;span class=&quot;property&quot;&gt;_id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;异步 Post 钩子&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;如果你给 post 钩子的回调函数传入两个参数，mongoose 会认为第二个参数是 next()函数，可以通过 next 触发下一个中间件&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc,next&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;setTimeout&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;pot1&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;,&lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;doc, next&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;post2&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Save/Validate钩子&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;save()函数触发 validate()钩子，mongoose validate()钩子其实就是 pre(‘save’)钩子，这意味着所有pre(‘validate’)和 post(‘validate’)钩子都会在 pre(‘save’)之前调用。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;findAndUpdate() 和 Query 中间件使用注意&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;pre 和 post save()钩子都不执行于 update()、 findOneAndUpdate()等情况&lt;br&gt;
mongoose4.x为这些函数制定了新钩子&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;pre&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;find&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	conosle.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; mongoose.&lt;span class=&quot;property&quot;&gt;query&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;//true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;start&lt;/span&gt; = &lt;span class=&quot;title class_&quot;&gt;Date&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;now&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;find&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;result&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	conosle.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; mongoose.&lt;span class=&quot;property&quot;&gt;query&lt;/span&gt;) &lt;span class=&quot;comment&quot;&gt;//true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// prints returned documents&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;find() returned &amp;#x27;&lt;/span&gt; + &lt;span class=&quot;title class_&quot;&gt;JSON&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;stringify&lt;/span&gt;(result));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// prints number of milliseconds the query took&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;find() took &amp;#x27;&lt;/span&gt; + (&lt;span class=&quot;title class_&quot;&gt;Date&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;now&lt;/span&gt;() - &lt;span class=&quot;variable language_&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;start&lt;/span&gt;) + &lt;span class=&quot;string&quot;&gt;&amp;#x27; millis&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;错误处理中间件&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;next()&lt;/code&gt; 执行错误时，中间件执行立即停止。但是我们有特殊的 post 中间件技巧处理这个问题 —— 错误处理中渐渐，它可以在出错后执行你指定的代码。&lt;br&gt;
错误处理中间件比普通中间件多一个 &lt;code&gt;error&lt;/code&gt; 参数，并且 &lt;code&gt;err&lt;/code&gt; 作为第一个参数传入。 而后错误处理中间件可以让你自由地做错误的后续处理&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; schema = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;unique&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;schema.&lt;span class=&quot;title function_&quot;&gt;post&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;save&amp;#x27;&lt;/span&gt;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,doc,next&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (error.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt; === &lt;span class=&quot;string&quot;&gt;&amp;#x27;MongoError&amp;#x27;&lt;/span&gt; &amp;amp;&amp;amp; error.&lt;span class=&quot;property&quot;&gt;code&lt;/span&gt; === &lt;span class=&quot;number&quot;&gt;11000&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Error&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;There was a duplicate key error&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;next&lt;/span&gt;(error);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;create&lt;/span&gt;([&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;liu&amp;#x27;&lt;/span&gt;&amp;#125;,&amp;#123;&lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;Gezhou&amp;#x27;&lt;/span&gt;&amp;#125;]);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;十、填充–Populate&quot;&gt;十、填充–Populate&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;demo&lt;/strong&gt;&lt;br&gt;
MongoDb 在 3.2之后，也有像 sql 中的 join 聚合操作，那就死$lookup,而 mongoose 拥有更强大的 populate，可以让你在别的 collection 中引用 document。&lt;br&gt;
Populate 可以自动替换 document 中的指定字段，替换内容从其他 collection 获取，我们填充(populate)单个或者多个 document、单个或者多个对象，甚至是 query 返回的一切对象：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; mongoose = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;mongoose&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt; = mongoose.&lt;span class=&quot;property&quot;&gt;Schema&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; personSchema = &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;_id&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;types&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;ObjectId&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;age&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;Number&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;stories&lt;/span&gt;:[&amp;#123;&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;types&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;ObjectId&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;ref&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;Story&amp;#x27;&lt;/span&gt;&amp;#125;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; storySchema = &lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;author&lt;/span&gt;:&amp;#123;&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;types&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;ObjectId&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;ref&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;Person&amp;#x27;&lt;/span&gt;&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;title&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;String&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;fans&lt;/span&gt;:[&amp;#123;&lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;:&lt;span class=&quot;title class_&quot;&gt;Schema&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;types&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;ObjectId&lt;/span&gt;,&lt;span class=&quot;attr&quot;&gt;ref&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;Person&amp;#x27;&lt;/span&gt;&amp;#125;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Story&lt;/span&gt; = mongose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Story&amp;#x27;&lt;/span&gt;,storySchema)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt; = mongose.&lt;span class=&quot;title function_&quot;&gt;model&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Person&amp;#x27;&lt;/span&gt;,personSchema)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;我们创建了两个model，Person model中的 stories 字段为 ObjectID 数组，ref 选项告诉mongoose 在填充的时候使用哪个 model，上面的例子就是指 Story 的 model。所有储存在此的_id 都必须是 Story model 中的 document 的 _id&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;保存 refs&lt;/strong&gt;&lt;br&gt;
保存 refs 与保存普通属性一样，把_id的值赋给他就好了&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; author = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Person&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;_id&lt;/span&gt;:&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; mongoose.&lt;span class=&quot;property&quot;&gt;Types&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;objectId&lt;/span&gt;(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;liugezhou&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;age&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;18&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;author.&lt;span class=&quot;title function_&quot;&gt;save&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; story1 = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Story&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;attr&quot;&gt;title&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;my book&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;author&lt;/span&gt;:author.&lt;span class=&quot;property&quot;&gt;_id&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  story1.&lt;span class=&quot;title function_&quot;&gt;save&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;Population&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Story&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;findOne&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;title&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;my book&amp;#x27;&lt;/span&gt;&amp;#125;).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;populate&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;author&amp;#x27;&lt;/span&gt;).&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;title function_&quot;&gt;exec&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,story&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;The author is %s&amp;#x27;&lt;/span&gt;, story.&lt;span class=&quot;property&quot;&gt;author&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;设置被填充字段&lt;/strong&gt;&lt;br&gt;
mongoose4.0之后，你可以手动填写一个字段&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Story&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;findOne&lt;/span&gt;(&amp;#123;&lt;span class=&quot;attr&quot;&gt;title&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;&amp;#x27;my book&amp;#x27;&lt;/span&gt;&amp;#125;,&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;err,story&lt;/span&gt;)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (err) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;handleError&lt;/span&gt;(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  story.&lt;span class=&quot;property&quot;&gt;author&lt;/span&gt; = author&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(story.&lt;span class=&quot;property&quot;&gt;author&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;十一、鉴别器–Discriminator&quot;&gt;十一、鉴别器–Discriminator&lt;/h2&gt;
&lt;p&gt;Discriminator是一种 schema 继承机制。它允许你在相同的底层MongoDb collection上使用部分重叠的 schema 建立多个 model。&lt;/p&gt;
"><meta name="twitter:image"><title>mongoose官方文档总结 | 六个周</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.3"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + '912656f1f71687bc80e68bfc7315fc4c';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mongoose官方文档总结</h1><a id="logo" href="/.">六个周</a><p class="description">一个人只有一种命运，早日相遇，尽情拥抱。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa fa-subway"> 开往</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mongoose官方文档总结</h1><div class="post-meta">2021-03-12<span> | </span><span class="category"><a href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 17</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/mongoose%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%80%BB%E7%BB%93/#vcomment"><span class="valine-comment-count" data-xid="/mongoose%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%80%BB%E7%BB%93/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81mongoose"><span class="toc-text">一、mongoose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Schema-%E6%A8%A1%E5%BC%8F"><span class="toc-text">二、Schema-模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81SchemaTypes-%E6%A8%A1%E5%BC%8F%E7%B1%BB%E5%9E%8B"><span class="toc-text">三、SchemaTypes-模式类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Connections-%E8%BF%9E%E6%8E%A5"><span class="toc-text">四、Connections-连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81models-%E6%A8%A1%E5%9E%8B"><span class="toc-text">五、models-模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%96%87%E6%A1%A3-Documents"><span class="toc-text">六、文档-Documents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AD%90%E6%96%87%E6%A1%A3-SubDocuments"><span class="toc-text">七、子文档-SubDocuments</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81Queries-%E6%9F%A5%E8%AF%A2"><span class="toc-text">八、Queries 查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E4%B8%AD%E9%97%B4%E4%BB%B6%E2%80%93Middleware"><span class="toc-text">九 中间件–Middleware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%A1%AB%E5%85%85%E2%80%93Populate"><span class="toc-text">十、填充–Populate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E9%89%B4%E5%88%AB%E5%99%A8%E2%80%93Discriminator"><span class="toc-text">十一、鉴别器–Discriminator</span></a></li></ol></div></div><div class="post-content"><p><font color=blue>更新说明：对文章目录排版做了调整。</font><br>
<font color=blue> 更新时间：2022-05-04</font></p>
<h2 id="一、mongoose">一、mongoose</h2>
<blockquote>
<ul>
<li>安装：npm install  mongoose</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1，引入mongoose</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"><span class="comment">// 2. 连接本地数据库</span></span><br><span class="line"><span class="keyword">let</span> db = mongoose.<span class="title function_">connect</span>(<span class="string">&#x27;mongodb://localhost/test&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = mongoose.<span class="property">connection</span>;</span><br><span class="line">db.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="variable language_">console</span>.<span class="property">error</span>.<span class="title function_">bind</span>(<span class="variable language_">console</span>, <span class="string">&#x27;connection error:&#x27;</span>));</span><br><span class="line">db.<span class="title function_">once</span>(<span class="string">&#x27;open&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// we&#x27;re connected!</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mongoose里，一切始于Schema：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tomSchema = mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">name</span>:<span class="title class_">String</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//接着，把这个Schema编译成一个Model</span></span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Tom</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Tom&#x27;</span>,tomSchema)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给这个model加一个code方法</span></span><br><span class="line"><span class="title class_">Tom</span>.<span class="property">methods</span>.<span class="property">code</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">let</span> nickname = <span class="variable language_">this</span>.<span class="property">name</span> ? <span class="string">&quot;The programmar name is :&quot;</span> + <span class="variable language_">this</span>.<span class="property">name</span>:<span class="string">&#x27;I don&#x27;</span>t have name<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  console.log(nickname)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//model是我们构造document的class，每个document都是一个Tom对象</span></span><br><span class="line"><span class="string">let Tomliu = new Tom(&#123;name:&#x27;</span>liugezhou<span class="string">&#x27;&#125;)</span></span><br><span class="line"><span class="string">Tomliu.code() //The programmar name is :liugezhou</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// save</span></span><br><span class="line"><span class="string">Tomliu.save(function(err,item)&#123;</span></span><br><span class="line"><span class="string">	if (err) return console.error(err);</span></span><br><span class="line"><span class="string">   item.speak();</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 获取所有的Tom</span></span><br><span class="line"><span class="string">Tom.find(function(err,tomlius)&#123;</span></span><br><span class="line"><span class="string">	if(err) return console.error(err);</span></span><br><span class="line"><span class="string">  console.log(tomlius)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//获取特定数据</span></span><br><span class="line"><span class="string">Tom.find(&#123;name:/^liugezhou/&#125;,callback)</span></span><br></pre></td></tr></table></figure>
<h2 id="二、Schema-模式">二、Schema-模式</h2>
<blockquote>
<ul>
<li>每个Schema都会映射到MongoDB 的collection，并定义这个collection里的文档构成</li>
</ul>
</blockquote>
<p>语法：</p>
<blockquote>
<ul>
<li>const shcema = mongoose.Schema({})</li>
</ul>
</blockquote>
<p>允许使用的Schematypes有：</p>
<blockquote>
<ul>
<li>String</li>
<li>Boolean</li>
<li>Date</li>
<li>Number</li>
<li>Array</li>
<li>Buffer</li>
<li>Mixed</li>
<li>ObjectId</li>
</ul>
</blockquote>
<p>除了映射collection外，还可以定义</p>
<blockquote>
<ul>
<li>document的instance methods</li>
<li>model的static Model methods</li>
<li>复合索引</li>
<li>文档的生命周期钩子，也成为中间件</li>
</ul>
</blockquote>
<p><strong>model</strong></p>
<blockquote>
<p>我们要把一个Schema转化为一个model，要使用</p>
<ul>
<li>let model = mongoose.model(modelName,schema)  函数</li>
</ul>
</blockquote>
<p><strong>collection和document</strong></p>
<blockquote>
<ul>
<li>collection相当于关系型数据库中的表</li>
<li>document相当于一条数据，在这里有特别需要注意的一点是：</li>
<li>collection不要求文档有相同的结构，在一个collection文档中不必具有相同的fileds，对于单个field在一个collection中的不同文档中可以是不同的数据类型</li>
</ul>
</blockquote>
<p><strong>实例方法methods</strong></p>
<blockquote>
<ul>
<li>documents是model的实例,document有自带的实例方法，当然也可以自定义我们自己的方法。</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> animalSchema = mongoose.<span class="title class_">Schema</span>(&#123;<span class="attr">type</span>:<span class="title class_">String</span>,<span class="attr">name</span>:<span class="title class_">String</span>&#125;)</span><br><span class="line"></span><br><span class="line">animalSchema.<span class="property">methods</span>.<span class="property">findSameType</span> = <span class="keyword">function</span> (<span class="params">cb</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">model</span>(<span class="string">&#x27;Animal&#x27;</span>).<span class="title function_">find</span>(<span class="attr">type</span>:<span class="variable language_">this</span>.<span class="property">type</span>,cb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Animal</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Animal&#x27;</span>,animalSchema)</span><br><span class="line"><span class="keyword">const</span> dog = <span class="keyword">new</span> <span class="title class_">Animal</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;dog&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">dog.<span class="title function_">findSameType</span>(<span class="keyword">function</span>(<span class="params">err,dogs</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(dogs)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>静态方法</strong></p>
<blockquote>
<ul>
<li>静态方法与实例方法的区别是，实例方法是在每个model的实例中可以访问，而静态方法是每个model直接访问</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">animalSchema.<span class="property">statics</span>.<span class="property">findByName</span> = <span class="keyword">function</span>(<span class="params">name,cb</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">find</span>(&#123;<span class="attr">name</span>:<span class="keyword">new</span> <span class="title class_">RegExp</span>(name,<span class="string">&#x27;i&#x27;</span>)&#125;,cb)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Animal</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Animal&#x27;</span>,animalSchema)</span><br><span class="line"><span class="title class_">Animal</span>.<span class="title function_">findByName</span>(<span class="string">&#x27;fido&#x27;</span>,<span class="keyword">function</span>(<span class="params">err,animal</span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(animals)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>查询助手</strong></p>
<blockquote>
<ul>
<li>查询助手作用于query实例，方便定义自己的查询扩展</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">animalSchema.<span class="property">query</span>.<span class="property">byName</span> = <span class="keyword">function</span>(<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">find</span>(&#123; <span class="attr">name</span>: <span class="keyword">new</span> <span class="title class_">RegExp</span>(name, <span class="string">&#x27;i&#x27;</span>) &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Animal</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Animal&#x27;</span>, animalSchema);</span><br><span class="line"><span class="title class_">Animal</span>.<span class="title function_">find</span>().<span class="title function_">byName</span>(<span class="string">&#x27;fido&#x27;</span>).<span class="title function_">exec</span>(<span class="keyword">function</span>(<span class="params">err, animals</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(animals);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>索引</strong></p>
<blockquote>
<ul>
<li>Mongodb支持secondary indexes,在mongoose中，我们在Schema中定义索引，索引字段级别和shcema级别</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animalSchema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">tags</span>: &#123; <span class="attr">type</span>: [<span class="title class_">String</span>], <span class="attr">index</span>: <span class="literal">true</span> &#125; <span class="comment">// field level</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">animalSchema.<span class="title function_">index</span>(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">type</span>: -<span class="number">1</span> &#125;); <span class="comment">// schema level</span></span><br></pre></td></tr></table></figure>
<p><strong>虚拟值 Virtual</strong></p>
<blockquote>
<ul>
<li>[ ]  Virtual是document的属性，但是不会保存到MongoDB，getter可以用于格式化和组合字段数据，setter可以很方便的分解一个值到多个字段。</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a schema</span></span><br><span class="line"><span class="keyword">var</span> personSchema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: &#123;</span><br><span class="line">    <span class="attr">first</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">last</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// compile our model</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Person</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Person&#x27;</span>, personSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a document</span></span><br><span class="line"><span class="keyword">var</span> axl = <span class="keyword">new</span> <span class="title class_">Person</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: &#123; <span class="attr">first</span>: <span class="string">&#x27;Axl&#x27;</span>, <span class="attr">last</span>: <span class="string">&#x27;Rose&#x27;</span> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>如果你要log出全名，可以这么做：</li>
</ul>
</blockquote>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(axl.name.<span class="built_in">first</span> + <span class="string">&#x27; &#x27;</span> + axl.name.last); <span class="comment">// Axl Rose</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>但是每次都这么拼接实在太麻烦了， 推荐你使用<a target="_blank" rel="noopener" href="http://www.mongoosejs.net/docs/api.html#virtualtype_VirtualType-get">virtual property getter</a>， 这个方法允许你定义一个 fullName 属性，但不必保存到数据库。</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">personSchema.<span class="title function_">virtual</span>(<span class="string">&#x27;fullName&#x27;</span>).<span class="title function_">get</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">first</span> + <span class="string">&#x27; &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">last</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>现在, mongoose 可以调用 getter 函数访问 fullName 属性：</li>
</ul>
</blockquote>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(axl.fullName); <span class="comment">// Axl Rose</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>如果对 document 使用 toJSON() 或 toObject()，默认不包括虚拟值， 你需要额外向 <a target="_blank" rel="noopener" href="http://www.mongoosejs.net/docs/api.html#document_Document-toObject">toObject()</a> 或者 toJSON() 传入参数** { virtuals: true }**。</li>
</ul>
</blockquote>
<p>你也可以设定虚拟值的 setter ，下例中，当你赋值到虚拟值时，它可以自动拆分到其他属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">personSchema.<span class="title function_">virtual</span>(<span class="string">&#x27;fullName&#x27;</span>).</span><br><span class="line">  <span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">first</span> + <span class="string">&#x27; &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">last</span>; &#125;).</span><br><span class="line">  <span class="title function_">set</span>(<span class="keyword">function</span>(<span class="params">v</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">first</span> = v.<span class="title function_">substr</span>(<span class="number">0</span>, v.<span class="title function_">indexOf</span>(<span class="string">&#x27; &#x27;</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span>.<span class="property">last</span> = v.<span class="title function_">substr</span>(v.<span class="title function_">indexOf</span>(<span class="string">&#x27; &#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">axl.<span class="property">fullName</span> = <span class="string">&#x27;William Rose&#x27;</span>; <span class="comment">// Now `axl.name.first` is &quot;William&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>再次强调，虚拟值不能用于查询和字段选择，因为虚拟值不储存于 MongoDB。</li>
</ul>
</blockquote>
<p><strong>选项</strong></p>
<blockquote>
<ul>
<li>Schema有很多可配置选项，你可以在构造时传入或者直接set，选项较多，暂不学习整理。</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;..&#125;, options);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;..&#125;);</span><br><span class="line">schema.<span class="title function_">set</span>(option, value);</span><br></pre></td></tr></table></figure>
<h2 id="三、SchemaTypes-模式类型">三、SchemaTypes-模式类型</h2>
<p>以下是mongoose的所有合法SchemaTypes：</p>
<blockquote>
<ul>
<li>String</li>
<li>Boolean</li>
<li>Number</li>
<li>Array</li>
<li>Buffer</li>
<li>Date</li>
<li>Schema.Types.ObjectId</li>
<li>Schema.Types.Mixed</li>
<li>Schema.Types.Decimal128</li>
</ul>
</blockquote>
<p><strong>SchemeType选项</strong></p>
<blockquote>
<ul>
<li>你可以直接声明schema type为某一种type，或者赋值一个含有type属性的对象</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema1 = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="title class_">String</span> <span class="comment">// `test` is a path of type String</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> schema2 = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">test</span>: &#123; <span class="attr">type</span>: <span class="title class_">String</span> &#125; <span class="comment">// `test` is a path of type string</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>除了type属性，还可以对这个字段路径指定其它属性，比如在保存之前全部转换为小写</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shema2 = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">test</span>:&#123;</span><br><span class="line">  	<span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">lowercase</span>:<span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>全部可用</strong></p>
<blockquote>
<ul>
<li>required:布尔值或者函数 如果值为真，为此属性添加require验证器</li>
<li>default: 任何值或函数 设置此路径默认值，如果是函数m，函数返回值为默认值</li>
<li>select: 布尔值 指定query的默认projections</li>
<li>validate: 函数校验</li>
<li>get:函数，使用Object.defineProperty()定义自定义getter</li>
<li>set：同上</li>
<li>alias：别名</li>
</ul>
</blockquote>
<p><strong>索引相关</strong></p>
<blockquote>
<p>可以使用 schema type定义索引相关</p>
<ul>
<li>index：布尔值    是否对这个属性创建索引</li>
<li>unique:布尔值    是否对这个属性创建唯一索引</li>
<li>sparse:布尔值    是否对这个属性创建稀疏索引</li>
</ul>
</blockquote>
<h2 id="四、Connections-连接">四、Connections-连接</h2>
<blockquote>
<ul>
<li>可以使用 mongoose.connect()连接MongoDB，默认端口27017</li>
</ul>
</blockquote>
<p><strong>操作缓存</strong></p>
<blockquote>
<p>就是说不必等待上面的connect连接成功后，就可以使用创建的 Mongoose models<br>
禁用缓存，要修改 bufferCommands配置，mongoose.set(‘bufferCommands’,fasle)</p>
</blockquote>
<p><strong>选项</strong></p>
<blockquote>
<p>connect 方法也接受 options 参数，这些参数会传入底层 MongoDB 驱动。</p>
</blockquote>
<p><strong>回调</strong></p>
<blockquote>
<p>connect()函数接受回调函数，或返回一个Promise</p>
</blockquote>
<p><strong>keepAlive</strong></p>
<blockquote>
<p>对于长期运行的后台应用，启用毫秒级 keepAlive 是一个精明的操作。不这么做你可能会经常 收到看似毫无原因的 “connection closed” 错误。<br>
mongoose.connect(uri,{keepAlive:120})</p>
</blockquote>
<h2 id="五、models-模型">五、models-模型</h2>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.mongoosejs.net/docs/api.html#model-js">Models</a> 是从 <code>Schema</code> 编译来的构造函数。 它们的实例就代表着可以从数据库保存和读取的 <a target="_blank" rel="noopener" href="http://www.mongoosejs.net/docs/documents.html">documents</a>。</li>
<li>从数据库创建和读取 document 的所有操作都是通过 model 进行的。</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.<span class="title class_">Schema</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">size</span>: <span class="string">&#x27;string&#x27;</span> &#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Tank</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Tank&#x27;</span>, schema);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的参数 Tank是跟model对应的集合(collection)对应的单数形式。<br>
Mongoose会自动找到名称是model的名字的复数形式。<br>
比如上例，Tank这个model对应数据库中tanks这个collection<br>
.model()这个函数是对 schema做了拷贝<br>
确保在调用.model()之前把所有需要的东西都加进shema里。</p>
</blockquote>
<p><strong>构造documents</strong></p>
<blockquote>
<ul>
<li>documents是model的实例，创建谈并保存到数据库非常简单：</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Tank</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Tank&#x27;</span>,<span class="title class_">TankSchema</span>)</span><br><span class="line"><span class="keyword">const</span> small = <span class="keyword">new</span> <span class="title class_">Tank</span>(&#123; <span class="attr">size</span>:<span class="string">&#x27; small&#x27;</span>&#125;)</span><br><span class="line">small.<span class="title function_">save</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">hanldeError</span>(err) </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title class_">Tank</span>.<span class="title function_">create</span>(&#123;<span class="attr">size</span>:<span class="string">&#x27;small&#x27;</span>&#125;,<span class="keyword">function</span>(<span class="params">err,small</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>查询</strong></p>
<blockquote>
<ul>
<li>查询文档可以用model的find、findbyId,findOne，和where这些静态方法。</li>
</ul>
</blockquote>
<p><strong>删除</strong></p>
<blockquote>
<ul>
<li>model的remove方法可以删除所有匹配查询条件(condition)的文档</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Tank</span>.<span class="title function_">remove</span>(&#123;<span class="attr">size</span>:small&#125;,<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="title function_">handler</span>(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>更新</strong></p>
<blockquote>
<ul>
<li><code>model</code> 的 <code>update</code> 方法可以修改数据库中的文档，不过不会把文档返回给应用层。</li>
<li>如果想更新单独一条文档并且返回给应用层，可以使用 <a target="_blank" rel="noopener" href="http://www.mongoosejs.net/docs/api.html#model_Model.findOneAndUpdate">findOneAndUpdate</a> 方法。</li>
</ul>
</blockquote>
<h2 id="六、文档-Documents">六、文档-Documents</h2>
<blockquote>
<ul>
<li>Mongoose document代表着MongoDB文档的一对一映射。每个document都是他的Model的实例。</li>
</ul>
</blockquote>
<p><strong>更新</strong><br>
使用findById:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Tank</span>.<span class="title function_">findById</span>(id,<span class="keyword">function</span>(<span class="params">err,tank</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handlerError</span>(err)</span><br><span class="line">  </span><br><span class="line">  tank.<span class="property">size</span> = <span class="string">&#x27;large&#x27;</span>;</span><br><span class="line">  <span class="comment">//tank.set(&#123;size:&#x27;large&#x27;&#125;)</span></span><br><span class="line">  tank.<span class="title function_">save</span>(<span class="keyword">function</span>(<span class="params">err,updateTank</span>)&#123;</span><br><span class="line">  	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handlerError</span>(err)</span><br><span class="line">    res.<span class="title function_">send</span>(updateTank)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>若仅仅需要更新数据,而不需要获取数据再去更新：</li>
</ul>
<blockquote>
<p>Tank.update({_id:id},{$set:{size:‘large’}},callback)</p>
</blockquote>
<ul>
<li>更新后我们还需要返回这个文档：findByIdAndUpdate</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Tank</span>.<span class="title function_">findByIdAndUpdate</span>(id,&#123;<span class="attr">$set</span>:&#123;<span class="attr">size</span>:<span class="string">&#x27;large&#x27;</span>&#125;&#125;,&#123;<span class="attr">new</span>:<span class="literal">true</span>&#125;,<span class="keyword">function</span>(<span class="params">err,tank</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handlerError</span>(err)</span><br><span class="line">  res.<span class="title function_">send</span>(tank)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="七、子文档-SubDocuments">七、子文档-SubDocuments</h2>
<blockquote>
<p>子文档是指嵌套在另一个文档中的文档。<br>
在Mongoose中，意味着你可以在里嵌套另一个schema。<br>
Mongoose子文档有两种不同的概念：子文档数组和单个嵌套子文档</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chidlSchema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;<span class="attr">name</span>:<span class="title class_">String</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parentSchema =  <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">children</span>:[childSchema],</span><br><span class="line">  <span class="attr">child</span>:childSchema</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>子文档与文档的区别是 子文档不能单独保存，他们会在他们的顶级文档保存时保存。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Parent</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Parent&#x27;</span>,parentSchema)</span><br><span class="line"><span class="keyword">const</span> parent = <span class="keyword">new</span> <span class="title class_">Parent</span>(&#123;<span class="attr">children</span>:[&#123;<span class="attr">name</span>:<span class="string">&#x27;liu&#x27;</span>&#125;,&#123;<span class="attr">name</span>:<span class="string">&#x27;ge&#x27;</span>&#125;,&#123;<span class="attr">name</span>:<span class="string">&#x27;zhou;&#125;]&#125;)</span></span><br><span class="line"><span class="string">parent.children[0].name = &#x27;</span>liu<span class="string">&#x27;       </span></span><br><span class="line"><span class="string">parent.save(callback)         </span></span><br></pre></td></tr></table></figure>
<h2 id="八、Queries-查询">八、Queries 查询</h2>
<blockquote>
<ul>
<li>Model的多个静态辅助方法都可以查询文档</li>
<li>Query实例有一个.then()函数，用法类似Promise</li>
</ul>
</blockquote>
<p>我们看一下demo，查询persons表中name中属性last为Ghost值的文档，只查询 name和occupation两个字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Person</span> = mpngoose.<span class="title function_">model</span>(<span class="string">&#x27;Pseron&#x27;</span>,<span class="title class_">PersonSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="title function_">findOne</span>(&#123;name.<span class="property">last</span>:<span class="string">&#x27;Ghost&#x27;</span>&#125;,<span class="string">&#x27;name occupation&#x27;</span>,<span class="keyword">function</span>(<span class="params">err,person</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s %s is a %s&#x27;</span>,person.<span class="property">name</span>.<span class="property">fisrt</span>,person.<span class="property">name</span>.<span class="property">last</span>,person.<span class="property">occupation</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查询结果的格式取决于做什么操作：</p>
<ul>
<li>findOne()是单个文档</li>
<li>find() 是文档列表</li>
<li>count() 是文档数量</li>
<li>update() 是更新的文档数量</li>
</ul>
</blockquote>
<h2 id="九-中间件–Middleware">九 中间件–Middleware</h2>
<blockquote>
<ol>
<li>中间件(pre 和 post 钩子)是在异步函数执行时函数传入的控制函数。</li>
<li>Middleware is specified on the shema.</li>
<li>Mongoose4.x有四种中间件：<strong>doucument</strong>中间件、<strong>model</strong>中间件、<strong>aggregate</strong>中间件、<strong>quer</strong>y中间件。</li>
<li>document 中间件支持以下document操作：
<ol>
<li><strong>init</strong></li>
<li><strong>validate</strong></li>
<li><strong>save</strong></li>
<li><strong>remove</strong></li>
</ol>
</li>
<li>query 中间件支持以下 Model 和 Query 操作
<ol>
<li>count</li>
<li>find</li>
<li>findOne</li>
<li>findOneAndUpdate</li>
<li>findOneAndRemove</li>
<li>updade</li>
</ol>
</li>
<li>aggregate 中间件作用于MyModel.aggregate()，他会在你对 aggregate 对象调用 exec()时执行
<ol>
<li>aggregate</li>
</ol>
</li>
<li>Model中间件支持以下操作：
<ol>
<li>insertMany</li>
</ol>
</li>
<li>所有中间件支持 pre 和 post 钩子。</li>
<li>Query 没有 remove()钩子，只有 docuemnt 有，如果设定了remove钩子，他将会在你调用 myDoc.remove()触发，而不是 myModel.remove(),另外，create()函数会触发 save()钩子。</li>
</ol>
</blockquote>
<p><strong>pre</strong></p>
<blockquote>
<p>pre钩子分为『串行』和『并行』两种</p>
</blockquote>
<ul>
<li><strong>串行：</strong></li>
</ul>
<blockquote>
<p>串行中间件一个接一个的执行。具体来说，上一个中间件调用 next 的时候下一个执行</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schema = <span class="keyword">new</span> <span class="title class_">Schema</span>(..);</span><br><span class="line">schema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">function</span>(<span class="params">next</span>)&#123;</span><br><span class="line">	<span class="comment">// to stuff</span></span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 mongoose5.x 中，除了手动调用 next 函数，还可以返回一个 Promise，甚至是 async/await。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">schema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">doStuff</span>().</span><br><span class="line">					<span class="title function_">then</span>(<span class="function">()=&gt;</span> <span class="title function_">doMoreStuff</span>())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"></span><br><span class="line">shcema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">async</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="keyword">await</span> <span class="title function_">doStuff</span>();</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">doMoreStuff</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>并行</strong></li>
</ul>
<blockquote>
<p>并行中间件提供细粒度流控制。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schema = <span class="keyword">new</span> <span class="title class_">Schema</span>(..)</span><br><span class="line"></span><br><span class="line">shcema.<span class="title function_">pre</span>(<span class="string">&#x27;save&#x27;</span>,<span class="literal">true</span>,<span class="keyword">function</span>(<span class="params">next,done</span>)&#123;</span><br><span class="line">	<span class="title function_">next</span>()</span><br><span class="line">  <span class="built_in">setTimeout</span>(done,<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在这个例子中，save 方法将在所有中间件都调用了 done 方法的时候才会执行。<br>
使用场景:</p>
<ul>
<li>复杂的数据校验</li>
<li>删除依赖文档(删除用户后删除他的所有文档)</li>
<li>asynchronous defaults</li>
<li>asynchronous tasks that a certain action triggers</li>
</ul>
</blockquote>
<p><strong>Post</strong></p>
<blockquote>
<p>Post中间件在方法执行之后调用，这个时候每个 pre 中间件都已完成</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;init&#x27;</span>,<span class="keyword">function</span>(<span class="params">doc</span>)&#123;</span><br><span class="line">	 <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s has been initialized from the db&#x27;</span>, doc.<span class="property">_id</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;validate&#x27;</span>,<span class="keyword">function</span>(<span class="params">doc</span>)&#123;</span><br><span class="line">	 <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s has been validated (but not saved yet)&#x27;</span>, doc.<span class="property">_id</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">function</span>(<span class="params">doc</span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s has been saved&#x27;</span>, doc.<span class="property">_id</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;remove&#x27;</span>,<span class="keyword">function</span>(<span class="params">doc</span>)&#123;</span><br><span class="line">	 <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s has been removed&#x27;</span>, doc.<span class="property">_id</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>异步 Post 钩子</strong></li>
</ul>
<blockquote>
<p>如果你给 post 钩子的回调函数传入两个参数，mongoose 会认为第二个参数是 next()函数，可以通过 next 触发下一个中间件</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">function</span>(<span class="params">doc,next</span>)&#123;</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pot1&#x27;</span>)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125;,<span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>, <span class="keyword">function</span>(<span class="params">doc, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;post2&#x27;</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Save/Validate钩子</strong></li>
</ul>
<blockquote>
<p>save()函数触发 validate()钩子，mongoose validate()钩子其实就是 pre(‘save’)钩子，这意味着所有pre(‘validate’)和 post(‘validate’)钩子都会在 pre(‘save’)之前调用。</p>
</blockquote>
<ul>
<li><strong>findAndUpdate() 和 Query 中间件使用注意</strong></li>
</ul>
<blockquote>
<p>pre 和 post save()钩子都不执行于 update()、 findOneAndUpdate()等情况<br>
mongoose4.x为这些函数制定了新钩子</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">schema.<span class="title function_">pre</span>(<span class="string">&#x27;find&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	conosle.<span class="title function_">log</span>(<span class="variable language_">this</span> <span class="keyword">instanceof</span> mongoose.<span class="property">query</span>) <span class="comment">//true</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">start</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;find&#x27;</span>,<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">	conosle.<span class="title function_">log</span>(<span class="variable language_">this</span> <span class="keyword">instanceof</span> mongoose.<span class="property">query</span>) <span class="comment">//true</span></span><br><span class="line">  <span class="comment">// prints returned documents</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find() returned &#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result));</span><br><span class="line">  <span class="comment">// prints number of milliseconds the query took</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find() took &#x27;</span> + (<span class="title class_">Date</span>.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">start</span>) + <span class="string">&#x27; millis&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>错误处理中间件</strong></p>
<blockquote>
<p><code>next()</code> 执行错误时，中间件执行立即停止。但是我们有特殊的 post 中间件技巧处理这个问题 —— 错误处理中渐渐，它可以在出错后执行你指定的代码。<br>
错误处理中间件比普通中间件多一个 <code>error</code> 参数，并且 <code>err</code> 作为第一个参数传入。 而后错误处理中间件可以让你自由地做错误的后续处理</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">name</span>:&#123;</span><br><span class="line">  	<span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">unique</span>:<span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">schema.<span class="title function_">post</span>(<span class="string">&#x27;save&#x27;</span>,<span class="keyword">function</span>(<span class="params">err,doc,next</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span> (error.<span class="property">name</span> === <span class="string">&#x27;MongoError&#x27;</span> &amp;&amp; error.<span class="property">code</span> === <span class="number">11000</span>) &#123;</span><br><span class="line">    <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;There was a duplicate key error&#x27;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">next</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="title function_">create</span>([&#123;<span class="attr">name</span>:<span class="string">&#x27;liu&#x27;</span>&#125;,&#123;<span class="attr">name</span>:<span class="string">&#x27;Gezhou&#x27;</span>&#125;]);</span><br></pre></td></tr></table></figure>
<h2 id="十、填充–Populate">十、填充–Populate</h2>
<p><strong>demo</strong><br>
MongoDb 在 3.2之后，也有像 sql 中的 join 聚合操作，那就死$lookup,而 mongoose 拥有更强大的 populate，可以让你在别的 collection 中引用 document。<br>
Populate 可以自动替换 document 中的指定字段，替换内容从其他 collection 获取，我们填充(populate)单个或者多个 document、单个或者多个对象，甚至是 query 返回的一切对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Schema</span> = mongoose.<span class="property">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> personSchema = <span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">_id</span>:<span class="title class_">Schema</span>.<span class="property">types</span>.<span class="property">ObjectId</span>,</span><br><span class="line">  <span class="attr">name</span>:<span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="title class_">Number</span>,</span><br><span class="line">  <span class="attr">stories</span>:[&#123;<span class="attr">type</span>:<span class="title class_">Schema</span>.<span class="property">types</span>.<span class="property">ObjectId</span>,<span class="attr">ref</span>:<span class="string">&#x27;Story&#x27;</span>&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> storySchema = <span class="title class_">Schema</span>(&#123;</span><br><span class="line">	<span class="attr">author</span>:&#123;<span class="attr">type</span>:<span class="title class_">Schema</span>.<span class="property">types</span>.<span class="property">ObjectId</span>,<span class="attr">ref</span>:<span class="string">&#x27;Person&#x27;</span>&#125;,</span><br><span class="line">  <span class="attr">title</span>:<span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">fans</span>:[&#123;<span class="attr">type</span>:<span class="title class_">Schema</span>.<span class="property">types</span>.<span class="property">ObjectId</span>,<span class="attr">ref</span>:<span class="string">&#x27;Person&#x27;</span>&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Story</span> = mongose.<span class="title function_">model</span>(<span class="string">&#x27;Story&#x27;</span>,storySchema)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Person</span> = mongose.<span class="title function_">model</span>(<span class="string">&#x27;Person&#x27;</span>,personSchema)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们创建了两个model，Person model中的 stories 字段为 ObjectID 数组，ref 选项告诉mongoose 在填充的时候使用哪个 model，上面的例子就是指 Story 的 model。所有储存在此的_id 都必须是 Story model 中的 document 的 _id</p>
</blockquote>
<p><strong>保存 refs</strong><br>
保存 refs 与保存普通属性一样，把_id的值赋给他就好了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> author = <span class="keyword">new</span> <span class="title class_">Person</span>(&#123;</span><br><span class="line">	<span class="attr">_id</span>:<span class="keyword">new</span> mongoose.<span class="property">Types</span>.<span class="title function_">objectId</span>(),</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&#x27;liugezhou&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">18</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">author.<span class="title function_">save</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">  <span class="keyword">const</span> story1 = <span class="keyword">new</span> <span class="title class_">Story</span>(&#123;</span><br><span class="line">  	<span class="attr">title</span>:<span class="string">&#x27;my book&#x27;</span>,</span><br><span class="line">    <span class="attr">author</span>:author.<span class="property">_id</span></span><br><span class="line">  &#125;)</span><br><span class="line">  story1.<span class="title function_">save</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">  	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>Population</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Story</span>.</span><br><span class="line">	<span class="title function_">findOne</span>(&#123;<span class="attr">title</span>:<span class="string">&#x27;my book&#x27;</span>&#125;).</span><br><span class="line">	<span class="title function_">populate</span>(<span class="string">&#x27;author&#x27;</span>).</span><br><span class="line">	<span class="title function_">exec</span>(<span class="keyword">function</span>(<span class="params">err,story</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">  	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;The author is %s&#x27;</span>, story.<span class="property">author</span>.<span class="property">name</span>);</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>设置被填充字段</strong><br>
mongoose4.0之后，你可以手动填写一个字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Story</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">title</span>:<span class="string">&#x27;my book&#x27;</span>&#125;,<span class="keyword">function</span>(<span class="params">err,story</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">  </span><br><span class="line">  story.<span class="property">author</span> = author</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(story.<span class="property">author</span>.<span class="property">name</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="十一、鉴别器–Discriminator">十一、鉴别器–Discriminator</h2>
<p>Discriminator是一种 schema 继承机制。它允许你在相同的底层MongoDb collection上使用部分重叠的 schema 建立多个 model。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.3" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.3"><p><span>本文标题：</span>mongoose官方文档总结</p><p><span>文章作者：</span>六个周</p><p><span>发布时间：</span>2021-03-12</p><p><span>最后更新：</span>2022-05-04</p><p><span>原始链接：</span><a href="/mongoose官方文档总结/">https://blog.liugezhou.online/mongoose%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%80%BB%E7%BB%93/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://blog.liugezhou.online/mongoose%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%80%BB%E7%BB%93/"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/Week15-%E6%9C%8D%E5%8A%A1%E7%AB%AF%20CI_CD%EF%BC%9AGithub%20%E8%87%AA%E5%8A%A8%E5%8C%96/">Week15-服务端 CI_CD：Github 自动化</a><a class="next" href="/Week14-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%80%89%E5%9E%8B%EF%BC%9A%E7%A3%A8%E5%88%80%E4%B8%8D%E5%A6%82%E7%A0%8D%E6%9F%B4%E5%8A%9F/">Week14-服务端选型：磨刀不如砍柴功</a></div><div id="vcomment"></div><script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'Ci6gl5SnXOdXxv9BTlQx3T2F-gzGzoHsz',
  appKey:'bWsfs1hg9qURRp3gJ6SJU41x',
  placeholder:'ヾﾉ≧∀≦)o来啊，快活啊!',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 文章分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%84%9A%E6%89%8B%E6%9E%B6/">Web架构之脚手架</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%B0%8F%E6%8A%80/">前端小技</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">博客搭建</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E5%91%A8%E5%B0%8F%E7%BB%93/">每周小结</a><span class="category-list-count">59</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">浏览器工作原理</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 其它主页</i></div><ul></ul><a href="https://github.com/liugezhou" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://twitter.com/liugezhou" title="Twitter" target="_blank">Twitter</a><ul></ul><a href="https://chat.liugezhou.online" title="自定义GPT" target="_blank">自定义GPT</a><ul></ul><a href="https://day.liugezhou.online" title="今日前端" target="_blank">今日前端</a><ul></ul><a href="https://run.liugezhou.online" title="Running" target="_blank">Running</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">六个周.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"></a><a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.3" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.3" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.3"><script type="text/javascript" src="/js/search.js?v=1.0.3"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/love.js?v=1.0.3"></script><script type="text/javascript" src="/js/copycode.js?v=1.0.3" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.3"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.3"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.3"></script></div></body></html>