<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="六个周的博客"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="六个周"><meta name="twitter:creator" content="@liugezhou"><meta name="twitter:title" content="Week2-脚手架架构设计和框架搭建"><meta name="twitter:description" content="&lt;p&gt;&lt;font color=blue&gt;更新说明：对文章目录排版做了调整。&lt;/font&gt;&lt;br&gt;
&lt;font color=blue&gt; 更新时间：2022-05-04&lt;/font&gt;&lt;/p&gt;
&lt;h2 id=&quot;第一章-本周介绍&quot;&gt;第一章 本周介绍&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;1-1 确立本周目标&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;脚手架的实现原理、调试原理&lt;/li&gt;
&lt;li&gt;Lerna的常见用法、源码分析&lt;/li&gt;
&lt;li&gt;架构设计技巧和架构图绘制方法&lt;/li&gt;
&lt;li&gt;Node的module模块分析&lt;/li&gt;
&lt;li&gt;yargs使用方法&lt;/li&gt;
&lt;li&gt;剖析Lerna架构设计&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;1-2 前端研发脚手架imooc-cli核心功能演示&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;安装imooc-cli脚手架： &lt;em&gt;&lt;strong&gt;npm i -g  @imooc-cli/core&lt;/strong&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;查看脚手架相关内容： &lt;em&gt;** **&lt;strong&gt;imooc-cli&lt;/strong&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;通过脚手架新建项目:   &lt;em&gt;** imooc-cli init**&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;项目发布到测试环境：  &lt;em&gt;&lt;strong&gt;imooc-cli publish&lt;/strong&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;项目发布到正式环境:    &lt;em&gt;&lt;strong&gt;imooc-cli publish --prod&lt;/strong&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;1-3 脚手架在课程中的定位&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;本项目中基础项目均由脚手架管理&lt;/li&gt;
&lt;li&gt;技术简历突出&lt;/li&gt;
&lt;li&gt;提高技能&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;第二章-脚手架开发入门&quot;&gt;第二章 脚手架开发入门&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;2-1 本章知识脉络和难点解析&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;分析开发脚手架的必要性&lt;/li&gt;
&lt;li&gt;从使用角度去理解什么是脚手架&lt;/li&gt;
&lt;li&gt;脚手架的实现原理(与操作系统关联)&lt;/li&gt;
&lt;li&gt;脚手架的开发流程&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-2 站在前端研发的视角，分析开发脚手架的必要性&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;开发imooc-cli脚手架的核心目标：提升前端研发效能【提炼通用代码、通用流程、构建发布上线】&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-1.3vft5c4ms5m0.webp&quot; alt=&quot;2-1&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;脚手架核心价值：&lt;em&gt;**自动化、标准化、数据化    **&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;和自动化构建工具(jenkins、travia)区别：自动化构建工具在服务端执行，无法覆盖本地操作且定制自动化的构建工具需要用到Java等后端语言，对前端不友好。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2-3 从使用角度理解什么是脚手架？&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;脚手架简介：脚手架的本质是一个操作系统的客户端，通过命令行执行。&lt;/li&gt;
&lt;li&gt;脚手架执行原理：&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-2.5sd3oxy068s0.webp&quot; alt=&quot;2-2&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;从应用角度看vue-cli开发脚手架过程：&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;首先是个npm项目，项目中有一个bin/vue.js的文件，且这个项目发布到了npm上&lt;/li&gt;
&lt;li&gt;将npm项目安装到了lib/node_modules&lt;/li&gt;
&lt;li&gt;在node的bin目录下配置软链接到lib/node_modules/@vue/cli/bin/vue.js&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;脚手架执行原理解析：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在终端输入：vue create vue-test-app&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;终端解析vue命令【通过_which vue查找vue_】&lt;/li&gt;
&lt;li&gt;根据vue命令链接到实际的vue.js文件&lt;/li&gt;
&lt;li&gt;终端使用node执行vue.js文件&lt;/li&gt;
&lt;li&gt;vue.js文件解析command/options&lt;/li&gt;
&lt;li&gt;vue.js文件执行command&lt;/li&gt;
&lt;li&gt;执行完毕，退出执行&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-4 脚手架原理讲解(上)&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;问题一：为什么全局安装@vue/cli后,我们执行的命令为 vue呢？&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;答：这是因为通过which vue后我们会看到vue所在目录，而这个vue是一个软链接，指向的是@vue/cli。确定这个vue命令名称的是在&lt;code&gt;node/v12.16.1/lib/node_modules/@vue/cli&lt;/code&gt;目录下package.json中的bin的键值。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;问题二：全局安装@vue/cli时发生了什么？&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;答：执行 npm install -g @vue/cli的时候，首先node会把我们当前包下载到node下的node_modules中去。下载完成后，会在下载好的包中查找package.json中是否有bin，如果有，会通过package.json中的bin中的键去配置软链接。&lt;/p&gt;
&lt;p&gt;上面两个问题其实问题二在前，问题一在后，两个问题说的是一个流程的双向解释，理解了问题二，问题一就清楚了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;问题三：执行vue命令时发生了什么？为什么vue指向一个js文件，我们却可以通过vue命令执行它？&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;答：首先执行vue命令，与执行which vue打印出来的地址  效果是等价的(即执行的是which vue的那个软连接:/Users/liumingzhou/.nvm/versions/node/v12.16.1/bin/vue)。&lt;br&gt;
而软连接又指向它的实际文件存在路径(…/lib/node_modules/@vue/cli/bin/vue.js)。&lt;/p&gt;
&lt;p&gt;我们知道，一个test.js文件可以通过node执行，但不能单独执行，这是因为它没有可执行权限。&lt;br&gt;
我们在/Users/liumingzhou/Desktop目录下新建一个test.js文件，我们可以给这个js文件一个执行权限：chmod 777 test.js  然后在命令行直接输入 ./test.js仍然不可以执行。这是因为js文件需要一个解释器来进行执行，这个node就是一个解释器。(.py文件需要 python解释器执行，.java文件需要java解释器进行执行)。&lt;/p&gt;
&lt;p&gt;那么我们上面的vue.js文件是怎么执行的呢？&lt;br&gt;
通过查看vue.js文件源码，我们发现第一行代码是这样的：#!/usr/bin/env node&lt;br&gt;
这行代码的意思是：告诉我们的操作系统，直接调用这个文件的时候，到环境变量中查找node命令执行。&lt;br&gt;
(/usr/bin/env 是我们的环境变量)&lt;/p&gt;
&lt;p&gt;然后，我们在我们的test.js文件中第一行加入这行代码  #!/usr/bin/env node&lt;br&gt;
直接输入 ./test.js 即可执行这个js文件。&lt;/p&gt;
&lt;p&gt;接着，我们不想用 ./test.js这样的方式执行js文件，我们想通过一个命令，比如 liugezhou 这个命令来执行这个test.js文件，我们需要怎么做呢？&lt;br&gt;
第一种方式，我们去找环境变量，通过 echo $PATH&lt;/p&gt;
&lt;p&gt;首先，我们创建一个环境变量：&lt;br&gt;
cd  /Users/liumingzhou/.nvm/versions/node/v12.16.1/bin&lt;br&gt;
创建软连接：ln -s  /Users/liumingzhou/Desktop/test.js  liugezhou&lt;br&gt;
创建完毕后，就可以看到一个liugezhou软连接，我们在任何目录执行liugezhou就可以执行test.js文件了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-5 脚手架原理讲解（下）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;问题一：为什么说脚手架本质是操作系统的客户端？它和我们在PC上安装的应用/软件有什么区别&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;脚手架执行起来的本质是靠node这个命令，node是一个操作系统客户端，而test.js 这个文件仅仅是作为一个参数注入到node命令中。node本质上是一个可执行文件(在window操作系统中可以看到node的扩展名为.exe的)。&lt;br&gt;
本质来说没有区别。区别仅仅是安装的应用软件会提供一个GUI,而node并没有提供GUI&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;问题二：如何为node脚手架命令创建别名&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;方法一：即为上文提到的创建一个软连接。&lt;br&gt;
接着，我们希望继续为上文提到的  liugezhou 软连接继续添加一个别名，我们需要这么做&lt;br&gt;
在上文的bin目录下，执行命令  ln -s ./liugezhou liugezhou2&lt;br&gt;
即 软连接可以嵌套。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;问题三：描述脚手架命令执行的全过程&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-3.79oyc1dprz80.webp&quot; alt=&quot;2-3&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2-6 脚手架开发流程和难点解析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;通过以上分析，我们大致了解一个脚手架的开发流程如下：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;创建一个npm项目&lt;/li&gt;
&lt;li&gt;创建脚手架的入口文件，且入口文件需要添加代码：#!/usr/bin/env node&lt;/li&gt;
&lt;li&gt;配置package.json文件，添加bin属性(指定脚手架命令与地址)&lt;/li&gt;
&lt;li&gt;编写脚手架代码&lt;/li&gt;
&lt;li&gt;将脚手架发布到npm&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;使用流程&lt;/strong&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;安装脚手架： npm install - g your-own-cli&lt;/li&gt;
&lt;li&gt;使用脚手架： your-own-cli&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;脚手架开发难点&lt;/strong&gt;：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;脚手架开发过程中通常需要将复杂的系统拆分为多个模块_&lt;strong&gt;(分包)&lt;/strong&gt;_&lt;/li&gt;
&lt;li&gt;脚手架开发过程中需要注册一系列的命令。如何对命令进行注册是一个重要的环节&lt;/li&gt;
&lt;li&gt;需要对参数进行解析:     [vue command [options] &lt;params&gt;]&lt;/li&gt;
&lt;li&gt;帮助文档：global[主命令]&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;…………&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;命令行交互、日志打印、命令行文字变色、网络通信 HTTP/WebSocket、文件处理等。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-7 快速入门第一个脚手架&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过上节流程，我们本节快速开发一个liugezhou-test脚手架并发布，流程如下:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;cd /Users/liumingzhou/Desktop&lt;/li&gt;
&lt;li&gt;mkdir liugezhou-test&lt;/li&gt;
&lt;li&gt;cd liugezhou-test&lt;/li&gt;
&lt;li&gt;npm init -y&lt;/li&gt;
&lt;li&gt;终端打开liugezhou-test项目：新建lib目录，lib目录下新建index.js文件（index.js文件内容如下）&lt;/li&gt;
&lt;li&gt;修改package.json文件，添加 “bin”:{“liugezhou-test”:“lib/index.js”}&lt;/li&gt;
&lt;li&gt;npm publish 发布npm包&lt;/li&gt;
&lt;li&gt;下载安装：npm i -g liugezhou-test&lt;/li&gt;
&lt;li&gt;测试：liugezhou-test&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/usr/bin/env node&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;console&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;welcome liugezhou-test&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里注意一点，在npm publish的时候，如果是在Descktop目录下执行的，那么我们下载liugezhou-test包之后，会看到软链指向的是本地，这是因为npm为了我们本地调试：如果/Desktop目录下有这个包，会指向本地。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2-8 脚手架本地调试方法&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;方式一：如上文所说，直接在Desktop目录下执行：npm install -g liugezhou-test,即调试本地包。&lt;br&gt;
(移除本地安装的包：&lt;em&gt;&lt;strong&gt;npm remove -g liugezhou-test&lt;/strong&gt;&lt;/em&gt;)&lt;/p&gt;
&lt;p&gt;方式二：直接在liugezhou-test文件目录下，执行：&lt;strong&gt;&lt;em&gt;npm link&lt;/em&gt;&lt;/strong&gt;,软链指向的node_modules源文件指向本地包。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;分包情况下，如何调试本地包？&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;如果/Desktop/liugezhou-test要使用/Desktop/lilugezhou-test/lib包下的方法，如何做呢？&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在/Desktop/liugezhou-test/lib目录下，npm link&lt;/li&gt;
&lt;li&gt;在/Desktop/liugezhou-test/目录下，npm link liugezhou-test-lib&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-9 脚手架本地调试标准流程总结&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;链接本地脚手架&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;cd your-cli-dir&lt;/li&gt;
&lt;li&gt;npm link&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;链接本地库文件&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;cd your-lib-dir&lt;/li&gt;
&lt;li&gt;npm link&lt;/li&gt;
&lt;li&gt;cd your-cli-dir&lt;/li&gt;
&lt;li&gt;npm link your-lib-dir&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;取消链接本地库文件&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;cd your-lib-dir&lt;/li&gt;
&lt;li&gt;npm unlink&lt;/li&gt;
&lt;li&gt;cd your-cli-dir&lt;/li&gt;
&lt;li&gt;npm unlink your-lib-dir  #link存在&lt;/li&gt;
&lt;li&gt;rm -rf node_modules     # link不存在&lt;/li&gt;
&lt;li&gt;npm i -S your-lib-dir&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;理解 npm  link&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;npm link : 将当前项目链接到node全局node_modules中作为一个库文件，并解析bin配置创建可执行文件。&lt;/li&gt;
&lt;li&gt;npm link your-libr:将当前项目中node_modules下指定的库文件链接到node全局node_modules下的库文件&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;理解 npm unlink&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;npm unlink:将当前项目从node全局node_modules中移除&lt;/li&gt;
&lt;li&gt;npm unlink your-lib:将当前项目中的库文件依赖删除。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-10 脚手架命令注册和参数解析&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;process是node的内置库&lt;br&gt;
我们在index.js中写代码： console.log(require(‘process’))&lt;/p&gt;
&lt;p&gt;通过命令行执行 liugezhou-test init&lt;br&gt;
会看到process有许许多多个属性，其中有一个argv属性。&lt;br&gt;
通过分析这个argv属性，我们就看到了init这个属性。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;因此我们可以通过argv来判断是否输入了  init 这个命令。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;2-11 脚手架项目发布&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;老生常谈，npm publish&lt;br&gt;
通过判断argv输入的参数，在liugezhou-test-lib中与liugezhou-test中加入相关逻辑&lt;br&gt;
实现 liugezhou-test init 与 liugezhou -V的输出显示&lt;br&gt;
然后分别发布，remove掉本地链接。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;第三章-脚手架框架搭建&quot;&gt;第三章 脚手架框架搭建&lt;/h2&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;3-1 &lt;strong&gt;本章的收获是什么，难点是什么？&lt;/strong&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本节课程非常下饭：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;收获一：Lerna简介 [Lerna管理的项目有:babel、create-reat-app、vue-cli]&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code&gt; 通过学习lerna将学会如何管理一个复杂的Javascript项目
&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;收获二：Lerna源码分析：讲解源码结构、执行流程、源码精读&lt;/li&gt;
&lt;li&gt;收获三：基于lerna设计简历。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;3-2 原生脚手架开发痛点分析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;lerna设计源于其要解决的问题，首先我们要分析写原生脚手架开发的痛点：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;痛点一：重复操作&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;多Package本地link&lt;/li&gt;
&lt;li&gt;多Package依赖安装&lt;/li&gt;
&lt;li&gt;多Package单元测试&lt;/li&gt;
&lt;li&gt;多Package代码提交&lt;/li&gt;
&lt;li&gt;多Package代码发布&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;版本一致性&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;发布时版本一致性&lt;/li&gt;
&lt;li&gt;发布后相互依赖版本升级&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;3-3 本章重点：lerna简介及脚手架开发流程&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Lerna简介&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Lerna : &lt;strong&gt;A tool for managing JavaScript projects with multiple packages.&lt;/strong&gt;&lt;br&gt;
用于管理具有多个程序包的JavaScript项目的工具。&lt;/p&gt;
&lt;p&gt;Lerna : &lt;strong&gt;Lerna is a tool that optimizes the workflow around managing multi-package repositories with git and npm.&lt;/strong&gt;&lt;br&gt;
Lerna是一个基于 &lt;strong&gt;git+npm &lt;strong&gt;的优化工作流的&lt;/strong&gt;多package&lt;/strong&gt;项目的管理工具。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;优势&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;大幅减少重复操作&lt;/li&gt;
&lt;li&gt;提升操作的标准化&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;Lerna 是架构优化的产物，它揭示了一个架构真理：项目复杂度提升后，就需要对项目进行架构优化。架构优化的主要目标往往都是以效能为核心。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;lerna官网：&lt;a href=&quot;https://lerna.js.org/&quot;&gt;https://lerna.js.org/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Lerna开发脚手架流程 ⭐️⭐️⭐️&lt;/strong&gt;&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-4.1fovy6rqci3k.webp&quot; alt=&quot;2-4&quot;&gt;&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-5.ry7x197y6ow.webp&quot; alt=&quot;2-5&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3-4 基于lerna搭建脚手架框架&lt;/strong&gt;&lt;br&gt;
&lt;strong&gt;本节使用命令依次如下&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;mkdir  liugezhou-cli-dev&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;cd liugezhou-cli-dev&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;npm init -y&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;npm i -g lerna【全局安装】&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;npm i -S lerna&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna init&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna create core&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna create utils&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;3-5 Lerna核心操作&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本节使用命令依次如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;lerna add liugezhou-test  (在packages目录下所有包中安装liugezhou-test包)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna add liugezhou-test packages/core  （在指定包core中添加依赖）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna clean (清除packages目录下的依赖)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna bootstrap (将刚清除的所有依赖，重新安装)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna link (开发的版本互相存在依赖，可用此命令完成)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;lerna exec – &lt;commands&gt; […args]&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;lerna exec – rm -rf  node_modules   删除packages目录下的所有node_modules文件夹&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;lerna exec --scope @liugezhou-cli/utils–rm -rf node_modules 删除packages目录下utils的。。。。&lt;br&gt;
【上下文为packages目录】&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;lerna run test&lt;/li&gt;
&lt;li&gt;lerna run --scope @liugezhou-cli/core test  [执行core包package.json中script标签的test属性]&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;3-6 Lerna发布流程(lerna使用总结)&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna init &lt;/code&gt;&lt;br&gt;
会自动完成 git 初始化，但不会创建 .gitignore，这个必须要手动添加，否则会将 node_modules 目录都上传到 git&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna add:&lt;/code&gt;&lt;br&gt;
第一个参数：添加npm包名&lt;br&gt;
第二个参数：本地package的路径（如果不加，则全部安装）&lt;br&gt;
可选参数：–dev：将依赖安装到devDependencies,不加时安装到dependencies&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna link&lt;/code&gt;&lt;br&gt;
如果未发布上线，需要手动添加到package.json中再执行。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna clean&lt;/code&gt;&lt;br&gt;
只会删除 node_modules,不会删除package.json中的依赖&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna exec 和 lerna run&lt;/code&gt;&lt;br&gt;
–scope属性后添加的是包名，不是package的路径，这点和 lerna add 不同&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lerna publish&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;发布时会自动执行 git add package-lock.json,所以该文件不能加入到.gitignore中去。&lt;/li&gt;
&lt;li&gt;发布时先创建远程仓库，且push代码。&lt;/li&gt;
&lt;li&gt;执行npm publish前完成 npm login&lt;/li&gt;
&lt;li&gt;如果发布的包名为 @xxxx/yyy 的格式，需要现在npmjs.org上注册organization&lt;/li&gt;
&lt;li&gt;发布到npm group时默认为private，package.json中需手动添加配置：&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;quot;publishConfig&amp;quot;: &amp;#123;  &amp;quot;access&amp;quot;: &amp;quot;public&amp;quot;&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;第四章-Lerna源码解析&quot;&gt;第四章 Lerna源码解析&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;4-1 赚回学费：武装简历、升职加薪&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;为什么要做源码解析：赚回学费、走上人生巅峰&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;自我成长、提升编码能力和技术深度的需要&lt;/li&gt;
&lt;li&gt;为我所用，应用到实际开发，实际产生效益&lt;/li&gt;
&lt;li&gt;学习借鉴，站在巨人的肩膀上，登高望远&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;为什么要分析Lerna源码&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;2W+ star的明星项目&lt;/li&gt;
&lt;li&gt;Lerna是脚手架，对我们开发脚手架有借鉴意义&lt;/li&gt;
&lt;li&gt;Lerna项目中蕴含大量的最佳实践，值得深入研究和学习&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;学习目标&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Lerna源码结构和执行流程分析&lt;/li&gt;
&lt;li&gt;import-local源码深度精读&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;学习收获&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;如何将源码分析写进简历&lt;/li&gt;
&lt;li&gt;学习明星项目的架构设计&lt;/li&gt;
&lt;li&gt;获得脚手架执行流程的一种实现思路&lt;/li&gt;
&lt;li&gt;获得脚手架调试本地源码的另一种方式&lt;/li&gt;
&lt;li&gt;Node.js加载node_modules模块的流程 ✨✨✨✨✨&lt;/li&gt;
&lt;li&gt;各种文件操作算法和最佳实践&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-2 lerna源码结构分析和调试技巧&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;github下载lerna源码到本地且安装依赖！&lt;/li&gt;
&lt;li&gt;使用webstorm打开源码，找到入口文件–package.json中的bin属性。&lt;/li&gt;
&lt;li&gt;webstorm添加调试：Edit Configurations，这里需要在Configuration中添加&lt;code&gt;node parameters&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;这里遇到一个问题，代码调试的时候，Variables窗口内没内容。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-3 Node源码调试过程中必会的小技巧&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;WebStorm -&amp;gt; Preferences… -&amp;gt; 搜索 Node.js and NPM -&amp;gt; 勾选 Coding assistance for Node.js&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个目的是：对当前项目中的一些默认库或内置库做一些高亮,使得node提供的一些库文件可以进行跳转。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;搜索 Debugger -&amp;gt; Stepping -&amp;gt; 默认勾选的都取消掉&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;这个目的是在调试的时候，取消勾选就可以进去一些库文件查看源码&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-4 lerna初始化过程源码详细分析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过前面分析，我们知道，入口文件为：lerna/core/lerna/cli.js文件，从这里开始看源码：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;require(“.”)(&lt;strong&gt;process&lt;/strong&gt;.argv.slice(2));&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;require(‘.’):这里的 &lt;code&gt;.&lt;/code&gt; 是相对路径,相当于是 require('./index.js)&lt;/li&gt;
&lt;li&gt;到这行代码后，先加载与该cli.js同级别目录下的index.js文件。&lt;/li&gt;
&lt;li&gt;等文件加载完毕后，将&lt;strong&gt;process&lt;/strong&gt;.argv.slice(2)参数， 也就是我们写入的参数，传入到 index.js文件中module.exports出来的方法 main&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-5 【高能知识点】npm项目本地依赖引用方法&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;本地依赖的最佳实践&lt;/strong&gt;：引用本地包的方式可以使用 file的方式，这是因为lerna publish的时候可以在线上环境把fiel的方式改成引用线上包的方式。大概是个这么个意思。这种方式可以去除之前使用 npm link的方式。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;理解了这里本地依赖的file引用后，回到之前的3-6 lerna-publish发布流程项目，将本地引用的@cloudscope-cli/utils改为file引用，这里需要注意：在@cloudscope-cli/core中使用file方式引用了本地的utils包后，需要npm install一下。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-6 脚手架框架yargs快速入门&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先在npmjs官网搜索yargs，看一下基本使用情况,然后开始我们的学习：&lt;br&gt;
在某目录下，新建一个空的项目，具体操作如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;mkdir liugezhou-test&lt;br&gt;
npm init -y&lt;br&gt;
新建lib/index.js&lt;br&gt;
package.json文件添加 “bin”:“lib/index.js”&lt;br&gt;
npm install -S yarns&lt;br&gt;
npm install -S dedent&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;然后，开始编辑index.js文件，进行yargs相关用法的学习：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-6.2vup03ac3eg0.webp&quot; alt=&quot;2-6&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-7 yargs高级用法讲解&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;关于yargs的command用法，我们从npmjs官网，看到示例如下：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-7.6vlv3vzsg740.webp&quot; alt=&quot;2-7&quot;&gt;&lt;br&gt;
通过以上代码，我们可以看到定义command的时候，传入了四个参数：&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;‘serve [port]’: command的格式,port为我们自定义的option，相当于  liugezhou-test  serve&lt;/li&gt;
&lt;li&gt;‘start the serve’:关于此serve  command命令的补充描述&lt;/li&gt;
&lt;li&gt;第三个参数为builder函数：在执行此command具体命令之前做的动作，比如上文为serve这个命令定义了一个参数 port，且给定port的默认值为5000&lt;/li&gt;
&lt;li&gt;第四个参数我们叫做handler：是用来具体执行command的一个行为&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;在对上面demo有个简单了解后，回到我们上一节的代码中，继续添加command定义：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-8.hrcclk4of0w.webp&quot; alt=&quot;2-8&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-8 lerna脚手架初始化过程超详细讲解&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过 4-6、4-7两节内容，分析lerna脚手架的初始化过程讲解。&lt;br&gt;
&lt;strong&gt;4-9 lerna脚手架Command执行过程详解&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;大致流程了解，未画流程图。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-10 【关键知识复习】javascript事件循环–EventLoop&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;EventLoop中存在两种事件：宏任务(MacroTask)和微任务(MicroTask)&lt;/li&gt;
&lt;li&gt;JavaScript脚本中加入到宏任务中去&lt;/li&gt;
&lt;li&gt;当宏任务队列中任务执行完毕后，会将微任务队列中任务清空，清空之后再去执行宏任务队列。这种循环往复的执行流程就称为事件循环–EventLoop。&lt;/li&gt;
&lt;li&gt;然后：我们在宏任务中加入一个setTimeout。&lt;/li&gt;
&lt;li&gt;接着，我们在宏任务队列中加入一个 Promise.then() , Promise.then()中的内容会被加入到微任务队列中去。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-11 import-local执行流程深度分析&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;import-local的作用是：当我们的项目当中本地存在一个脚手架命令，同时全局在node当中也存在一个脚手架命令的时候，优先选用本地的node_modules中的版本。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;在执行一个node代码的时候，默认会向node代码当中注入一些变量：__filename 、 __dirname 、 require 、 module、exports.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;首先，执行lerna命令的时候，会执行node全局下的lerna，即which  lerna 指向的：&lt;br&gt;
软连接：/Users/liumingzhou/.nvm/versions/node/v12.16.1，&lt;br&gt;
实际指向：/Users/liumingzhou/.nvm/versions/node/v12.16.1/lib/node_modules/lerna/cli.js&lt;code&gt;[PRATIC]&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;然后，在webstorm的debug调试中，Node parameters修改为&lt;code&gt;[PRATIC]&lt;/code&gt; 地址。&lt;br&gt;
接着，点击调试按钮，我们知道，程序首先进入的文件是&lt;code&gt;[PRATIC]&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/usr/bin/env node&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;quot;use strict&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* eslint-disable import/no-dynamic-require, global-require */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; importLocal = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;import-local&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (importLocal(__filename)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;npmlog&amp;quot;&lt;/span&gt;).&lt;span class=&quot;title function_&quot;&gt;info&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;cli&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;using local version of lerna&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;)(process.&lt;span class=&quot;property&quot;&gt;argv&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过上面分析我们知道了执行流程，现在的重点就是看代码中的 require(‘import-local’)中的源码。&lt;br&gt;
我们进入到import-local源码中：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;#x27;use strict&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;path&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; resolveCwd = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;resolve-cwd&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; pkgDir = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;pkg-dir&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;filename&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; globalDir = pkgDir.&lt;span class=&quot;title function_&quot;&gt;sync&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(filename));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; relativePath = path.&lt;span class=&quot;title function_&quot;&gt;relative&lt;/span&gt;(globalDir, filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; pkg = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(globalDir, &lt;span class=&quot;string&quot;&gt;&amp;#x27;package.json&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; localFile = resolveCwd.&lt;span class=&quot;title function_&quot;&gt;silent&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(pkg.&lt;span class=&quot;property&quot;&gt;name&lt;/span&gt;, relativePath));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; localFile &amp;amp;&amp;amp; path.&lt;span class=&quot;title function_&quot;&gt;relative&lt;/span&gt;(localFile, filename) !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt; ? &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(localFile) : &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;path.dirname(filename)&lt;/code&gt;：这句代码的意思是获取到文件filename的上级目录。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-12 pkg-dir源码解析（一大波优秀的文件操作库)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本节分析上面代码，对import-local源码细节分析，本节分析代码流程为globalDir是如何获得的：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;const pkgDir = require(‘pkg-dir’)&lt;br&gt;
pkg-dir:字面意思为，获得package.json文件的上级目录&lt;/p&gt;
&lt;p&gt;进入 pkg-dir源码：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;#x27;use strict&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;path&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; findUp = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;find-up&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;cwd&lt;/span&gt; =&amp;gt;&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;findUp&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;package.json&amp;#x27;&lt;/span&gt;, &amp;#123;cwd&amp;#125;).&lt;span class=&quot;title function_&quot;&gt;then&lt;/span&gt;(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;fp&lt;/span&gt; =&amp;gt;&lt;/span&gt; fp ? path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(fp) : &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;sync&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;cwd&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; fp = findUp.&lt;span class=&quot;title function_&quot;&gt;sync&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;package.json&amp;#x27;&lt;/span&gt;, &amp;#123;cwd&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; fp ? path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(fp) : &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;我们分析pkg-dir代码可知：pkg-dir这个库向我们暴露了两个方法：默认cwd和sync方法，其中sync方法会以同步的方式执行。&lt;/p&gt;
&lt;p&gt;同时，这里又引用find-up这个库&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;#x27;use strict&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;path&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; locatePath = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;locate-path&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;filename, opts = &amp;#123;&amp;#125;&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; startDir = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(opts.&lt;span class=&quot;property&quot;&gt;cwd&lt;/span&gt; || &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &amp;#123;root&amp;#125; = path.&lt;span class=&quot;title function_&quot;&gt;parse&lt;/span&gt;(startDir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; filenames = [].&lt;span class=&quot;title function_&quot;&gt;concat&lt;/span&gt;(filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Promise&lt;/span&gt;(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;resolve&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;dir&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;title function_&quot;&gt;locatePath&lt;/span&gt;(filenames, &amp;#123;&lt;span class=&quot;attr&quot;&gt;cwd&lt;/span&gt;: dir&amp;#125;).&lt;span class=&quot;title function_&quot;&gt;then&lt;/span&gt;(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;file&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (file) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(dir, file));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (dir === root) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(&lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;title function_&quot;&gt;find&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(dir));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;)(startDir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;sync&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;filename, opts = &amp;#123;&amp;#125;&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; dir = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(opts.&lt;span class=&quot;property&quot;&gt;cwd&lt;/span&gt; || &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &amp;#123;root&amp;#125; = path.&lt;span class=&quot;title function_&quot;&gt;parse&lt;/span&gt;(dir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; filenames = [].&lt;span class=&quot;title function_&quot;&gt;concat&lt;/span&gt;(filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;comment&quot;&gt;// eslint-disable-next-line no-constant-condition&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; file = locatePath.&lt;span class=&quot;title function_&quot;&gt;sync&lt;/span&gt;(filenames, &amp;#123;&lt;span class=&quot;attr&quot;&gt;cwd&lt;/span&gt;: dir&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (file) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; path.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(dir, file);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (dir === root) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  dir = path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(dir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;同理，find-up这个库也是默认的module.exports方法与同步返回的sync方法。&lt;br&gt;
这里我们继续分析find-up这个库的sync方法，一行一行代码解析：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;let dir = path.resolve(opts.cwd || ‘’);&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;path.resolve是我node当中经常使用的方法，它主要作用是把两个相对路径进行结合。&lt;br&gt;
path.resolve(‘/Users’,‘/liumingzhou’),返回的路径为 /liumingzhou&lt;br&gt;
path.join(‘/Users’,‘/liumingzhou’),返回的路径为 /Users/liumingzhou&lt;/p&gt;
&lt;p&gt;这里有个注意点是path.resolve(‘.’)返回的是当前路径,而path.join(‘.’),返回的就是. 不会帮我们判定当前的 . 与上级路径的关系。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;const {root} = path.parse(dir);&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;path.parse(“/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core”)&lt;br&gt;
返回的结果为：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;{&lt;br&gt;
root:‘/’,&lt;br&gt;
dir:‘/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core’,&lt;br&gt;
base:‘lerna’,&lt;br&gt;
ext:‘’,&lt;br&gt;
name:‘lerna’&lt;br&gt;
}&lt;/p&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;const filenames = [].concat(filename);&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;通过分析上下文，我们知道这行代码的filename指的是 package.json,于是filenames = [‘package.json’]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;while (true) {}&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;这里是个无限循环，需要注意的一点是退出条件&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;5&quot;&gt;
&lt;li&gt;const file = locatePath.sync(filenames, {cwd: dir});&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;这里又调用了这个locatePath这个库的sync方法，local-path这个库的作用是磁盘中是否存在这个路径，如果存在会把第一个文件返回。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;sync&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;iterable, options&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; options = &lt;span class=&quot;title class_&quot;&gt;Object&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;assign&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;cwd&lt;/span&gt;: process.&lt;span class=&quot;title function_&quot;&gt;cwd&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;, options);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; el &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; iterable) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (pathExists.&lt;span class=&quot;title function_&quot;&gt;sync&lt;/span&gt;(path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(options.&lt;span class=&quot;property&quot;&gt;cwd&lt;/span&gt;, el))) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; el;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;通过上面的代码，我们看到上面又用到了一个库：pathExists(通过名字我们显而易见的知道，这个库的作用是判断传入的一个路径是否存在的)，pathExists这个库源码不贴了，主要的一行代码是：fs.accessSync(fp),这行代码就是判断是否能到达一个文件，如果报错就会被try catch捕获返回false&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;6&quot;&gt;
&lt;li&gt;if (file) {&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;return path.join(dir, file);         &lt;br&gt;
 }&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;通过前面分析 path.join(dir, file)返回的就是&lt;br&gt;
/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core/lerna/package.json&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;最终获得globalDir！&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-13 resolve-from源码解析（彻底搞懂node_modules模块加载逻辑）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们回到import-local源码，继续看&lt;br&gt;
const relativePath = path.relative(globalDir, filename);&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;demo:&lt;br&gt;
const relativePath = path.relative(“/a/b/c”, ‘/a/b/c/d.js’);&lt;br&gt;
relativePath返回值为  d.js&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;const pkg = require(path.join(globalDir, ‘package.json’));&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;这里获得package.json这个文件&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;import-local最关键的一部分来了：&lt;br&gt;
const localFile = resolveCwd.silent(path.join(&lt;a href=&quot;http://pkg.name&quot;&gt;pkg.name&lt;/a&gt;, relativePath));&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;resolveCwd的含义是给出一个包名和主进入文件名，去本地文件中查找是否存在这样的路径&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;然后我们就进入resolveCwd这个引用库的源码，查看是如何实现的(传入的参数为 lerna/cli.js)&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;#x27;use strict&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; resolveFrom = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;resolve-from&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;moduleId&lt;/span&gt; =&amp;gt;&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFrom&lt;/span&gt;(process.&lt;span class=&quot;title function_&quot;&gt;cwd&lt;/span&gt;(), moduleId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;silent&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;moduleId&lt;/span&gt; =&amp;gt;&lt;/span&gt; resolveFrom.&lt;span class=&quot;title function_&quot;&gt;silent&lt;/span&gt;(process.&lt;span class=&quot;title function_&quot;&gt;cwd&lt;/span&gt;(), moduleId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里又引用了resolve-from这个库的silent静默方法(源码见下)：&lt;br&gt;
这里需要引起注意一点的是resolve-from这个库传入的两个参数分别是上面提到的 lerna/cli.js以及 process.cwd()这个参数，这个process.cwd的传入参数为Working directory：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-9.5jf81z9j35c0.webp&quot; alt=&quot;2-9&quot;&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;#x27;use strict&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;path&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt; = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;module&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFrom&lt;/span&gt; = (&lt;span class=&quot;params&quot;&gt;fromDir, moduleId, silent&lt;/span&gt;) =&amp;gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; fromDir !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;TypeError&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;`Expected \`fromDir\` to be of type \`string\`, got \`&lt;span class=&quot;subst&quot;&gt;$&amp;#123;&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; fromDir&amp;#125;&lt;/span&gt;\``&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; moduleId !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;TypeError&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;`Expected \`moduleId\` to be of type \`string\`, got \`&lt;span class=&quot;subst&quot;&gt;$&amp;#123;&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; moduleId&amp;#125;&lt;/span&gt;\``&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fromDir = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(fromDir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; fromFile = path.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(fromDir, &lt;span class=&quot;string&quot;&gt;&amp;#x27;noop.js&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFileName&lt;/span&gt; = (&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) =&amp;gt; &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_resolveFilename&lt;/span&gt;(moduleId, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;: fromFile,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;attr&quot;&gt;filename&lt;/span&gt;: fromFile,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;attr&quot;&gt;paths&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_nodeModulePaths&lt;/span&gt;(fromDir)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (silent) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFileName&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (err) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFileName&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;fromDir, moduleId&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFrom&lt;/span&gt;(fromDir, moduleId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable language_&quot;&gt;module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;exports&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;silent&lt;/span&gt; = &lt;span class=&quot;function&quot;&gt;(&lt;span class=&quot;params&quot;&gt;fromDir, moduleId&lt;/span&gt;) =&amp;gt;&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFrom&lt;/span&gt;(fromDir, moduleId, &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;分析上面代码，最关键的代码为：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;resolveFileName&lt;/span&gt; = (&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) =&amp;gt; &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_resolveFilename&lt;/span&gt;(moduleId, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;: fromFile,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;filename&lt;/span&gt;: fromFile,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;attr&quot;&gt;paths&lt;/span&gt;: &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_nodeModulePaths&lt;/span&gt;(fromDir)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;Module：node的内置模块，(通常开发过程中是不需要使用的),Module中的 下划线(_)方法，都称为内置方法&lt;br&gt;
_resolveFilename方法，是我们node中  require方法实现的核心方法之一，关于require方法的实现，参考阮一峰老师的这篇文章：&lt;a href=&quot;http://www.ruanyifeng.com/blog/2015/05/require.html&quot;&gt;require()源码解读&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;分析上面这段代码，Module._resolveFilename的作用是解析模块的真实路径，这个方法传进去两个参数，其中第一个options我们发现了：&lt;br&gt;
Module._nodeModulesPaths(fromDir)这个方法，这个方法的作用是生成node_modules的可能路径。&lt;br&gt;
在对这个方法源码进行学习前，我们预先从老师那了解到了这个方法的实现逻辑：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-10.6yvj127gn0w0.webp&quot; alt=&quot;2-10&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后我们进入到Module._nodeModulesPaths方法中：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_nodeModulePaths&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Guarantee that &amp;#x27;from&amp;#x27; is absolute.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Return early not only to avoid unnecessary work, but to *avoid* returning&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// an array of two items for a root: [ &amp;#x27;//node_modules&amp;#x27;, &amp;#x27;/node_modules&amp;#x27; ]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; === &lt;span class=&quot;string&quot;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&amp;#x27;/node_modules&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// note: this approach *only* works when the path is guaranteed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// to be absolute.  Doing a fully-edge-case-correct path.split&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// that works on both Windows and Posix is non-trivial.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; paths = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; i = &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, p = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, last = &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;; i &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; --i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; code = &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;charCodeAt&lt;/span&gt;(i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (code === &lt;span class=&quot;variable constant_&quot;&gt;CHAR_FORWARD_SLASH&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (p !== nmLen)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          paths.&lt;span class=&quot;title function_&quot;&gt;push&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, last) + &lt;span class=&quot;string&quot;&gt;&amp;#x27;/node_modules&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        last = i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        p = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (p !== -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (nmChars[p] === code) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ++p;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          p = -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Append /node_modules to handle root paths.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    paths.&lt;span class=&quot;title function_&quot;&gt;push&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;/node_modules&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; paths;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;分析以上代码，这里我们的from是：/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna&lt;br&gt;
然后通过上面算法计算，最后得到的结果是：&lt;/p&gt;
&lt;p&gt;[/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/node_modules,&lt;br&gt;
/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/node_modules,&lt;br&gt;
/Users/liumingzhou/Documents/imoocCourse/node_modules,&lt;br&gt;
/Users/liumingzhou/Documents/node_modules,&lt;br&gt;
/Users/liumingzhou/node_modules,&lt;br&gt;
/Users/node_modules,&lt;br&gt;
/node_modules]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;将这个数组返回后，我们继续分析Module._resolveFilename这个方法的源码：&lt;br&gt;
同样在对这个方法源码进行学习前，我们也预先从老师那了解到了这个方法的实现逻辑：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-11.666n2zheeec0.webp&quot; alt=&quot;2-11&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;4-14 Node模块加载核心方法_resovleFileName源码深入解析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先，关于Module._resolveFileName的源码分析要更为复杂，这是因为算法部分较多。&lt;/p&gt;
&lt;p&gt;Module._resolveFilename这个方法的源码为如下(代码逻辑添加注释)：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_resolveFilename&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;request, parent, isMain, options&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;title class_&quot;&gt;NativeModule&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;canBeRequiredByUsers&lt;/span&gt;(request)) &amp;#123;  &lt;span class=&quot;comment&quot;&gt;//判断是否为可加载的内置模块&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; request;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; paths;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; options === &lt;span class=&quot;string&quot;&gt;&amp;#x27;object&amp;#x27;&lt;/span&gt; &amp;amp;&amp;amp; options !== &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;) &amp;#123;   &lt;span class=&quot;comment&quot;&gt;//我们在这传入的options是	   undefined，因此之间跳过到else中---即执行Module._resolveLookupPaths(request, parent);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;title class_&quot;&gt;ArrayIsArray&lt;/span&gt;(options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; isRelative = request.&lt;span class=&quot;title function_&quot;&gt;startsWith&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;./&amp;#x27;&lt;/span&gt;) ||&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          request.&lt;span class=&quot;title function_&quot;&gt;startsWith&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;../&amp;#x27;&lt;/span&gt;) ||&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ((isWindows &amp;amp;&amp;amp; request.&lt;span class=&quot;title function_&quot;&gt;startsWith&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;.\\&amp;#x27;&lt;/span&gt;)) ||&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          request.&lt;span class=&quot;title function_&quot;&gt;startsWith&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;..\\&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isRelative) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        paths = options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; fakeParent = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        paths = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; path = options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          fakeParent.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt; = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_nodeModulePaths&lt;/span&gt;(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; lookupPaths = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_resolveLookupPaths&lt;/span&gt;(request, fakeParent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; lookupPaths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!paths.&lt;span class=&quot;title function_&quot;&gt;includes&lt;/span&gt;(lookupPaths[j]))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              paths.&lt;span class=&quot;title function_&quot;&gt;push&lt;/span&gt;(lookupPaths[j]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt; === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      paths = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_resolveLookupPaths&lt;/span&gt;(request, parent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;ERR_INVALID_OPT_VALUE&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;options.paths&amp;#x27;&lt;/span&gt;, options.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    paths = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_resolveLookupPaths&lt;/span&gt;(request, parent);  &lt;span class=&quot;comment&quot;&gt;// 然后就进入了_resolveLookPaths，进行了paths的一些合并，拿到合并的数组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (parent &amp;amp;&amp;amp; parent.&lt;span class=&quot;property&quot;&gt;filename&lt;/span&gt;) &amp;#123;      &lt;span class=&quot;comment&quot;&gt;// 我们这里是有filename的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; filename = &lt;span class=&quot;title function_&quot;&gt;trySelf&lt;/span&gt;(parent.&lt;span class=&quot;property&quot;&gt;filename&lt;/span&gt;, isMain, request);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (filename) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;title function_&quot;&gt;emitExperimentalWarning&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Package name self resolution&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; cacheKey = request + &lt;span class=&quot;string&quot;&gt;&amp;#x27;\x00&amp;#x27;&lt;/span&gt; +&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (paths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; === &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; ? paths[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] : paths.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;\x00&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_pathCache&lt;/span&gt;[cacheKey] = filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Look up the filename first, since that&amp;#x27;s the cache key.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; filename = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;_findPath&lt;/span&gt;(request, paths, isMain, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;);  &lt;span class=&quot;comment&quot;&gt;//另一非常有难度的方法，源代码见下面的下面&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (filename) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; requireStack = [];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; cursor = parent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cursor;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cursor = cursor.&lt;span class=&quot;property&quot;&gt;parent&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    requireStack.&lt;span class=&quot;title function_&quot;&gt;push&lt;/span&gt;(cursor.&lt;span class=&quot;property&quot;&gt;filename&lt;/span&gt; || cursor.&lt;span class=&quot;property&quot;&gt;id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; message = &lt;span class=&quot;string&quot;&gt;`Cannot find module &amp;#x27;&lt;span class=&quot;subst&quot;&gt;$&amp;#123;request&amp;#125;&lt;/span&gt;&amp;#x27;`&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (requireStack.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    message = message + &lt;span class=&quot;string&quot;&gt;&amp;#x27;\nRequire stack:\n- &amp;#x27;&lt;/span&gt; + requireStack.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;\n- &amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// eslint-disable-next-line no-restricted-syntax&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; err = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Error&lt;/span&gt;(message);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  err.&lt;span class=&quot;property&quot;&gt;code&lt;/span&gt; = &lt;span class=&quot;string&quot;&gt;&amp;#x27;MODULE_NOT_FOUND&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  err.&lt;span class=&quot;property&quot;&gt;requireStack&lt;/span&gt; = requireStack;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; err;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Module._resolveLookupPaths这个方法的源码为如下(代码逻辑添加注释)：&lt;br&gt;
主要功能就是将paths和环境变量node_modules合并&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_resolveLookupPaths&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;request, parent&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;title class_&quot;&gt;NativeModule&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;canBeRequiredByUsers&lt;/span&gt;(request)) &amp;#123;   &lt;span class=&quot;comment&quot;&gt;// 先判断是否为内置模块&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;debug&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;looking for %j in []&amp;#x27;&lt;/span&gt;, request);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Check for node modules paths.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (request.&lt;span class=&quot;title function_&quot;&gt;charAt&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; ||&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (request.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; &amp;gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      request.&lt;span class=&quot;title function_&quot;&gt;charAt&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt; &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      request.&lt;span class=&quot;title function_&quot;&gt;charAt&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt; &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (!isWindows || request.&lt;span class=&quot;title function_&quot;&gt;charAt&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;\\&amp;#x27;&lt;/span&gt;))) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; paths = modulePaths;        &lt;span class=&quot;comment&quot;&gt;//环境变量中存储的一些node_modules目录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (parent != &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; parent.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt; &amp;amp;&amp;amp; parent.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      paths = parent.&lt;span class=&quot;property&quot;&gt;paths&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;concat&lt;/span&gt;(paths);    &lt;span class=&quot;comment&quot;&gt;// 与之前传进来的paths进行合并&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;debug&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;looking for %j in %j&amp;#x27;&lt;/span&gt;, request, paths);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; paths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; ? paths : &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;    &lt;span class=&quot;comment&quot;&gt;// 将合并的paths返回  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// In REPL, parent.filename is null.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!parent || !parent.&lt;span class=&quot;property&quot;&gt;id&lt;/span&gt; || !parent.&lt;span class=&quot;property&quot;&gt;filename&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Make require(&amp;#x27;./path/to/foo&amp;#x27;) work - normally the path is taken&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// from realpath(__filename) but in REPL there is no filename&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; mainPaths = [&lt;span class=&quot;string&quot;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;debug&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;looking for %j in %j&amp;#x27;&lt;/span&gt;, request, mainPaths);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mainPaths;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;debug&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;RELATIVE: requested: %s from parent.id %s&amp;#x27;&lt;/span&gt;, request, parent.&lt;span class=&quot;property&quot;&gt;id&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; parentDir = [path.&lt;span class=&quot;title function_&quot;&gt;dirname&lt;/span&gt;(parent.&lt;span class=&quot;property&quot;&gt;filename&lt;/span&gt;)];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;debug&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;looking for %j&amp;#x27;&lt;/span&gt;, parentDir);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; parentDir;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;Module._findPath要解决的问题是在paths中解析模块的真实路径，&lt;br&gt;
同样在对这个方法源码进行学习前，我们也预先从老师那了解到了这个方法的实现逻辑：&lt;br&gt;
&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-12.2oq71qhv97u0.webp&quot; alt=&quot;2-12&quot;&gt;&lt;br&gt;
源码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_findPath&lt;/span&gt; = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;request, paths, isMain&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; absoluteRequest = path.&lt;span class=&quot;title function_&quot;&gt;isAbsolute&lt;/span&gt;(request);  &lt;span class=&quot;comment&quot;&gt;//判断是否为绝对路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (absoluteRequest) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    paths = [&lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!paths || paths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; === &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 通过 \x00 生成一大段的cacheKey&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; cacheKey = request + &lt;span class=&quot;string&quot;&gt;&amp;#x27;\x00&amp;#x27;&lt;/span&gt; +&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                (paths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; === &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; ? paths[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] : paths.&lt;span class=&quot;title function_&quot;&gt;join&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;\x00&amp;#x27;&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; entry = &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_pathCache&lt;/span&gt;[cacheKey];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (entry)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; entry;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; exts;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// trailingSlash判断request是否已 / 结尾的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; trailingSlash = request.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    request.&lt;span class=&quot;title function_&quot;&gt;charCodeAt&lt;/span&gt;(request.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt; - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) === &lt;span class=&quot;variable constant_&quot;&gt;CHAR_FORWARD_SLASH&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 若不是以 / 结尾，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!trailingSlash) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//会以正则进行匹配，这里的正则在下下节专门学习，这里暂时略过，这里的结论：该正则表示的结果为  是否是以“/..、/.、.. 、 . ”结尾&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    trailingSlash = &lt;span class=&quot;regexp&quot;&gt;/(?:^|\/)\.?\.$/&lt;/span&gt;.&lt;span class=&quot;title function_&quot;&gt;test&lt;/span&gt;(request);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// For each path&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; paths.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Don&amp;#x27;t search further if path doesn&amp;#x27;t exist&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//一次拿出paths中存储的值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; curPath = paths[i];  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//stat(curPath)返回结果 1是文件夹，0为文件，我们这里第一个返回的是文件夹 1，因此，不会跳出循环，继续向下执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (curPath &amp;amp;&amp;amp; &lt;span class=&quot;title function_&quot;&gt;stat&lt;/span&gt;(curPath) &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//这里的意思就是将我们的curPath与request做一个结合&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; basePath = &lt;span class=&quot;title function_&quot;&gt;resolveExports&lt;/span&gt;(curPath, request, absoluteRequest);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//stat(basePath)看上面合成的文件是否存在，为0说明为文件且文件存在&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; rc = &lt;span class=&quot;title function_&quot;&gt;stat&lt;/span&gt;(basePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 判断结尾是不是一个 /&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!trailingSlash) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;comment&quot;&gt;// 判断当前的basePath是否为一个文件 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (rc === &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;  &lt;span class=&quot;comment&quot;&gt;// File.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;comment&quot;&gt;// isMain是否传入   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isMain) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;//是否阻止去做超链接，根据我们的分析，这里不是 preserveSymlinks为false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (preserveSymlinks) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            filename = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(basePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// toRealPath：我们的分析 basePath在这里为软连接，然后通过此方法，找到真实的文件路径。然后，我们进入下一节，看看这个toRealPath是如何实现的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            filename = &lt;span class=&quot;title function_&quot;&gt;toRealPath&lt;/span&gt;(basePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (preserveSymlinksMain) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// For the main module, we use the preserveSymlinksMain flag instead&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// mainly for backward compatibility, as the preserveSymlinks flag&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// historically has not applied to the main module.  Most likely this&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// was intended to keep .bin/ binaries working, as following those&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// symlinks is usually required for the imports in the corresponding&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// files to resolve; that said, in some use cases following symlinks&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// causes bigger problems which is why the preserveSymlinksMain option&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;// is needed.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          filename = path.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(basePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          filename = &lt;span class=&quot;title function_&quot;&gt;toRealPath&lt;/span&gt;(basePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!filename) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// Try it with each of the extensions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (exts === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          exts = &lt;span class=&quot;title class_&quot;&gt;ObjectKeys&lt;/span&gt;(&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_extensions&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        filename = &lt;span class=&quot;title function_&quot;&gt;tryExtensions&lt;/span&gt;(basePath, exts, isMain);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!filename &amp;amp;&amp;amp; rc === &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;  &lt;span class=&quot;comment&quot;&gt;// Directory.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// try it with each of the extensions at &amp;quot;index&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (exts === &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        exts = &lt;span class=&quot;title class_&quot;&gt;ObjectKeys&lt;/span&gt;(&lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_extensions&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      filename = &lt;span class=&quot;title function_&quot;&gt;tryPackage&lt;/span&gt;(basePath, exts, isMain, request);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (filename) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;title class_&quot;&gt;Module&lt;/span&gt;.&lt;span class=&quot;property&quot;&gt;_pathCache&lt;/span&gt;[cacheKey] = filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; filename;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;4-15 fs模块toRealPath源码深入解析&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我们到toRealPath方法后，webStorm的node调试工具，点击继续 Step Into到该方法中，代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 通过代码，我们知道toRealPath的方法实现，正如上面的逻辑图显示的，使用的是 fs.realpathSync这个模块。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;toRealPath&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;requestPath&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 该方法传入两个参数，一个路径地址 requestPath，以及一个options&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// realpathCache为一个chche，表示的是当前已经做过路径判断的所有路径缓存，绝大多数的key值与value值是一样的，并没有软链接，但是也存在少量的有软连接的：key与value值不同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; fs.&lt;span class=&quot;title function_&quot;&gt;realpathSync&lt;/span&gt;(requestPath, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [internalFS.&lt;span class=&quot;property&quot;&gt;realpathCacheKey&lt;/span&gt;]: realpathCache&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;同样的，我们在进去toRealPath这个方法，看到fs.realpathSync实现之前，我们先从老师哪里有拿到逻辑图，并根据图进行分析学习该代码里面的逻辑：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-13.21kw7t7x45pc.webp&quot; alt=&quot;2-13&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后我们继续 Step Into到fs.realpathSync这个方法中，源码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;185&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// options 为Symbol&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;realpathSync&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;p, options&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    options = emptyObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    options = &lt;span class=&quot;title function_&quot;&gt;getOptions&lt;/span&gt;(options, emptyObj);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  p = &lt;span class=&quot;title function_&quot;&gt;toPathIfFileURL&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 如果不是string格式的，进行格式转换&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; p !== &lt;span class=&quot;string&quot;&gt;&amp;#x27;string&amp;#x27;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    p += &lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//判断该路径是否为有效路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;title function_&quot;&gt;validatePath&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//pathModule 与我们直接引用的path模块没有区别：相对路径转为绝对路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  p = pathModule.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// cache为一个map对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; cache = options[realpathCacheKey];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 查找缓存&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; maybeCachedResult = cache &amp;amp;&amp;amp; cache.&lt;span class=&quot;title function_&quot;&gt;get&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 是否查到了缓存，如果查到直接返回，如果没有查到，继续向后&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (maybeCachedResult) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; maybeCachedResult;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 定义所有软连接的缓存，ObjectCreate(null)创建的对象没有原型链，好处为它是一个纯粹的对象，节约内存空间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; seenLinks = &lt;span class=&quot;title class_&quot;&gt;ObjectCreate&lt;/span&gt;(&lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; knownHard = &lt;span class=&quot;title class_&quot;&gt;ObjectCreate&lt;/span&gt;(&lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//将传入的path保存下来，做了一个缓存，这里的p相当于缓存中的key(若是软连接，则为软连接路径)，original相当于value(实际路径)，这么做的原因为：这里的p我们后面可能会发生改变&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; original = p;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 然后下面代码，进入到上图流程图中的路径是否存在/这个流程&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Current character position in p&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; pos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// The partial path so far, including a trailing slash if any&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; current;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// The partial path without a trailing slash (except when pointing at a root)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; base;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// The partial path scanned in the previous round, with slash&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; previous;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Skip over roots&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 找到p中的根路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  current = base = &lt;span class=&quot;title function_&quot;&gt;splitRoot&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  pos = current.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// On windows, check that the root exists. On unix there is no need.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 这里是windows系统的逻辑，我们是mac的，所以可以先跳过&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isWindows &amp;amp;&amp;amp; !knownHard[base]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ctx = &amp;#123; &lt;span class=&quot;attr&quot;&gt;path&lt;/span&gt;: base &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    binding.&lt;span class=&quot;title function_&quot;&gt;lstat&lt;/span&gt;(pathModule.&lt;span class=&quot;title function_&quot;&gt;toNamespacedPath&lt;/span&gt;(base), &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;title function_&quot;&gt;handleErrorFromBinding&lt;/span&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    knownHard[base] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Walk down the path, swapping out linked path parts for their real&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// values&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// NB: p.length changes.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// 然后开始循环 由上文得知，我们的pos长度为1，p的长度为传入的path的长度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (pos &amp;lt; p.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// find the next part&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// nextPart这里调用的就是p.indexOf(&amp;#x27;/&amp;#x27;,pos),这个方法举例如下：&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// &amp;quot;/xxx/yyy&amp;quot;.indexOf(&amp;#x27;/&amp;#x27;)  =&amp;gt; 0  这里我们找到的是第一个“/”的位置，如果我们想找第二个“/”位置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// &amp;quot;/xxx/yyy&amp;quot;.indexOf(&amp;#x27;/&amp;#x27;,1) =&amp;gt; 4,这里的1指的是跳过第一个元素，从第二个元素开始寻找&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; result = &lt;span class=&quot;title function_&quot;&gt;nextPart&lt;/span&gt;(p, pos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    previous = current;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (result === -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; last = p.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(pos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      current += last;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      base = previous + last;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      pos = p.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      current += p.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(pos, result + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      base = previous + p.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(pos, result);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      pos = result + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 判断一下在cahe中是否存在&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Continue if not a symlink, break if a pipe/socket&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (knownHard[base] || (cache &amp;amp;&amp;amp; cache.&lt;span class=&quot;title function_&quot;&gt;get&lt;/span&gt;(base) === base)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 判断是否为一个file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;title function_&quot;&gt;isFileType&lt;/span&gt;(statValues, &lt;span class=&quot;variable constant_&quot;&gt;S_IFIFO&lt;/span&gt;) ||&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;title function_&quot;&gt;isFileType&lt;/span&gt;(statValues, &lt;span class=&quot;variable constant_&quot;&gt;S_IFSOCK&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; resolvedLink;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 判断是不是软链接，从缓存中去拿&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; maybeCachedResolved = cache &amp;amp;&amp;amp; cache.&lt;span class=&quot;title function_&quot;&gt;get&lt;/span&gt;(base);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (maybeCachedResolved) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      resolvedLink = maybeCachedResolved;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// Use stats array directly to avoid creating an fs.Stats instance just&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// for our internal use.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 没有拿到，然后做处理&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; baseLong = pathModule.&lt;span class=&quot;title function_&quot;&gt;toNamespacedPath&lt;/span&gt;(base);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ctx = &amp;#123; &lt;span class=&quot;attr&quot;&gt;path&lt;/span&gt;: base &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// stats可以打印出 文件在操作系统下的各种信息/ dev_t:文件的设备编号 ino_t:文件在此设备的唯一标识&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; stats = binding.&lt;span class=&quot;title function_&quot;&gt;lstat&lt;/span&gt;(baseLong, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;title function_&quot;&gt;handleErrorFromBinding&lt;/span&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 判断是否为一个软连接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;title function_&quot;&gt;isFileType&lt;/span&gt;(stats, &lt;span class=&quot;variable constant_&quot;&gt;S_IFLNK&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 如果不是软连接，将判断过的路径放入到 knowHard当中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        knownHard[base] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cache) cache.&lt;span class=&quot;title function_&quot;&gt;set&lt;/span&gt;(base, base);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 判断到该路径是一个软连接，然后继续执行下面的代码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// Read the link if it wasn&amp;#x27;t read before&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// dev/ino always return 0 on windows, so skip the check.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//linkTarget 软连接实际的路径地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; linkTarget = &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; id;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 判断是否为window操作系统&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isWindows) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 拿到stat的0号元素，即我们上面注释提到的文件设备编号&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; dev = stats[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].&lt;span class=&quot;title function_&quot;&gt;toString&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 拿到stat的7号元素，即我们上面注释提到的文件唯一标识&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//拿到这两个是想生成一个唯一键：这个文件在当下PC系统下的唯一键&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ino = stats[&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;].&lt;span class=&quot;title function_&quot;&gt;toString&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        id = &lt;span class=&quot;string&quot;&gt;`&lt;span class=&quot;subst&quot;&gt;$&amp;#123;dev&amp;#125;&lt;/span&gt;:&lt;span class=&quot;subst&quot;&gt;$&amp;#123;ino&amp;#125;&lt;/span&gt;`&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 通过这两个唯一键生成的唯一键作为 seenLinks的唯一键&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 下面代码为在seenLinks中查找是否有这个id，如果有就直接拿出来&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (seenLinks[id]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          linkTarget = seenLinks[id];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;// 没有这个软连接的实际路径地址&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (linkTarget === &lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ctx = &amp;#123; &lt;span class=&quot;attr&quot;&gt;path&lt;/span&gt;: base &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        binding.&lt;span class=&quot;title function_&quot;&gt;stat&lt;/span&gt;(baseLong, &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;title function_&quot;&gt;handleErrorFromBinding&lt;/span&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 拿到软连接的实际路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        linkTarget = binding.&lt;span class=&quot;title function_&quot;&gt;readlink&lt;/span&gt;(baseLong, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;title function_&quot;&gt;handleErrorFromBinding&lt;/span&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      resolvedLink = pathModule.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(previous, linkTarget);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cache) cache.&lt;span class=&quot;title function_&quot;&gt;set&lt;/span&gt;(base, resolvedLink);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isWindows) seenLinks[id] = linkTarget;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Resolve the link, then start over&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 将path真实路径重新生成&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    p = pathModule.&lt;span class=&quot;title function_&quot;&gt;resolve&lt;/span&gt;(resolvedLink, p.&lt;span class=&quot;title function_&quot;&gt;slice&lt;/span&gt;(pos));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Skip over roots&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    current = base = &lt;span class=&quot;title function_&quot;&gt;splitRoot&lt;/span&gt;(p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pos = current.&lt;span class=&quot;property&quot;&gt;length&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// On windows, check that the root exists. On unix there is no need.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isWindows &amp;amp;&amp;amp; !knownHard[base]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ctx = &amp;#123; &lt;span class=&quot;attr&quot;&gt;path&lt;/span&gt;: base &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      binding.&lt;span class=&quot;title function_&quot;&gt;lstat&lt;/span&gt;(pathModule.&lt;span class=&quot;title function_&quot;&gt;toNamespacedPath&lt;/span&gt;(base), &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;undefined&lt;/span&gt;, ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;title function_&quot;&gt;handleErrorFromBinding&lt;/span&gt;(ctx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      knownHard[base] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (cache) cache.&lt;span class=&quot;title function_&quot;&gt;set&lt;/span&gt;(original, p);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;encodeRealpathResult&lt;/span&gt;(p, options);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;4-16 讲一个高难度的正则表达式（想挑战的点进来）&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;trailingSlash = /(?:^|/).?.$/.test(request);&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;console.log(/(?:^|/).?.$/.test(‘a’))    --&amp;gt; false&lt;br&gt;
console.log(/(?:^|/).?.$/.test(‘…’))    --&amp;gt; true&lt;br&gt;
console.log(/(?:^|/).?.$/.test(‘/…’))    --&amp;gt; true&lt;br&gt;
console.log(/(?:^|/).?.$/.test(‘/Users’))    --&amp;gt; false&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;''  转译字符&lt;/p&gt;
&lt;p&gt;在正则表达式中  ‘.‘ 是有含义的，表示匹配任意一个字符：&lt;br&gt;
const str = ‘a’;&lt;br&gt;
console.log(a.match(/./))  --&amp;gt; [‘a’, index:0, input:‘a’, groups:undefined]&lt;/p&gt;
&lt;p&gt;因此在正则表达式中要匹配 . 的话，需要加一个 反斜杠 ‘\’，因此‘.’ 匹配的就是一个点&lt;br&gt;
console.log(a.match(/./))  --&amp;gt; null&lt;/p&gt;
&lt;p&gt;‘?’:表示匹配0个或1个字符&lt;br&gt;
‘$’:表示最后的匹配样式&lt;br&gt;
():表示需要返回匹配结果，分组&lt;br&gt;
(?:  ) 表示非匹配分组,不把()中分组的内容显示出来&lt;br&gt;
^:表示非的符号：[!.]表示的是匹配没有. 符号的，需要加[]，但是上文的正则没有[]，上文表示的是匹配一个空格，&lt;br&gt;
‘|’ : 或&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;4-17 大招：如何快速拿到面试“一血”&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;简历简介&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;简历中简介部分至关重要，因为它位于简历的第一屏，是面试官最容易关注的部分，所以我们应该在简介部分充分突出我们的个人特长和优势&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;认真学完本章内容后应该怎么修改简历？&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;熟悉yargs脚手架开发框架&lt;/li&gt;
&lt;li&gt;熟悉多Package管理工具lerna的使用方法和使用原理&lt;/li&gt;
&lt;li&gt;深入理解Node.js模块路径解析流程&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;面试官问起细节后如何回答？&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如何通过yargs开发一个脚手架？&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;答：比如vue-cli的脚手架为：vue create myProjectName&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;脚手架的构成一般由三个部分构成：&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;第一个部分就是： 主命令，也就是bin，它是在packag.json中配置的，通过npm link 进行本地安装&lt;br&gt;
第二个部分 ：command：命令&lt;br&gt;
第三个部分：options 参数&lt;br&gt;
然后需要的一点是主命令bin的配置指向的主文件中，需要在文件顶部加上  #!/usr/bin/env node,就是说在环境变量中找到node命令来执行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;脚手架的初始化流程&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;第一步：首先是直接调用Yargs的构造函数，直接去生成一个脚手架&lt;/p&gt;
&lt;p&gt;第二步：会调用一系列的Yargs提供的常用方法，对脚手架功能进行一个增强。&lt;br&gt;
比如 yargs.usage(用法)、&lt;br&gt;
yargs.options(注册一些脚手架参数熟悉)、&lt;br&gt;
可以调用yargs.group(来对脚手架参数熟悉进行分组)、&lt;br&gt;
yargs.fail(对脚手架异常进行监听)，&lt;br&gt;
还有包括yargs尾部结语的设置yargs.elipogue()、&lt;br&gt;
脚手架窗口设置yargs.wrap()&lt;br&gt;
以及yargs.decomandrecommed(至少输入一个参数)&lt;br&gt;
以及yargs.recommedCommands()推荐命令的提示等&lt;/p&gt;
&lt;p&gt;第三步：需要对脚手架的参数进行一些解析：hideBin(process.argv),其实也就是直接取出从第三个开始的参数.调用的时候直接 yargs.argv&lt;br&gt;
还有一种解析方式就是通过yargs.parse(argv,options)的方法&lt;/p&gt;
&lt;p&gt;第四步：当脚手架的参数解析完成之后，我们要进行命令注册&lt;br&gt;
命令注册我们使用的是yargs.command()方法。&lt;br&gt;
command的注册方式有两种：第一种是一次传参(command,describe,builder,handler),还有一种方式就是传入一个对象，对象属性与第一种方式传入的相同。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;熟悉多Package管理工具lerna的使用方法和使用原理&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;答：首先lerna是基于一个 git + npm的多package，也就是多包的项目管理工具，像一些开源的大型库：vue-vcli/create-react-app/babel等都是基于lerna进行多包管理的。他的作用就是降低包的管理操作成本，提高开发效率。像包的安装、依赖的添加、依赖的解除以及包的发布、打标签等功能。&lt;/p&gt;
&lt;p&gt;实现原理：&lt;br&gt;
首先就是通过 import-local这个库优先调用lerna的本地命令，&lt;br&gt;
然后通过yargs生成一个脚手架、生成脚手架后生成一些全局参数、然后注册命令，通过yargs.parse方法进行参数解析。&lt;br&gt;
需要注意的是lerna的命令注册过程中，需要传入builder以及handler两个方法，builder命令用于注册命令专属的options，而handelr用来处理命令的业务逻辑。&lt;br&gt;
有一点非常值得学习的内容就是lerna它是通过配置本地依赖的方式进行开发的，具体写法就是在package.json的依赖当中通过file的格式书写，在lerna publish的时候再将该路径替换。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;对Node.js模块路径解析流程的一个理解&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;第一：首先Node.js模块的路径解析是通过 require.resolve()方法来实现的&lt;br&gt;
第二：这个resolve方法就是Module._resolveFileName()方法&lt;br&gt;
它的作用就是我们给定一个模块名称的时候，查找处这个模块的真实路径。&lt;/p&gt;
&lt;p&gt;然后，他的核心实现流程有三点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在执行流程中判断当前路径是否为内置模块，若是内置模块直接返回&lt;/li&gt;
&lt;li&gt;若不是内置模块，它会继续调用自身的Module._resolveLookupPaths()方法生成node_modules的所有可能路径&lt;/li&gt;
&lt;li&gt;最后再通过Module._findPath()去查询模块的真实路径。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里关于Module._findPaths()方法的核心实现流程有四步&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;查询缓存(将request[模块名称]和paths[上面返回的所有可生成的node_modules路径]通过\x00合并成cacheKey)&lt;/li&gt;
&lt;li&gt;缓存查不到，就会遍历paths，将每一个path与request结合组成文件路径basePath&lt;/li&gt;
&lt;li&gt;然后判断这个basePath路径是否存在，如果存在会调用 fs.realPathSync()方法获取文件的真实路径，不存在就会继续遍历。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;同时，将文件的真实路径缓存到Module._pathcache()中。&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;这里关于fs.realPathsync()方法的核心流程有三点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;仍然是查询缓存，缓存的key就是我们的path，即basePath，&lt;/li&gt;
&lt;li&gt;如果这个key没有找到，就会将这个key从左到右开始遍历，通过/进行循环遍历，拆分路径，然后判断这个路径是否为软链接，如果是软链接，就去查询它的真实路径，并生成新的path路径，这个新的path路径继续传入这个遍历函数，继续往后遍历，(这里有一个细节需要注意的是：遍历过程中生成的子路径base会缓存在knowHard和ache中，避免重复查询)。&lt;/li&gt;
&lt;li&gt;遍历完成后，就会得到模块的真实路径，并且将原始路径，也就是我们说的软连接路径作为key值，将真实值作为值，保存在缓存中&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;在require中还有一个方法是 require.resolve.paths()方法，这个方法的作用是用于获取所有node_modules可能存在的路径，他的核心内容就是Module._resolveLookupPaths()&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Module._resolveLookupPaths()的实现原理有两点&lt;br&gt;
第一点，如果是 /路径，就在后面加入 node_modules&lt;br&gt;
第二点，将路径从后往前遍历，如果查询到 / ，就拆分路径，在后面加上node_modules,一直遍历到查找不到 /路径，就会返回这个paths数组。&lt;/p&gt;
&lt;/blockquote&gt;
"><meta name="twitter:image"><title>Week2-脚手架架构设计和框架搭建 | 六个周</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.3"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + '912656f1f71687bc80e68bfc7315fc4c';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Week2-脚手架架构设计和框架搭建</h1><a id="logo" href="/.">六个周</a><p class="description">一个人只有一种命运，早日相遇，尽情拥抱。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa fa-subway"> 开往</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Week2-脚手架架构设计和框架搭建</h1><div class="post-meta">2021-01-20<span> | </span><span class="category"><a href="/categories/Web%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%84%9A%E6%89%8B%E6%9E%B6/">Web架构之脚手架</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 11.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 48</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/Week2-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/#vcomment"><span class="valine-comment-count" data-xid="/Week2-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%9C%AC%E5%91%A8%E4%BB%8B%E7%BB%8D"><span class="toc-text">第一章 本周介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8"><span class="toc-text">第二章 脚手架开发入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-text">第三章 脚手架框架搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-Lerna%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text">第四章 Lerna源码解析</span></a></li></ol></div></div><div class="post-content"><p><font color=blue>更新说明：对文章目录排版做了调整。</font><br>
<font color=blue> 更新时间：2022-05-04</font></p>
<h2 id="第一章-本周介绍">第一章 本周介绍</h2>
<p><strong>1-1 确立本周目标</strong></p>
<blockquote>
<ul>
<li>脚手架的实现原理、调试原理</li>
<li>Lerna的常见用法、源码分析</li>
<li>架构设计技巧和架构图绘制方法</li>
<li>Node的module模块分析</li>
<li>yargs使用方法</li>
<li>剖析Lerna架构设计</li>
</ul>
</blockquote>
<p><strong>1-2 前端研发脚手架imooc-cli核心功能演示</strong></p>
<blockquote>
<ul>
<li>安装imooc-cli脚手架： <em><strong>npm i -g  @imooc-cli/core</strong></em></li>
<li>查看脚手架相关内容： <em>** **<strong>imooc-cli</strong></em></li>
<li>通过脚手架新建项目:   <em>** imooc-cli init**</em></li>
<li>项目发布到测试环境：  <em><strong>imooc-cli publish</strong></em></li>
<li>项目发布到正式环境:    <em><strong>imooc-cli publish --prod</strong></em></li>
</ul>
</blockquote>
<p><strong>1-3 脚手架在课程中的定位</strong></p>
<blockquote>
<ul>
<li>本项目中基础项目均由脚手架管理</li>
<li>技术简历突出</li>
<li>提高技能</li>
</ul>
</blockquote>
<h2 id="第二章-脚手架开发入门">第二章 脚手架开发入门</h2>
<p><strong>2-1 本章知识脉络和难点解析</strong></p>
<blockquote>
<ul>
<li>分析开发脚手架的必要性</li>
<li>从使用角度去理解什么是脚手架</li>
<li>脚手架的实现原理(与操作系统关联)</li>
<li>脚手架的开发流程</li>
</ul>
</blockquote>
<p><strong>2-2 站在前端研发的视角，分析开发脚手架的必要性</strong></p>
<blockquote>
<ul>
<li>开发imooc-cli脚手架的核心目标：提升前端研发效能【提炼通用代码、通用流程、构建发布上线】</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-1.3vft5c4ms5m0.webp" alt="2-1"></p>
<blockquote>
<ul>
<li>脚手架核心价值：<em>**自动化、标准化、数据化    **</em></li>
</ul>
</blockquote>
<p>和自动化构建工具(jenkins、travia)区别：自动化构建工具在服务端执行，无法覆盖本地操作且定制自动化的构建工具需要用到Java等后端语言，对前端不友好。</p>
<p><strong>2-3 从使用角度理解什么是脚手架？</strong></p>
<blockquote>
<ul>
<li>脚手架简介：脚手架的本质是一个操作系统的客户端，通过命令行执行。</li>
<li>脚手架执行原理：</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-2.5sd3oxy068s0.webp" alt="2-2"></p>
<blockquote>
<ul>
<li>从应用角度看vue-cli开发脚手架过程：</li>
</ul>
<ol>
<li>首先是个npm项目，项目中有一个bin/vue.js的文件，且这个项目发布到了npm上</li>
<li>将npm项目安装到了lib/node_modules</li>
<li>在node的bin目录下配置软链接到lib/node_modules/@vue/cli/bin/vue.js</li>
</ol>
</blockquote>
<p><strong>脚手架执行原理解析：</strong></p>
<blockquote>
<p>在终端输入：vue create vue-test-app</p>
<ol>
<li>终端解析vue命令【通过_which vue查找vue_】</li>
<li>根据vue命令链接到实际的vue.js文件</li>
<li>终端使用node执行vue.js文件</li>
<li>vue.js文件解析command/options</li>
<li>vue.js文件执行command</li>
<li>执行完毕，退出执行</li>
</ol>
</blockquote>
<p><strong>2-4 脚手架原理讲解(上)</strong></p>
<blockquote>
<p><strong>问题一：为什么全局安装@vue/cli后,我们执行的命令为 vue呢？</strong></p>
</blockquote>
<blockquote>
<p>答：这是因为通过which vue后我们会看到vue所在目录，而这个vue是一个软链接，指向的是@vue/cli。确定这个vue命令名称的是在<code>node/v12.16.1/lib/node_modules/@vue/cli</code>目录下package.json中的bin的键值。</p>
</blockquote>
<blockquote>
<p><strong>问题二：全局安装@vue/cli时发生了什么？</strong></p>
</blockquote>
<blockquote>
<p>答：执行 npm install -g @vue/cli的时候，首先node会把我们当前包下载到node下的node_modules中去。下载完成后，会在下载好的包中查找package.json中是否有bin，如果有，会通过package.json中的bin中的键去配置软链接。</p>
<p>上面两个问题其实问题二在前，问题一在后，两个问题说的是一个流程的双向解释，理解了问题二，问题一就清楚了。</p>
</blockquote>
<blockquote>
<p><strong>问题三：执行vue命令时发生了什么？为什么vue指向一个js文件，我们却可以通过vue命令执行它？</strong></p>
</blockquote>
<blockquote>
<p>答：首先执行vue命令，与执行which vue打印出来的地址  效果是等价的(即执行的是which vue的那个软连接:/Users/liumingzhou/.nvm/versions/node/v12.16.1/bin/vue)。<br>
而软连接又指向它的实际文件存在路径(…/lib/node_modules/@vue/cli/bin/vue.js)。</p>
<p>我们知道，一个test.js文件可以通过node执行，但不能单独执行，这是因为它没有可执行权限。<br>
我们在/Users/liumingzhou/Desktop目录下新建一个test.js文件，我们可以给这个js文件一个执行权限：chmod 777 test.js  然后在命令行直接输入 ./test.js仍然不可以执行。这是因为js文件需要一个解释器来进行执行，这个node就是一个解释器。(.py文件需要 python解释器执行，.java文件需要java解释器进行执行)。</p>
<p>那么我们上面的vue.js文件是怎么执行的呢？<br>
通过查看vue.js文件源码，我们发现第一行代码是这样的：#!/usr/bin/env node<br>
这行代码的意思是：告诉我们的操作系统，直接调用这个文件的时候，到环境变量中查找node命令执行。<br>
(/usr/bin/env 是我们的环境变量)</p>
<p>然后，我们在我们的test.js文件中第一行加入这行代码  #!/usr/bin/env node<br>
直接输入 ./test.js 即可执行这个js文件。</p>
<p>接着，我们不想用 ./test.js这样的方式执行js文件，我们想通过一个命令，比如 liugezhou 这个命令来执行这个test.js文件，我们需要怎么做呢？<br>
第一种方式，我们去找环境变量，通过 echo $PATH</p>
<p>首先，我们创建一个环境变量：<br>
cd  /Users/liumingzhou/.nvm/versions/node/v12.16.1/bin<br>
创建软连接：ln -s  /Users/liumingzhou/Desktop/test.js  liugezhou<br>
创建完毕后，就可以看到一个liugezhou软连接，我们在任何目录执行liugezhou就可以执行test.js文件了。</p>
</blockquote>
<p><strong>2-5 脚手架原理讲解（下）</strong></p>
<p><strong>问题一：为什么说脚手架本质是操作系统的客户端？它和我们在PC上安装的应用/软件有什么区别</strong></p>
<blockquote>
<p>脚手架执行起来的本质是靠node这个命令，node是一个操作系统客户端，而test.js 这个文件仅仅是作为一个参数注入到node命令中。node本质上是一个可执行文件(在window操作系统中可以看到node的扩展名为.exe的)。<br>
本质来说没有区别。区别仅仅是安装的应用软件会提供一个GUI,而node并没有提供GUI</p>
</blockquote>
<p><strong>问题二：如何为node脚手架命令创建别名</strong></p>
<blockquote>
<p>方法一：即为上文提到的创建一个软连接。<br>
接着，我们希望继续为上文提到的  liugezhou 软连接继续添加一个别名，我们需要这么做<br>
在上文的bin目录下，执行命令  ln -s ./liugezhou liugezhou2<br>
即 软连接可以嵌套。</p>
</blockquote>
<p><strong>问题三：描述脚手架命令执行的全过程</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-3.79oyc1dprz80.webp" alt="2-3"></p>
<p><strong>2-6 脚手架开发流程和难点解析</strong></p>
<p><strong>通过以上分析，我们大致了解一个脚手架的开发流程如下：</strong></p>
<blockquote>
<ul>
<li>创建一个npm项目</li>
<li>创建脚手架的入口文件，且入口文件需要添加代码：#!/usr/bin/env node</li>
<li>配置package.json文件，添加bin属性(指定脚手架命令与地址)</li>
<li>编写脚手架代码</li>
<li>将脚手架发布到npm</li>
</ul>
</blockquote>
<p><strong>使用流程</strong>：</p>
<blockquote>
<ul>
<li>安装脚手架： npm install - g your-own-cli</li>
<li>使用脚手架： your-own-cli</li>
</ul>
</blockquote>
<p><strong>脚手架开发难点</strong>：</p>
<blockquote>
<ol>
<li>脚手架开发过程中通常需要将复杂的系统拆分为多个模块_<strong>(分包)</strong>_</li>
<li>脚手架开发过程中需要注册一系列的命令。如何对命令进行注册是一个重要的环节</li>
<li>需要对参数进行解析:     [vue command [options] <params>]</li>
<li>帮助文档：global[主命令]</li>
</ol>
</blockquote>
<p>…………</p>
<blockquote>
<p>命令行交互、日志打印、命令行文字变色、网络通信 HTTP/WebSocket、文件处理等。</p>
</blockquote>
<p><strong>2-7 快速入门第一个脚手架</strong></p>
<p>通过上节流程，我们本节快速开发一个liugezhou-test脚手架并发布，流程如下:</p>
<blockquote>
<ul>
<li>cd /Users/liumingzhou/Desktop</li>
<li>mkdir liugezhou-test</li>
<li>cd liugezhou-test</li>
<li>npm init -y</li>
<li>终端打开liugezhou-test项目：新建lib目录，lib目录下新建index.js文件（index.js文件内容如下）</li>
<li>修改package.json文件，添加 “bin”:{“liugezhou-test”:“lib/index.js”}</li>
<li>npm publish 发布npm包</li>
<li>下载安装：npm i -g liugezhou-test</li>
<li>测试：liugezhou-test</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;welcome liugezhou-test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这里注意一点，在npm publish的时候，如果是在Descktop目录下执行的，那么我们下载liugezhou-test包之后，会看到软链指向的是本地，这是因为npm为了我们本地调试：如果/Desktop目录下有这个包，会指向本地。</p>
<p><strong>2-8 脚手架本地调试方法</strong></p>
<blockquote>
<p>方式一：如上文所说，直接在Desktop目录下执行：npm install -g liugezhou-test,即调试本地包。<br>
(移除本地安装的包：<em><strong>npm remove -g liugezhou-test</strong></em>)</p>
<p>方式二：直接在liugezhou-test文件目录下，执行：<strong><em>npm link</em></strong>,软链指向的node_modules源文件指向本地包。</p>
</blockquote>
<p><strong>分包情况下，如何调试本地包？</strong></p>
<blockquote>
<p>如果/Desktop/liugezhou-test要使用/Desktop/lilugezhou-test/lib包下的方法，如何做呢？</p>
<ul>
<li>在/Desktop/liugezhou-test/lib目录下，npm link</li>
<li>在/Desktop/liugezhou-test/目录下，npm link liugezhou-test-lib</li>
</ul>
</blockquote>
<p><strong>2-9 脚手架本地调试标准流程总结</strong></p>
<p><strong>链接本地脚手架</strong></p>
<blockquote>
<ul>
<li>cd your-cli-dir</li>
<li>npm link</li>
</ul>
</blockquote>
<p><strong>链接本地库文件</strong></p>
<blockquote>
<ul>
<li>cd your-lib-dir</li>
<li>npm link</li>
<li>cd your-cli-dir</li>
<li>npm link your-lib-dir</li>
</ul>
</blockquote>
<p><strong>取消链接本地库文件</strong></p>
<blockquote>
<ul>
<li>cd your-lib-dir</li>
<li>npm unlink</li>
<li>cd your-cli-dir</li>
<li>npm unlink your-lib-dir  #link存在</li>
<li>rm -rf node_modules     # link不存在</li>
<li>npm i -S your-lib-dir</li>
</ul>
</blockquote>
<p><strong>理解 npm  link</strong></p>
<blockquote>
<ul>
<li>npm link : 将当前项目链接到node全局node_modules中作为一个库文件，并解析bin配置创建可执行文件。</li>
<li>npm link your-libr:将当前项目中node_modules下指定的库文件链接到node全局node_modules下的库文件</li>
</ul>
</blockquote>
<p><strong>理解 npm unlink</strong></p>
<blockquote>
<ul>
<li>npm unlink:将当前项目从node全局node_modules中移除</li>
<li>npm unlink your-lib:将当前项目中的库文件依赖删除。</li>
</ul>
</blockquote>
<p><strong>2-10 脚手架命令注册和参数解析</strong></p>
<blockquote>
<p>process是node的内置库<br>
我们在index.js中写代码： console.log(require(‘process’))</p>
<p>通过命令行执行 liugezhou-test init<br>
会看到process有许许多多个属性，其中有一个argv属性。<br>
通过分析这个argv属性，我们就看到了init这个属性。</p>
</blockquote>
<blockquote>
<p>因此我们可以通过argv来判断是否输入了  init 这个命令。</p>
</blockquote>
<p><strong>2-11 脚手架项目发布</strong></p>
<blockquote>
<p>老生常谈，npm publish<br>
通过判断argv输入的参数，在liugezhou-test-lib中与liugezhou-test中加入相关逻辑<br>
实现 liugezhou-test init 与 liugezhou -V的输出显示<br>
然后分别发布，remove掉本地链接。</p>
</blockquote>
<h2 id="第三章-脚手架框架搭建">第三章 脚手架框架搭建</h2>
<hr>
<p><strong>3-1 <strong>本章的收获是什么，难点是什么？</strong></strong></p>
<p>本节课程非常下饭：</p>
<blockquote>
<ul>
<li>收获一：Lerna简介 [Lerna管理的项目有:babel、create-reat-app、vue-cli]</li>
</ul>
</blockquote>
<pre><code> 通过学习lerna将学会如何管理一个复杂的Javascript项目
</code></pre>
<blockquote>
<ul>
<li>收获二：Lerna源码分析：讲解源码结构、执行流程、源码精读</li>
<li>收获三：基于lerna设计简历。</li>
</ul>
</blockquote>
<p><strong>3-2 原生脚手架开发痛点分析</strong></p>
<p>lerna设计源于其要解决的问题，首先我们要分析写原生脚手架开发的痛点：</p>
<blockquote>
<ol>
<li>痛点一：重复操作</li>
</ol>
<ul>
<li>多Package本地link</li>
<li>多Package依赖安装</li>
<li>多Package单元测试</li>
<li>多Package代码提交</li>
<li>多Package代码发布</li>
</ul>
<ol start="2">
<li>版本一致性</li>
</ol>
<ul>
<li>发布时版本一致性</li>
<li>发布后相互依赖版本升级</li>
</ul>
</blockquote>
<p><strong>3-3 本章重点：lerna简介及脚手架开发流程</strong></p>
<p><strong>Lerna简介</strong></p>
<blockquote>
<p>Lerna : <strong>A tool for managing JavaScript projects with multiple packages.</strong><br>
用于管理具有多个程序包的JavaScript项目的工具。</p>
<p>Lerna : <strong>Lerna is a tool that optimizes the workflow around managing multi-package repositories with git and npm.</strong><br>
Lerna是一个基于 <strong>git+npm <strong>的优化工作流的</strong>多package</strong>项目的管理工具。</p>
</blockquote>
<p><strong>优势</strong></p>
<blockquote>
<ul>
<li>大幅减少重复操作</li>
<li>提升操作的标准化</li>
</ul>
</blockquote>
<p>Lerna 是架构优化的产物，它揭示了一个架构真理：项目复杂度提升后，就需要对项目进行架构优化。架构优化的主要目标往往都是以效能为核心。</p>
<blockquote>
<p>lerna官网：<a target="_blank" rel="noopener" href="https://lerna.js.org/">https://lerna.js.org/</a></p>
</blockquote>
<p><strong>Lerna开发脚手架流程 ⭐️⭐️⭐️</strong><br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-4.1fovy6rqci3k.webp" alt="2-4"><br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-5.ry7x197y6ow.webp" alt="2-5"></p>
<p><strong>3-4 基于lerna搭建脚手架框架</strong><br>
<strong>本节使用命令依次如下</strong></p>
<blockquote>
<ul>
<li>
<p>mkdir  liugezhou-cli-dev</p>
</li>
<li>
<p>cd liugezhou-cli-dev</p>
</li>
<li>
<p>npm init -y</p>
</li>
<li>
<p>npm i -g lerna【全局安装】</p>
</li>
<li>
<p>npm i -S lerna</p>
</li>
<li>
<p>lerna init</p>
</li>
<li>
<p>lerna create core</p>
</li>
<li>
<p>lerna create utils</p>
</li>
</ul>
</blockquote>
<p><strong>3-5 Lerna核心操作</strong></p>
<p>本节使用命令依次如下：</p>
<blockquote>
<ul>
<li>
<p>lerna add liugezhou-test  (在packages目录下所有包中安装liugezhou-test包)</p>
</li>
<li>
<p>lerna add liugezhou-test packages/core  （在指定包core中添加依赖）</p>
</li>
<li>
<p>lerna clean (清除packages目录下的依赖)</p>
</li>
<li>
<p>lerna bootstrap (将刚清除的所有依赖，重新安装)</p>
</li>
<li>
<p>lerna link (开发的版本互相存在依赖，可用此命令完成)</p>
</li>
<li>
<p>lerna exec – <commands> […args]</p>
</li>
</ul>
</blockquote>
<p>lerna exec – rm -rf  node_modules   删除packages目录下的所有node_modules文件夹</p>
<blockquote>
<p>lerna exec --scope @liugezhou-cli/utils–rm -rf node_modules 删除packages目录下utils的。。。。<br>
【上下文为packages目录】</p>
<ul>
<li>lerna run test</li>
<li>lerna run --scope @liugezhou-cli/core test  [执行core包package.json中script标签的test属性]</li>
</ul>
</blockquote>
<p><strong>3-6 Lerna发布流程(lerna使用总结)</strong></p>
<blockquote>
<ul>
<li><code>lerna init </code><br>
会自动完成 git 初始化，但不会创建 .gitignore，这个必须要手动添加，否则会将 node_modules 目录都上传到 git</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><code>lerna add:</code><br>
第一个参数：添加npm包名<br>
第二个参数：本地package的路径（如果不加，则全部安装）<br>
可选参数：–dev：将依赖安装到devDependencies,不加时安装到dependencies</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><code>lerna link</code><br>
如果未发布上线，需要手动添加到package.json中再执行。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><code>lerna clean</code><br>
只会删除 node_modules,不会删除package.json中的依赖</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><code>lerna exec 和 lerna run</code><br>
–scope属性后添加的是包名，不是package的路径，这点和 lerna add 不同</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><code>lerna publish</code></li>
</ul>
<ol>
<li>发布时会自动执行 git add package-lock.json,所以该文件不能加入到.gitignore中去。</li>
<li>发布时先创建远程仓库，且push代码。</li>
<li>执行npm publish前完成 npm login</li>
<li>如果发布的包名为 @xxxx/yyy 的格式，需要现在npmjs.org上注册organization</li>
<li>发布到npm group时默认为private，package.json中需手动添加配置：</li>
</ol>
</blockquote>
<p><code>&quot;publishConfig&quot;: &#123;  &quot;access&quot;: &quot;public&quot;&#125;</code></p>
<h2 id="第四章-Lerna源码解析">第四章 Lerna源码解析</h2>
<p><strong>4-1 赚回学费：武装简历、升职加薪</strong></p>
<p>为什么要做源码解析：赚回学费、走上人生巅峰</p>
<blockquote>
<ul>
<li>自我成长、提升编码能力和技术深度的需要</li>
<li>为我所用，应用到实际开发，实际产生效益</li>
<li>学习借鉴，站在巨人的肩膀上，登高望远</li>
</ul>
</blockquote>
<p>为什么要分析Lerna源码</p>
<blockquote>
<ul>
<li>2W+ star的明星项目</li>
<li>Lerna是脚手架，对我们开发脚手架有借鉴意义</li>
<li>Lerna项目中蕴含大量的最佳实践，值得深入研究和学习</li>
</ul>
</blockquote>
<p>学习目标</p>
<blockquote>
<ul>
<li>Lerna源码结构和执行流程分析</li>
<li>import-local源码深度精读</li>
</ul>
</blockquote>
<p>学习收获</p>
<blockquote>
<ul>
<li>如何将源码分析写进简历</li>
<li>学习明星项目的架构设计</li>
<li>获得脚手架执行流程的一种实现思路</li>
<li>获得脚手架调试本地源码的另一种方式</li>
<li>Node.js加载node_modules模块的流程 ✨✨✨✨✨</li>
<li>各种文件操作算法和最佳实践</li>
</ul>
</blockquote>
<p><strong>4-2 lerna源码结构分析和调试技巧</strong></p>
<blockquote>
<ol>
<li>github下载lerna源码到本地且安装依赖！</li>
<li>使用webstorm打开源码，找到入口文件–package.json中的bin属性。</li>
<li>webstorm添加调试：Edit Configurations，这里需要在Configuration中添加<code>node parameters</code></li>
</ol>
</blockquote>
<p>这里遇到一个问题，代码调试的时候，Variables窗口内没内容。</p>
<p><strong>4-3 Node源码调试过程中必会的小技巧</strong></p>
<blockquote>
<ul>
<li>WebStorm -&gt; Preferences… -&gt; 搜索 Node.js and NPM -&gt; 勾选 Coding assistance for Node.js</li>
</ul>
</blockquote>
<p>这个目的是：对当前项目中的一些默认库或内置库做一些高亮,使得node提供的一些库文件可以进行跳转。</p>
<blockquote>
<ul>
<li>搜索 Debugger -&gt; Stepping -&gt; 默认勾选的都取消掉</li>
</ul>
</blockquote>
<p>这个目的是在调试的时候，取消勾选就可以进去一些库文件查看源码</p>
<p><strong>4-4 lerna初始化过程源码详细分析</strong></p>
<p>通过前面分析，我们知道，入口文件为：lerna/core/lerna/cli.js文件，从这里开始看源码：</p>
<blockquote>
<p>require(“.”)(<strong>process</strong>.argv.slice(2));</p>
<ul>
<li>require(‘.’):这里的 <code>.</code> 是相对路径,相当于是 require('./index.js)</li>
<li>到这行代码后，先加载与该cli.js同级别目录下的index.js文件。</li>
<li>等文件加载完毕后，将<strong>process</strong>.argv.slice(2)参数， 也就是我们写入的参数，传入到 index.js文件中module.exports出来的方法 main</li>
</ul>
</blockquote>
<p><strong>4-5 【高能知识点】npm项目本地依赖引用方法</strong></p>
<blockquote>
<p><strong>本地依赖的最佳实践</strong>：引用本地包的方式可以使用 file的方式，这是因为lerna publish的时候可以在线上环境把fiel的方式改成引用线上包的方式。大概是个这么个意思。这种方式可以去除之前使用 npm link的方式。</p>
</blockquote>
<blockquote>
<p>理解了这里本地依赖的file引用后，回到之前的3-6 lerna-publish发布流程项目，将本地引用的@cloudscope-cli/utils改为file引用，这里需要注意：在@cloudscope-cli/core中使用file方式引用了本地的utils包后，需要npm install一下。</p>
</blockquote>
<p><strong>4-6 脚手架框架yargs快速入门</strong></p>
<p>首先在npmjs官网搜索yargs，看一下基本使用情况,然后开始我们的学习：<br>
在某目录下，新建一个空的项目，具体操作如下：</p>
<blockquote>
<p>mkdir liugezhou-test<br>
npm init -y<br>
新建lib/index.js<br>
package.json文件添加 “bin”:“lib/index.js”<br>
npm install -S yarns<br>
npm install -S dedent</p>
</blockquote>
<p>然后，开始编辑index.js文件，进行yargs相关用法的学习：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-6.2vup03ac3eg0.webp" alt="2-6"></p>
<p><strong>4-7 yargs高级用法讲解</strong></p>
<p>关于yargs的command用法，我们从npmjs官网，看到示例如下：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-7.6vlv3vzsg740.webp" alt="2-7"><br>
通过以上代码，我们可以看到定义command的时候，传入了四个参数：</p>
<blockquote>
<ul>
<li>‘serve [port]’: command的格式,port为我们自定义的option，相当于  liugezhou-test  serve</li>
<li>‘start the serve’:关于此serve  command命令的补充描述</li>
<li>第三个参数为builder函数：在执行此command具体命令之前做的动作，比如上文为serve这个命令定义了一个参数 port，且给定port的默认值为5000</li>
<li>第四个参数我们叫做handler：是用来具体执行command的一个行为</li>
</ul>
</blockquote>
<p>在对上面demo有个简单了解后，回到我们上一节的代码中，继续添加command定义：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-8.hrcclk4of0w.webp" alt="2-8"></p>
<p><strong>4-8 lerna脚手架初始化过程超详细讲解</strong></p>
<p>通过 4-6、4-7两节内容，分析lerna脚手架的初始化过程讲解。<br>
<strong>4-9 lerna脚手架Command执行过程详解</strong></p>
<p>大致流程了解，未画流程图。</p>
<p><strong>4-10 【关键知识复习】javascript事件循环–EventLoop</strong></p>
<blockquote>
<ul>
<li>EventLoop中存在两种事件：宏任务(MacroTask)和微任务(MicroTask)</li>
<li>JavaScript脚本中加入到宏任务中去</li>
<li>当宏任务队列中任务执行完毕后，会将微任务队列中任务清空，清空之后再去执行宏任务队列。这种循环往复的执行流程就称为事件循环–EventLoop。</li>
<li>然后：我们在宏任务中加入一个setTimeout。</li>
<li>接着，我们在宏任务队列中加入一个 Promise.then() , Promise.then()中的内容会被加入到微任务队列中去。</li>
</ul>
</blockquote>
<p><strong>4-11 import-local执行流程深度分析</strong></p>
<blockquote>
<p>import-local的作用是：当我们的项目当中本地存在一个脚手架命令，同时全局在node当中也存在一个脚手架命令的时候，优先选用本地的node_modules中的版本。</p>
</blockquote>
<blockquote>
<p>在执行一个node代码的时候，默认会向node代码当中注入一些变量：__filename 、 __dirname 、 require 、 module、exports.</p>
</blockquote>
<blockquote>
<p>首先，执行lerna命令的时候，会执行node全局下的lerna，即which  lerna 指向的：<br>
软连接：/Users/liumingzhou/.nvm/versions/node/v12.16.1，<br>
实际指向：/Users/liumingzhou/.nvm/versions/node/v12.16.1/lib/node_modules/lerna/cli.js<code>[PRATIC]</code></p>
</blockquote>
<blockquote>
<p>然后，在webstorm的debug调试中，Node parameters修改为<code>[PRATIC]</code> 地址。<br>
接着，点击调试按钮，我们知道，程序首先进入的文件是<code>[PRATIC]</code></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="comment">/* eslint-disable import/no-dynamic-require, global-require */</span></span><br><span class="line"><span class="keyword">const</span> importLocal = <span class="built_in">require</span>(<span class="string">&quot;import-local&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (importLocal(__filename)) &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;npmlog&quot;</span>).<span class="title function_">info</span>(<span class="string">&quot;cli&quot;</span>, <span class="string">&quot;using local version of lerna&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;.&quot;</span>)(process.<span class="property">argv</span>.<span class="title function_">slice</span>(<span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面分析我们知道了执行流程，现在的重点就是看代码中的 require(‘import-local’)中的源码。<br>
我们进入到import-local源码中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> resolveCwd = <span class="built_in">require</span>(<span class="string">&#x27;resolve-cwd&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pkgDir = <span class="built_in">require</span>(<span class="string">&#x27;pkg-dir&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">filename</span> =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> globalDir = pkgDir.<span class="title function_">sync</span>(path.<span class="title function_">dirname</span>(filename));</span><br><span class="line"> <span class="keyword">const</span> relativePath = path.<span class="title function_">relative</span>(globalDir, filename);</span><br><span class="line"> <span class="keyword">const</span> pkg = <span class="built_in">require</span>(path.<span class="title function_">join</span>(globalDir, <span class="string">&#x27;package.json&#x27;</span>));</span><br><span class="line"> <span class="keyword">const</span> localFile = resolveCwd.<span class="title function_">silent</span>(path.<span class="title function_">join</span>(pkg.<span class="property">name</span>, relativePath));</span><br><span class="line"> <span class="keyword">return</span> localFile &amp;&amp; path.<span class="title function_">relative</span>(localFile, filename) !== <span class="string">&#x27;&#x27;</span> ? <span class="built_in">require</span>(localFile) : <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>path.dirname(filename)</code>：这句代码的意思是获取到文件filename的上级目录。</p>
</blockquote>
<p><strong>4-12 pkg-dir源码解析（一大波优秀的文件操作库)</strong></p>
<p>本节分析上面代码，对import-local源码细节分析，本节分析代码流程为globalDir是如何获得的：</p>
<blockquote>
<p>const pkgDir = require(‘pkg-dir’)<br>
pkg-dir:字面意思为，获得package.json文件的上级目录</p>
<p>进入 pkg-dir源码：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> findUp = <span class="built_in">require</span>(<span class="string">&#x27;find-up&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">cwd</span> =&gt;</span> <span class="title function_">findUp</span>(<span class="string">&#x27;package.json&#x27;</span>, &#123;cwd&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">fp</span> =&gt;</span> fp ? path.<span class="title function_">dirname</span>(fp) : <span class="literal">null</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">sync</span> = <span class="function"><span class="params">cwd</span> =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> fp = findUp.<span class="title function_">sync</span>(<span class="string">&#x27;package.json&#x27;</span>, &#123;cwd&#125;);</span><br><span class="line"> <span class="keyword">return</span> fp ? path.<span class="title function_">dirname</span>(fp) : <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们分析pkg-dir代码可知：pkg-dir这个库向我们暴露了两个方法：默认cwd和sync方法，其中sync方法会以同步的方式执行。</p>
<p>同时，这里又引用find-up这个库</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> locatePath = <span class="built_in">require</span>(<span class="string">&#x27;locate-path&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">filename, opts = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> startDir = path.<span class="title function_">resolve</span>(opts.<span class="property">cwd</span> || <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"> <span class="keyword">const</span> &#123;root&#125; = path.<span class="title function_">parse</span>(startDir);</span><br><span class="line"> <span class="keyword">const</span> filenames = [].<span class="title function_">concat</span>(filename);</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  (<span class="keyword">function</span> <span class="title function_">find</span>(<span class="params">dir</span>) &#123;</span><br><span class="line">   <span class="title function_">locatePath</span>(filenames, &#123;<span class="attr">cwd</span>: dir&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">     <span class="title function_">resolve</span>(path.<span class="title function_">join</span>(dir, file));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dir === root) &#123;</span><br><span class="line">     <span class="title function_">resolve</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="title function_">find</span>(path.<span class="title function_">dirname</span>(dir));</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">  &#125;)(startDir);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">sync</span> = <span class="function">(<span class="params">filename, opts = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">let</span> dir = path.<span class="title function_">resolve</span>(opts.<span class="property">cwd</span> || <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"> <span class="keyword">const</span> &#123;root&#125; = path.<span class="title function_">parse</span>(dir);</span><br><span class="line"> <span class="keyword">const</span> filenames = [].<span class="title function_">concat</span>(filename);</span><br><span class="line"> <span class="comment">// eslint-disable-next-line no-constant-condition</span></span><br><span class="line"> <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> file = locatePath.<span class="title function_">sync</span>(filenames, &#123;<span class="attr">cwd</span>: dir&#125;);</span><br><span class="line">  <span class="keyword">if</span> (file) &#123;</span><br><span class="line">   <span class="keyword">return</span> path.<span class="title function_">join</span>(dir, file);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (dir === root) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dir = path.<span class="title function_">dirname</span>(dir);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同理，find-up这个库也是默认的module.exports方法与同步返回的sync方法。<br>
这里我们继续分析find-up这个库的sync方法，一行一行代码解析：</p>
</blockquote>
<ol>
<li>let dir = path.resolve(opts.cwd || ‘’);</li>
</ol>
<blockquote>
<p>path.resolve是我node当中经常使用的方法，它主要作用是把两个相对路径进行结合。<br>
path.resolve(‘/Users’,‘/liumingzhou’),返回的路径为 /liumingzhou<br>
path.join(‘/Users’,‘/liumingzhou’),返回的路径为 /Users/liumingzhou</p>
<p>这里有个注意点是path.resolve(‘.’)返回的是当前路径,而path.join(‘.’),返回的就是. 不会帮我们判定当前的 . 与上级路径的关系。</p>
</blockquote>
<ol start="2">
<li>const {root} = path.parse(dir);</li>
</ol>
<blockquote>
<p>path.parse(“/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core”)<br>
返回的结果为：</p>
</blockquote>
<p>{<br>
root:‘/’,<br>
dir:‘/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core’,<br>
base:‘lerna’,<br>
ext:‘’,<br>
name:‘lerna’<br>
}</p>
<ol start="3">
<li>const filenames = [].concat(filename);</li>
</ol>
<blockquote>
<p>通过分析上下文，我们知道这行代码的filename指的是 package.json,于是filenames = [‘package.json’]</p>
</blockquote>
<ol start="4">
<li>while (true) {}</li>
</ol>
<blockquote>
<p>这里是个无限循环，需要注意的一点是退出条件</p>
</blockquote>
<ol start="5">
<li>const file = locatePath.sync(filenames, {cwd: dir});</li>
</ol>
<blockquote>
<p>这里又调用了这个locatePath这个库的sync方法，local-path这个库的作用是磁盘中是否存在这个路径，如果存在会把第一个文件返回。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">sync</span> = <span class="function">(<span class="params">iterable, options</span>) =&gt;</span> &#123;</span><br><span class="line"> options = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;</span><br><span class="line">  <span class="attr">cwd</span>: process.<span class="title function_">cwd</span>()</span><br><span class="line"> &#125;, options);</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">const</span> el <span class="keyword">of</span> iterable) &#123;</span><br><span class="line">  <span class="keyword">if</span> (pathExists.<span class="title function_">sync</span>(path.<span class="title function_">resolve</span>(options.<span class="property">cwd</span>, el))) &#123;</span><br><span class="line">   <span class="keyword">return</span> el;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过上面的代码，我们看到上面又用到了一个库：pathExists(通过名字我们显而易见的知道，这个库的作用是判断传入的一个路径是否存在的)，pathExists这个库源码不贴了，主要的一行代码是：fs.accessSync(fp),这行代码就是判断是否能到达一个文件，如果报错就会被try catch捕获返回false</p>
</blockquote>
<ol start="6">
<li>if (file) {</li>
</ol>
<p>return path.join(dir, file);         <br>
 }</p>
<blockquote>
<p>通过前面分析 path.join(dir, file)返回的就是<br>
/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/core/lerna/package.json</p>
</blockquote>
<p>最终获得globalDir！</p>
<p><strong>4-13 resolve-from源码解析（彻底搞懂node_modules模块加载逻辑）</strong></p>
<p>我们回到import-local源码，继续看<br>
const relativePath = path.relative(globalDir, filename);</p>
<blockquote>
<p>demo:<br>
const relativePath = path.relative(“/a/b/c”, ‘/a/b/c/d.js’);<br>
relativePath返回值为  d.js</p>
</blockquote>
<p>const pkg = require(path.join(globalDir, ‘package.json’));</p>
<blockquote>
<p>这里获得package.json这个文件</p>
</blockquote>
<p>import-local最关键的一部分来了：<br>
const localFile = resolveCwd.silent(path.join(<a target="_blank" rel="noopener" href="http://pkg.name">pkg.name</a>, relativePath));</p>
<blockquote>
<p>resolveCwd的含义是给出一个包名和主进入文件名，去本地文件中查找是否存在这样的路径</p>
</blockquote>
<p>然后我们就进入resolveCwd这个引用库的源码，查看是如何实现的(传入的参数为 lerna/cli.js)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> resolveFrom = <span class="built_in">require</span>(<span class="string">&#x27;resolve-from&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">moduleId</span> =&gt;</span> <span class="title function_">resolveFrom</span>(process.<span class="title function_">cwd</span>(), moduleId);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">silent</span> = <span class="function"><span class="params">moduleId</span> =&gt;</span> resolveFrom.<span class="title function_">silent</span>(process.<span class="title function_">cwd</span>(), moduleId);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里又引用了resolve-from这个库的silent静默方法(源码见下)：<br>
这里需要引起注意一点的是resolve-from这个库传入的两个参数分别是上面提到的 lerna/cli.js以及 process.cwd()这个参数，这个process.cwd的传入参数为Working directory：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-9.5jf81z9j35c0.webp" alt="2-9"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Module</span> = <span class="built_in">require</span>(<span class="string">&#x27;module&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolveFrom</span> = (<span class="params">fromDir, moduleId, silent</span>) =&gt; &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> fromDir !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`Expected \`fromDir\` to be of type \`string\`, got \`<span class="subst">$&#123;<span class="keyword">typeof</span> fromDir&#125;</span>\``</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> moduleId !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">`Expected \`moduleId\` to be of type \`string\`, got \`<span class="subst">$&#123;<span class="keyword">typeof</span> moduleId&#125;</span>\``</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fromDir = path.<span class="title function_">resolve</span>(fromDir);</span><br><span class="line">	<span class="keyword">const</span> fromFile = path.<span class="title function_">join</span>(fromDir, <span class="string">&#x27;noop.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">resolveFileName</span> = (<span class="params"></span>) =&gt; <span class="title class_">Module</span>.<span class="title function_">_resolveFilename</span>(moduleId, &#123;</span><br><span class="line">		<span class="attr">id</span>: fromFile,</span><br><span class="line">		<span class="attr">filename</span>: fromFile,</span><br><span class="line">		<span class="attr">paths</span>: <span class="title class_">Module</span>.<span class="title function_">_nodeModulePaths</span>(fromDir)</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (silent) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="title function_">resolveFileName</span>();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">resolveFileName</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">fromDir, moduleId</span>) =&gt;</span> <span class="title function_">resolveFrom</span>(fromDir, moduleId);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">silent</span> = <span class="function">(<span class="params">fromDir, moduleId</span>) =&gt;</span> <span class="title function_">resolveFrom</span>(fromDir, moduleId, <span class="literal">true</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>分析上面代码，最关键的代码为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">resolveFileName</span> = (<span class="params"></span>) =&gt; <span class="title class_">Module</span>.<span class="title function_">_resolveFilename</span>(moduleId, &#123;</span><br><span class="line">	<span class="attr">id</span>: fromFile,</span><br><span class="line">	<span class="attr">filename</span>: fromFile,</span><br><span class="line">	<span class="attr">paths</span>: <span class="title class_">Module</span>.<span class="title function_">_nodeModulePaths</span>(fromDir)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Module：node的内置模块，(通常开发过程中是不需要使用的),Module中的 下划线(_)方法，都称为内置方法<br>
_resolveFilename方法，是我们node中  require方法实现的核心方法之一，关于require方法的实现，参考阮一峰老师的这篇文章：<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2015/05/require.html">require()源码解读</a></p>
<p>分析上面这段代码，Module._resolveFilename的作用是解析模块的真实路径，这个方法传进去两个参数，其中第一个options我们发现了：<br>
Module._nodeModulesPaths(fromDir)这个方法，这个方法的作用是生成node_modules的可能路径。<br>
在对这个方法源码进行学习前，我们预先从老师那了解到了这个方法的实现逻辑：</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-10.6yvj127gn0w0.webp" alt="2-10"></p>
<p>然后我们进入到Module._nodeModulesPaths方法中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property">_nodeModulePaths</span> = <span class="keyword">function</span>(<span class="params"><span class="keyword">from</span></span>) &#123;</span><br><span class="line">    <span class="comment">// Guarantee that &#x27;from&#x27; is absolute.</span></span><br><span class="line">    <span class="keyword">from</span> = path.<span class="title function_">resolve</span>(<span class="keyword">from</span>);</span><br><span class="line">    <span class="comment">// Return early not only to avoid unnecessary work, but to *avoid* returning</span></span><br><span class="line">    <span class="comment">// an array of two items for a root: [ &#x27;//node_modules&#x27;, &#x27;/node_modules&#x27; ]</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">from</span> === <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="string">&#x27;/node_modules&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// note: this approach *only* works when the path is guaranteed</span></span><br><span class="line">    <span class="comment">// to be absolute.  Doing a fully-edge-case-correct path.split</span></span><br><span class="line">    <span class="comment">// that works on both Windows and Posix is non-trivial.</span></span><br><span class="line">    <span class="keyword">const</span> paths = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>.<span class="property">length</span> - <span class="number">1</span>, p = <span class="number">0</span>, last = <span class="keyword">from</span>.<span class="property">length</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">      <span class="keyword">const</span> code = <span class="keyword">from</span>.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">      <span class="keyword">if</span> (code === <span class="variable constant_">CHAR_FORWARD_SLASH</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p !== nmLen)</span><br><span class="line">          paths.<span class="title function_">push</span>(<span class="keyword">from</span>.<span class="title function_">slice</span>(<span class="number">0</span>, last) + <span class="string">&#x27;/node_modules&#x27;</span>);</span><br><span class="line">        last = i;</span><br><span class="line">        p = <span class="number">0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p !== -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nmChars[p] === code) &#123;</span><br><span class="line">          ++p;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          p = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append /node_modules to handle root paths.</span></span><br><span class="line">    paths.<span class="title function_">push</span>(<span class="string">&#x27;/node_modules&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> paths;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析以上代码，这里我们的from是：/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna<br>
然后通过上面算法计算，最后得到的结果是：</p>
<p>[/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/lerna/node_modules,<br>
/Users/liumingzhou/Documents/imoocCourse/Web前端架构师/node_modules,<br>
/Users/liumingzhou/Documents/imoocCourse/node_modules,<br>
/Users/liumingzhou/Documents/node_modules,<br>
/Users/liumingzhou/node_modules,<br>
/Users/node_modules,<br>
/node_modules]</p>
</blockquote>
<p>将这个数组返回后，我们继续分析Module._resolveFilename这个方法的源码：<br>
同样在对这个方法源码进行学习前，我们也预先从老师那了解到了这个方法的实现逻辑：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-11.666n2zheeec0.webp" alt="2-11"></p>
<p><strong>4-14 Node模块加载核心方法_resovleFileName源码深入解析</strong></p>
<p>首先，关于Module._resolveFileName的源码分析要更为复杂，这是因为算法部分较多。</p>
<p>Module._resolveFilename这个方法的源码为如下(代码逻辑添加注释)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property">_resolveFilename</span> = <span class="keyword">function</span>(<span class="params">request, parent, isMain, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">NativeModule</span>.<span class="title function_">canBeRequiredByUsers</span>(request)) &#123;  <span class="comment">//判断是否为可加载的内置模块</span></span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> paths;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&#x27;object&#x27;</span> &amp;&amp; options !== <span class="literal">null</span>) &#123;   <span class="comment">//我们在这传入的options是	   undefined，因此之间跳过到else中---即执行Module._resolveLookupPaths(request, parent);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">ArrayIsArray</span>(options.<span class="property">paths</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> isRelative = request.<span class="title function_">startsWith</span>(<span class="string">&#x27;./&#x27;</span>) ||</span><br><span class="line">          request.<span class="title function_">startsWith</span>(<span class="string">&#x27;../&#x27;</span>) ||</span><br><span class="line">          ((isWindows &amp;&amp; request.<span class="title function_">startsWith</span>(<span class="string">&#x27;.\\&#x27;</span>)) ||</span><br><span class="line">          request.<span class="title function_">startsWith</span>(<span class="string">&#x27;..\\&#x27;</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isRelative) &#123;</span><br><span class="line">        paths = options.<span class="property">paths</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> fakeParent = <span class="keyword">new</span> <span class="title class_">Module</span>(<span class="string">&#x27;&#x27;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        paths = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; options.<span class="property">paths</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> path = options.<span class="property">paths</span>[i];</span><br><span class="line">          fakeParent.<span class="property">paths</span> = <span class="title class_">Module</span>.<span class="title function_">_nodeModulePaths</span>(path);</span><br><span class="line">          <span class="keyword">const</span> lookupPaths = <span class="title class_">Module</span>.<span class="title function_">_resolveLookupPaths</span>(request, fakeParent);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; lookupPaths.<span class="property">length</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!paths.<span class="title function_">includes</span>(lookupPaths[j]))</span><br><span class="line">              paths.<span class="title function_">push</span>(lookupPaths[j]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">paths</span> === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      paths = <span class="title class_">Module</span>.<span class="title function_">_resolveLookupPaths</span>(request, parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title function_">ERR_INVALID_OPT_VALUE</span>(<span class="string">&#x27;options.paths&#x27;</span>, options.<span class="property">paths</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    paths = <span class="title class_">Module</span>.<span class="title function_">_resolveLookupPaths</span>(request, parent);  <span class="comment">// 然后就进入了_resolveLookPaths，进行了paths的一些合并，拿到合并的数组</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; parent.<span class="property">filename</span>) &#123;      <span class="comment">// 我们这里是有filename的</span></span><br><span class="line">    <span class="keyword">const</span> filename = <span class="title function_">trySelf</span>(parent.<span class="property">filename</span>, isMain, request);</span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">      <span class="title function_">emitExperimentalWarning</span>(<span class="string">&#x27;Package name self resolution&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> cacheKey = request + <span class="string">&#x27;\x00&#x27;</span> +</span><br><span class="line">          (paths.<span class="property">length</span> === <span class="number">1</span> ? paths[<span class="number">0</span>] : paths.<span class="title function_">join</span>(<span class="string">&#x27;\x00&#x27;</span>));</span><br><span class="line">      <span class="title class_">Module</span>.<span class="property">_pathCache</span>[cacheKey] = filename;</span><br><span class="line">      <span class="keyword">return</span> filename;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Look up the filename first, since that&#x27;s the cache key.</span></span><br><span class="line">  <span class="keyword">const</span> filename = <span class="title class_">Module</span>.<span class="title function_">_findPath</span>(request, paths, isMain, <span class="literal">false</span>);  <span class="comment">//另一非常有难度的方法，源代码见下面的下面</span></span><br><span class="line">  <span class="keyword">if</span> (filename) <span class="keyword">return</span> filename;</span><br><span class="line">  <span class="keyword">const</span> requireStack = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> cursor = parent;</span><br><span class="line">    cursor;</span><br><span class="line">    cursor = cursor.<span class="property">parent</span>) &#123;</span><br><span class="line">    requireStack.<span class="title function_">push</span>(cursor.<span class="property">filename</span> || cursor.<span class="property">id</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> message = <span class="string">`Cannot find module &#x27;<span class="subst">$&#123;request&#125;</span>&#x27;`</span>;</span><br><span class="line">  <span class="keyword">if</span> (requireStack.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    message = message + <span class="string">&#x27;\nRequire stack:\n- &#x27;</span> + requireStack.<span class="title function_">join</span>(<span class="string">&#x27;\n- &#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-restricted-syntax</span></span><br><span class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(message);</span><br><span class="line">  err.<span class="property">code</span> = <span class="string">&#x27;MODULE_NOT_FOUND&#x27;</span>;</span><br><span class="line">  err.<span class="property">requireStack</span> = requireStack;</span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Module._resolveLookupPaths这个方法的源码为如下(代码逻辑添加注释)：<br>
主要功能就是将paths和环境变量node_modules合并</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property">_resolveLookupPaths</span> = <span class="keyword">function</span>(<span class="params">request, parent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">NativeModule</span>.<span class="title function_">canBeRequiredByUsers</span>(request)) &#123;   <span class="comment">// 先判断是否为内置模块</span></span><br><span class="line">    <span class="title function_">debug</span>(<span class="string">&#x27;looking for %j in []&#x27;</span>, request);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check for node modules paths.</span></span><br><span class="line">  <span class="keyword">if</span> (request.<span class="title function_">charAt</span>(<span class="number">0</span>) !== <span class="string">&#x27;.&#x27;</span> ||</span><br><span class="line">      (request.<span class="property">length</span> &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">      request.<span class="title function_">charAt</span>(<span class="number">1</span>) !== <span class="string">&#x27;.&#x27;</span> &amp;&amp;</span><br><span class="line">      request.<span class="title function_">charAt</span>(<span class="number">1</span>) !== <span class="string">&#x27;/&#x27;</span> &amp;&amp;</span><br><span class="line">      (!isWindows || request.<span class="title function_">charAt</span>(<span class="number">1</span>) !== <span class="string">&#x27;\\&#x27;</span>))) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> paths = modulePaths;        <span class="comment">//环境变量中存储的一些node_modules目录</span></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="literal">null</span> &amp;&amp; parent.<span class="property">paths</span> &amp;&amp; parent.<span class="property">paths</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      paths = parent.<span class="property">paths</span>.<span class="title function_">concat</span>(paths);    <span class="comment">// 与之前传进来的paths进行合并</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">debug</span>(<span class="string">&#x27;looking for %j in %j&#x27;</span>, request, paths);</span><br><span class="line">    <span class="keyword">return</span> paths.<span class="property">length</span> &gt; <span class="number">0</span> ? paths : <span class="literal">null</span>;    <span class="comment">// 将合并的paths返回  </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In REPL, parent.filename is null.</span></span><br><span class="line">  <span class="keyword">if</span> (!parent || !parent.<span class="property">id</span> || !parent.<span class="property">filename</span>) &#123;</span><br><span class="line">    <span class="comment">// Make require(&#x27;./path/to/foo&#x27;) work - normally the path is taken</span></span><br><span class="line">    <span class="comment">// from realpath(__filename) but in REPL there is no filename</span></span><br><span class="line">    <span class="keyword">const</span> mainPaths = [<span class="string">&#x27;.&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="title function_">debug</span>(<span class="string">&#x27;looking for %j in %j&#x27;</span>, request, mainPaths);</span><br><span class="line">    <span class="keyword">return</span> mainPaths;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">debug</span>(<span class="string">&#x27;RELATIVE: requested: %s from parent.id %s&#x27;</span>, request, parent.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> parentDir = [path.<span class="title function_">dirname</span>(parent.<span class="property">filename</span>)];</span><br><span class="line">  <span class="title function_">debug</span>(<span class="string">&#x27;looking for %j&#x27;</span>, parentDir);</span><br><span class="line">  <span class="keyword">return</span> parentDir;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Module._findPath要解决的问题是在paths中解析模块的真实路径，<br>
同样在对这个方法源码进行学习前，我们也预先从老师那了解到了这个方法的实现逻辑：<br>
<img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-12.2oq71qhv97u0.webp" alt="2-12"><br>
源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property">_findPath</span> = <span class="keyword">function</span>(<span class="params">request, paths, isMain</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> absoluteRequest = path.<span class="title function_">isAbsolute</span>(request);  <span class="comment">//判断是否为绝对路径</span></span><br><span class="line">  <span class="keyword">if</span> (absoluteRequest) &#123;</span><br><span class="line">    paths = [<span class="string">&#x27;&#x27;</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!paths || paths.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 \x00 生成一大段的cacheKey</span></span><br><span class="line">  <span class="keyword">const</span> cacheKey = request + <span class="string">&#x27;\x00&#x27;</span> +</span><br><span class="line">                (paths.<span class="property">length</span> === <span class="number">1</span> ? paths[<span class="number">0</span>] : paths.<span class="title function_">join</span>(<span class="string">&#x27;\x00&#x27;</span>));</span><br><span class="line">  <span class="keyword">const</span> entry = <span class="title class_">Module</span>.<span class="property">_pathCache</span>[cacheKey];</span><br><span class="line">  <span class="keyword">if</span> (entry)</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exts;</span><br><span class="line">  <span class="comment">// trailingSlash判断request是否已 / 结尾的</span></span><br><span class="line">  <span class="keyword">let</span> trailingSlash = request.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    request.<span class="title function_">charCodeAt</span>(request.<span class="property">length</span> - <span class="number">1</span>) === <span class="variable constant_">CHAR_FORWARD_SLASH</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 若不是以 / 结尾，</span></span><br><span class="line">  <span class="keyword">if</span> (!trailingSlash) &#123;</span><br><span class="line">  <span class="comment">//会以正则进行匹配，这里的正则在下下节专门学习，这里暂时略过，这里的结论：该正则表示的结果为  是否是以“/..、/.、.. 、 . ”结尾</span></span><br><span class="line">    trailingSlash = <span class="regexp">/(?:^|\/)\.?\.$/</span>.<span class="title function_">test</span>(request);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For each path</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t search further if path doesn&#x27;t exist</span></span><br><span class="line">    <span class="comment">//一次拿出paths中存储的值</span></span><br><span class="line">    <span class="keyword">const</span> curPath = paths[i];  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//stat(curPath)返回结果 1是文件夹，0为文件，我们这里第一个返回的是文件夹 1，因此，不会跳出循环，继续向下执行</span></span><br><span class="line">    <span class="keyword">if</span> (curPath &amp;&amp; <span class="title function_">stat</span>(curPath) &lt; <span class="number">1</span>) <span class="keyword">continue</span>; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里的意思就是将我们的curPath与request做一个结合</span></span><br><span class="line">    <span class="keyword">const</span> basePath = <span class="title function_">resolveExports</span>(curPath, request, absoluteRequest);</span><br><span class="line">    <span class="keyword">let</span> filename;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//stat(basePath)看上面合成的文件是否存在，为0说明为文件且文件存在</span></span><br><span class="line">    <span class="keyword">const</span> rc = <span class="title function_">stat</span>(basePath);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断结尾是不是一个 /</span></span><br><span class="line">    <span class="keyword">if</span> (!trailingSlash) &#123;</span><br><span class="line">      </span><br><span class="line">     <span class="comment">// 判断当前的basePath是否为一个文件 </span></span><br><span class="line">      <span class="keyword">if</span> (rc === <span class="number">0</span>) &#123;  <span class="comment">// File.</span></span><br><span class="line">        </span><br><span class="line">     <span class="comment">// isMain是否传入   </span></span><br><span class="line">        <span class="keyword">if</span> (!isMain) &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//是否阻止去做超链接，根据我们的分析，这里不是 preserveSymlinks为false</span></span><br><span class="line">          <span class="keyword">if</span> (preserveSymlinks) &#123;</span><br><span class="line">            filename = path.<span class="title function_">resolve</span>(basePath);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// toRealPath：我们的分析 basePath在这里为软连接，然后通过此方法，找到真实的文件路径。然后，我们进入下一节，看看这个toRealPath是如何实现的</span></span><br><span class="line">            filename = <span class="title function_">toRealPath</span>(basePath);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (preserveSymlinksMain) &#123;</span><br><span class="line">          <span class="comment">// For the main module, we use the preserveSymlinksMain flag instead</span></span><br><span class="line">          <span class="comment">// mainly for backward compatibility, as the preserveSymlinks flag</span></span><br><span class="line">          <span class="comment">// historically has not applied to the main module.  Most likely this</span></span><br><span class="line">          <span class="comment">// was intended to keep .bin/ binaries working, as following those</span></span><br><span class="line">          <span class="comment">// symlinks is usually required for the imports in the corresponding</span></span><br><span class="line">          <span class="comment">// files to resolve; that said, in some use cases following symlinks</span></span><br><span class="line">          <span class="comment">// causes bigger problems which is why the preserveSymlinksMain option</span></span><br><span class="line">          <span class="comment">// is needed.</span></span><br><span class="line">          filename = path.<span class="title function_">resolve</span>(basePath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          filename = <span class="title function_">toRealPath</span>(basePath);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">        <span class="comment">// Try it with each of the extensions</span></span><br><span class="line">        <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">          exts = <span class="title class_">ObjectKeys</span>(<span class="title class_">Module</span>.<span class="property">_extensions</span>);</span><br><span class="line">        filename = <span class="title function_">tryExtensions</span>(basePath, exts, isMain);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!filename &amp;&amp; rc === <span class="number">1</span>) &#123;  <span class="comment">// Directory.</span></span><br><span class="line">      <span class="comment">// try it with each of the extensions at &quot;index&quot;</span></span><br><span class="line">      <span class="keyword">if</span> (exts === <span class="literal">undefined</span>)</span><br><span class="line">        exts = <span class="title class_">ObjectKeys</span>(<span class="title class_">Module</span>.<span class="property">_extensions</span>);</span><br><span class="line">      filename = <span class="title function_">tryPackage</span>(basePath, exts, isMain, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">      <span class="title class_">Module</span>.<span class="property">_pathCache</span>[cacheKey] = filename;</span><br><span class="line">      <span class="keyword">return</span> filename;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>4-15 fs模块toRealPath源码深入解析</strong></p>
<p>我们到toRealPath方法后，webStorm的node调试工具，点击继续 Step Into到该方法中，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 通过代码，我们知道toRealPath的方法实现，正如上面的逻辑图显示的，使用的是 fs.realpathSync这个模块。</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toRealPath</span>(<span class="params">requestPath</span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 该方法传入两个参数，一个路径地址 requestPath，以及一个options</span></span><br><span class="line">  <span class="comment">// realpathCache为一个chche，表示的是当前已经做过路径判断的所有路径缓存，绝大多数的key值与value值是一样的，并没有软链接，但是也存在少量的有软连接的：key与value值不同</span></span><br><span class="line">  <span class="keyword">return</span> fs.<span class="title function_">realpathSync</span>(requestPath, &#123;</span><br><span class="line">    [internalFS.<span class="property">realpathCacheKey</span>]: realpathCache</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，我们在进去toRealPath这个方法，看到fs.realpathSync实现之前，我们先从老师哪里有拿到逻辑图，并根据图进行分析学习该代码里面的逻辑：</p>
<p><img src="https://cdn.jsdelivr.net/gh/liugezhou/image@master/imooc-course/2-13.21kw7t7x45pc.webp" alt="2-13"></p>
<p>然后我们继续 Step Into到fs.realpathSync这个方法中，源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options 为Symbol</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">realpathSync</span>(<span class="params">p, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!options)</span><br><span class="line">    options = emptyObj;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    options = <span class="title function_">getOptions</span>(options, emptyObj);</span><br><span class="line">  p = <span class="title function_">toPathIfFileURL</span>(p);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果不是string格式的，进行格式转换</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> p !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    p += <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//判断该路径是否为有效路径</span></span><br><span class="line">  <span class="title function_">validatePath</span>(p);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//pathModule 与我们直接引用的path模块没有区别：相对路径转为绝对路径</span></span><br><span class="line">  p = pathModule.<span class="title function_">resolve</span>(p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cache为一个map对象</span></span><br><span class="line">  <span class="keyword">const</span> cache = options[realpathCacheKey];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 查找缓存</span></span><br><span class="line">  <span class="keyword">const</span> maybeCachedResult = cache &amp;&amp; cache.<span class="title function_">get</span>(p);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 是否查到了缓存，如果查到直接返回，如果没有查到，继续向后</span></span><br><span class="line">  <span class="keyword">if</span> (maybeCachedResult) &#123;</span><br><span class="line">    <span class="keyword">return</span> maybeCachedResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义所有软连接的缓存，ObjectCreate(null)创建的对象没有原型链，好处为它是一个纯粹的对象，节约内存空间</span></span><br><span class="line">  <span class="keyword">const</span> seenLinks = <span class="title class_">ObjectCreate</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> knownHard = <span class="title class_">ObjectCreate</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//将传入的path保存下来，做了一个缓存，这里的p相当于缓存中的key(若是软连接，则为软连接路径)，original相当于value(实际路径)，这么做的原因为：这里的p我们后面可能会发生改变</span></span><br><span class="line">  <span class="keyword">const</span> original = p;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 然后下面代码，进入到上图流程图中的路径是否存在/这个流程</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Current character position in p</span></span><br><span class="line">  <span class="keyword">let</span> pos;</span><br><span class="line">  <span class="comment">// The partial path so far, including a trailing slash if any</span></span><br><span class="line">  <span class="keyword">let</span> current;</span><br><span class="line">  <span class="comment">// The partial path without a trailing slash (except when pointing at a root)</span></span><br><span class="line">  <span class="keyword">let</span> base;</span><br><span class="line">  <span class="comment">// The partial path scanned in the previous round, with slash</span></span><br><span class="line">  <span class="keyword">let</span> previous;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Skip over roots</span></span><br><span class="line">  <span class="comment">// 找到p中的根路径</span></span><br><span class="line">  current = base = <span class="title function_">splitRoot</span>(p);</span><br><span class="line">  pos = current.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// On windows, check that the root exists. On unix there is no need.</span></span><br><span class="line">  <span class="comment">// 这里是windows系统的逻辑，我们是mac的，所以可以先跳过</span></span><br><span class="line">  <span class="keyword">if</span> (isWindows &amp;&amp; !knownHard[base]) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = &#123; <span class="attr">path</span>: base &#125;;</span><br><span class="line">    binding.<span class="title function_">lstat</span>(pathModule.<span class="title function_">toNamespacedPath</span>(base), <span class="literal">false</span>, <span class="literal">undefined</span>, ctx);</span><br><span class="line">    <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line">    knownHard[base] = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Walk down the path, swapping out linked path parts for their real</span></span><br><span class="line">  <span class="comment">// values</span></span><br><span class="line">  <span class="comment">// NB: p.length changes.</span></span><br><span class="line">  <span class="comment">// 然后开始循环 由上文得知，我们的pos长度为1，p的长度为传入的path的长度</span></span><br><span class="line">  <span class="keyword">while</span> (pos &lt; p.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// find the next part</span></span><br><span class="line">    <span class="comment">// nextPart这里调用的就是p.indexOf(&#x27;/&#x27;,pos),这个方法举例如下：</span></span><br><span class="line">    <span class="comment">// &quot;/xxx/yyy&quot;.indexOf(&#x27;/&#x27;)  =&gt; 0  这里我们找到的是第一个“/”的位置，如果我们想找第二个“/”位置</span></span><br><span class="line">    <span class="comment">// &quot;/xxx/yyy&quot;.indexOf(&#x27;/&#x27;,1) =&gt; 4,这里的1指的是跳过第一个元素，从第二个元素开始寻找</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="title function_">nextPart</span>(p, pos);</span><br><span class="line">    previous = current;</span><br><span class="line">    <span class="keyword">if</span> (result === -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> last = p.<span class="title function_">slice</span>(pos);</span><br><span class="line">      current += last;</span><br><span class="line">      base = previous + last;</span><br><span class="line">      pos = p.<span class="property">length</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      current += p.<span class="title function_">slice</span>(pos, result + <span class="number">1</span>);</span><br><span class="line">      base = previous + p.<span class="title function_">slice</span>(pos, result);</span><br><span class="line">      pos = result + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断一下在cahe中是否存在</span></span><br><span class="line">    <span class="comment">// Continue if not a symlink, break if a pipe/socket</span></span><br><span class="line">    <span class="keyword">if</span> (knownHard[base] || (cache &amp;&amp; cache.<span class="title function_">get</span>(base) === base)) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 判断是否为一个file</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isFileType</span>(statValues, <span class="variable constant_">S_IFIFO</span>) ||</span><br><span class="line">          <span class="title function_">isFileType</span>(statValues, <span class="variable constant_">S_IFSOCK</span>)) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> resolvedLink;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是不是软链接，从缓存中去拿</span></span><br><span class="line">    <span class="keyword">const</span> maybeCachedResolved = cache &amp;&amp; cache.<span class="title function_">get</span>(base);</span><br><span class="line">    <span class="keyword">if</span> (maybeCachedResolved) &#123;</span><br><span class="line">      resolvedLink = maybeCachedResolved;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Use stats array directly to avoid creating an fs.Stats instance just</span></span><br><span class="line">      <span class="comment">// for our internal use.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 没有拿到，然后做处理</span></span><br><span class="line">      <span class="keyword">const</span> baseLong = pathModule.<span class="title function_">toNamespacedPath</span>(base);</span><br><span class="line">      <span class="keyword">const</span> ctx = &#123; <span class="attr">path</span>: base &#125;;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// stats可以打印出 文件在操作系统下的各种信息/ dev_t:文件的设备编号 ino_t:文件在此设备的唯一标识</span></span><br><span class="line">      <span class="keyword">const</span> stats = binding.<span class="title function_">lstat</span>(baseLong, <span class="literal">false</span>, <span class="literal">undefined</span>, ctx);</span><br><span class="line">      <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 判断是否为一个软连接</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isFileType</span>(stats, <span class="variable constant_">S_IFLNK</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果不是软连接，将判断过的路径放入到 knowHard当中</span></span><br><span class="line">        knownHard[base] = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (cache) cache.<span class="title function_">set</span>(base, base);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 判断到该路径是一个软连接，然后继续执行下面的代码</span></span><br><span class="line">      <span class="comment">// Read the link if it wasn&#x27;t read before</span></span><br><span class="line">      <span class="comment">// dev/ino always return 0 on windows, so skip the check.</span></span><br><span class="line">      <span class="comment">//linkTarget 软连接实际的路径地址</span></span><br><span class="line">      <span class="keyword">let</span> linkTarget = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> id;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 判断是否为window操作系统</span></span><br><span class="line">      <span class="keyword">if</span> (!isWindows) &#123;</span><br><span class="line">        <span class="comment">// 拿到stat的0号元素，即我们上面注释提到的文件设备编号</span></span><br><span class="line">        <span class="keyword">const</span> dev = stats[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">32</span>);</span><br><span class="line">        <span class="comment">// 拿到stat的7号元素，即我们上面注释提到的文件唯一标识</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//拿到这两个是想生成一个唯一键：这个文件在当下PC系统下的唯一键</span></span><br><span class="line">        <span class="keyword">const</span> ino = stats[<span class="number">7</span>].<span class="title function_">toString</span>(<span class="number">32</span>);</span><br><span class="line">        id = <span class="string">`<span class="subst">$&#123;dev&#125;</span>:<span class="subst">$&#123;ino&#125;</span>`</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过这两个唯一键生成的唯一键作为 seenLinks的唯一键</span></span><br><span class="line">        <span class="comment">// 下面代码为在seenLinks中查找是否有这个id，如果有就直接拿出来</span></span><br><span class="line">        <span class="keyword">if</span> (seenLinks[id]) &#123;</span><br><span class="line">          linkTarget = seenLinks[id];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 没有这个软连接的实际路径地址</span></span><br><span class="line">      <span class="keyword">if</span> (linkTarget === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> ctx = &#123; <span class="attr">path</span>: base &#125;;</span><br><span class="line">        binding.<span class="title function_">stat</span>(baseLong, <span class="literal">false</span>, <span class="literal">undefined</span>, ctx);</span><br><span class="line">        <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line">        <span class="comment">// 拿到软连接的实际路径</span></span><br><span class="line">        linkTarget = binding.<span class="title function_">readlink</span>(baseLong, <span class="literal">undefined</span>, <span class="literal">undefined</span>, ctx);</span><br><span class="line">        <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line">      &#125;</span><br><span class="line">      resolvedLink = pathModule.<span class="title function_">resolve</span>(previous, linkTarget);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (cache) cache.<span class="title function_">set</span>(base, resolvedLink);</span><br><span class="line">      <span class="keyword">if</span> (!isWindows) seenLinks[id] = linkTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resolve the link, then start over</span></span><br><span class="line">    <span class="comment">// 将path真实路径重新生成</span></span><br><span class="line">    p = pathModule.<span class="title function_">resolve</span>(resolvedLink, p.<span class="title function_">slice</span>(pos));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip over roots</span></span><br><span class="line">    current = base = <span class="title function_">splitRoot</span>(p);</span><br><span class="line">    pos = current.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// On windows, check that the root exists. On unix there is no need.</span></span><br><span class="line">    <span class="keyword">if</span> (isWindows &amp;&amp; !knownHard[base]) &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = &#123; <span class="attr">path</span>: base &#125;;</span><br><span class="line">      binding.<span class="title function_">lstat</span>(pathModule.<span class="title function_">toNamespacedPath</span>(base), <span class="literal">false</span>, <span class="literal">undefined</span>, ctx);</span><br><span class="line">      <span class="title function_">handleErrorFromBinding</span>(ctx);</span><br><span class="line">      knownHard[base] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cache) cache.<span class="title function_">set</span>(original, p);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">encodeRealpathResult</span>(p, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>4-16 讲一个高难度的正则表达式（想挑战的点进来）</strong></p>
<blockquote>
<p>trailingSlash = /(?:^|/).?.$/.test(request);</p>
</blockquote>
<blockquote>
<p>console.log(/(?:^|/).?.$/.test(‘a’))    --&gt; false<br>
console.log(/(?:^|/).?.$/.test(‘…’))    --&gt; true<br>
console.log(/(?:^|/).?.$/.test(‘/…’))    --&gt; true<br>
console.log(/(?:^|/).?.$/.test(‘/Users’))    --&gt; false</p>
</blockquote>
<blockquote>
<p>''  转译字符</p>
<p>在正则表达式中  ‘.‘ 是有含义的，表示匹配任意一个字符：<br>
const str = ‘a’;<br>
console.log(a.match(/./))  --&gt; [‘a’, index:0, input:‘a’, groups:undefined]</p>
<p>因此在正则表达式中要匹配 . 的话，需要加一个 反斜杠 ‘\’，因此‘.’ 匹配的就是一个点<br>
console.log(a.match(/./))  --&gt; null</p>
<p>‘?’:表示匹配0个或1个字符<br>
‘$’:表示最后的匹配样式<br>
():表示需要返回匹配结果，分组<br>
(?:  ) 表示非匹配分组,不把()中分组的内容显示出来<br>
^:表示非的符号：[!.]表示的是匹配没有. 符号的，需要加[]，但是上文的正则没有[]，上文表示的是匹配一个空格，<br>
‘|’ : 或</p>
</blockquote>
<p><strong>4-17 大招：如何快速拿到面试“一血”</strong></p>
<p><strong>简历简介</strong></p>
<blockquote>
<p>简历中简介部分至关重要，因为它位于简历的第一屏，是面试官最容易关注的部分，所以我们应该在简介部分充分突出我们的个人特长和优势</p>
</blockquote>
<p><strong>认真学完本章内容后应该怎么修改简历？</strong></p>
<blockquote>
<ul>
<li>熟悉yargs脚手架开发框架</li>
<li>熟悉多Package管理工具lerna的使用方法和使用原理</li>
<li>深入理解Node.js模块路径解析流程</li>
</ul>
</blockquote>
<p><strong>面试官问起细节后如何回答？</strong></p>
<ul>
<li>如何通过yargs开发一个脚手架？</li>
</ul>
<blockquote>
<p>答：比如vue-cli的脚手架为：vue create myProjectName</p>
</blockquote>
<ol>
<li>脚手架的构成一般由三个部分构成：</li>
</ol>
<blockquote>
<p>第一个部分就是： 主命令，也就是bin，它是在packag.json中配置的，通过npm link 进行本地安装<br>
第二个部分 ：command：命令<br>
第三个部分：options 参数<br>
然后需要的一点是主命令bin的配置指向的主文件中，需要在文件顶部加上  #!/usr/bin/env node,就是说在环境变量中找到node命令来执行。</p>
</blockquote>
<ol start="2">
<li>脚手架的初始化流程</li>
</ol>
<blockquote>
<p>第一步：首先是直接调用Yargs的构造函数，直接去生成一个脚手架</p>
<p>第二步：会调用一系列的Yargs提供的常用方法，对脚手架功能进行一个增强。<br>
比如 yargs.usage(用法)、<br>
yargs.options(注册一些脚手架参数熟悉)、<br>
可以调用yargs.group(来对脚手架参数熟悉进行分组)、<br>
yargs.fail(对脚手架异常进行监听)，<br>
还有包括yargs尾部结语的设置yargs.elipogue()、<br>
脚手架窗口设置yargs.wrap()<br>
以及yargs.decomandrecommed(至少输入一个参数)<br>
以及yargs.recommedCommands()推荐命令的提示等</p>
<p>第三步：需要对脚手架的参数进行一些解析：hideBin(process.argv),其实也就是直接取出从第三个开始的参数.调用的时候直接 yargs.argv<br>
还有一种解析方式就是通过yargs.parse(argv,options)的方法</p>
<p>第四步：当脚手架的参数解析完成之后，我们要进行命令注册<br>
命令注册我们使用的是yargs.command()方法。<br>
command的注册方式有两种：第一种是一次传参(command,describe,builder,handler),还有一种方式就是传入一个对象，对象属性与第一种方式传入的相同。</p>
</blockquote>
<ul>
<li>熟悉多Package管理工具lerna的使用方法和使用原理</li>
</ul>
<blockquote>
<p>答：首先lerna是基于一个 git + npm的多package，也就是多包的项目管理工具，像一些开源的大型库：vue-vcli/create-react-app/babel等都是基于lerna进行多包管理的。他的作用就是降低包的管理操作成本，提高开发效率。像包的安装、依赖的添加、依赖的解除以及包的发布、打标签等功能。</p>
<p>实现原理：<br>
首先就是通过 import-local这个库优先调用lerna的本地命令，<br>
然后通过yargs生成一个脚手架、生成脚手架后生成一些全局参数、然后注册命令，通过yargs.parse方法进行参数解析。<br>
需要注意的是lerna的命令注册过程中，需要传入builder以及handler两个方法，builder命令用于注册命令专属的options，而handelr用来处理命令的业务逻辑。<br>
有一点非常值得学习的内容就是lerna它是通过配置本地依赖的方式进行开发的，具体写法就是在package.json的依赖当中通过file的格式书写，在lerna publish的时候再将该路径替换。</p>
</blockquote>
<ul>
<li>对Node.js模块路径解析流程的一个理解</li>
</ul>
<blockquote>
<p>第一：首先Node.js模块的路径解析是通过 require.resolve()方法来实现的<br>
第二：这个resolve方法就是Module._resolveFileName()方法<br>
它的作用就是我们给定一个模块名称的时候，查找处这个模块的真实路径。</p>
<p>然后，他的核心实现流程有三点：</p>
<ol>
<li>在执行流程中判断当前路径是否为内置模块，若是内置模块直接返回</li>
<li>若不是内置模块，它会继续调用自身的Module._resolveLookupPaths()方法生成node_modules的所有可能路径</li>
<li>最后再通过Module._findPath()去查询模块的真实路径。</li>
</ol>
<p>这里关于Module._findPaths()方法的核心实现流程有四步</p>
<ol>
<li>查询缓存(将request[模块名称]和paths[上面返回的所有可生成的node_modules路径]通过\x00合并成cacheKey)</li>
<li>缓存查不到，就会遍历paths，将每一个path与request结合组成文件路径basePath</li>
<li>然后判断这个basePath路径是否存在，如果存在会调用 fs.realPathSync()方法获取文件的真实路径，不存在就会继续遍历。</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li>同时，将文件的真实路径缓存到Module._pathcache()中。</li>
</ol>
</blockquote>
<blockquote>
<p>这里关于fs.realPathsync()方法的核心流程有三点：</p>
<ol>
<li>仍然是查询缓存，缓存的key就是我们的path，即basePath，</li>
<li>如果这个key没有找到，就会将这个key从左到右开始遍历，通过/进行循环遍历，拆分路径，然后判断这个路径是否为软链接，如果是软链接，就去查询它的真实路径，并生成新的path路径，这个新的path路径继续传入这个遍历函数，继续往后遍历，(这里有一个细节需要注意的是：遍历过程中生成的子路径base会缓存在knowHard和ache中，避免重复查询)。</li>
<li>遍历完成后，就会得到模块的真实路径，并且将原始路径，也就是我们说的软连接路径作为key值，将真实值作为值，保存在缓存中</li>
</ol>
</blockquote>
<blockquote>
<p>在require中还有一个方法是 require.resolve.paths()方法，这个方法的作用是用于获取所有node_modules可能存在的路径，他的核心内容就是Module._resolveLookupPaths()</p>
</blockquote>
<blockquote>
<p>Module._resolveLookupPaths()的实现原理有两点<br>
第一点，如果是 /路径，就在后面加入 node_modules<br>
第二点，将路径从后往前遍历，如果查询到 / ，就拆分路径，在后面加上node_modules,一直遍历到查找不到 /路径，就会返回这个paths数组。</p>
</blockquote>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.3" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.3"><p><span>本文标题：</span>Week2-脚手架架构设计和框架搭建</p><p><span>文章作者：</span>六个周</p><p><span>发布时间：</span>2021-01-20</p><p><span>最后更新：</span>2022-05-04</p><p><span>原始链接：</span><a href="/Week2-脚手架架构设计和框架搭建/">https://blog.liugezhou.online/Week2-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://blog.liugezhou.online/Week2-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div><br><div class="tags"><a href="/tags/Web架构之脚手架"><i class="fa fa-tag">Web架构之脚手架</i></a></div><div class="post-nav"><a class="pre" href="/Week3-%E8%84%9A%E6%89%8B%E6%9E%B6%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E5%BC%80%E5%8F%91/">Week3-脚手架核心流程开发</a><a class="next" href="/Week1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E4%B8%8E%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">Week1-需求分析与架构设计</a></div><div id="vcomment"></div><script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'Ci6gl5SnXOdXxv9BTlQx3T2F-gzGzoHsz',
  appKey:'bWsfs1hg9qURRp3gJ6SJU41x',
  placeholder:'ヾﾉ≧∀≦)o来啊，快活啊!',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 文章分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%84%9A%E6%89%8B%E6%9E%B6/">Web架构之脚手架</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%9B%E4%B8%9A/">创业</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF%E5%B0%8F%E6%8A%80/">前端小技</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">博客搭建</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%8F%E5%91%A8%E5%B0%8F%E7%BB%93/">每周小结</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">浏览器工作原理</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E4%B9%A6/">读书</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 其它主页</i></div><ul></ul><a href="https://github.com/liugezhou" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://twitter.com/liugezhou" title="Twitter" target="_blank">Twitter</a><ul></ul><a href="https://chat.liugezhou.online" title="自定义GPT" target="_blank">自定义GPT</a><ul></ul><a href="https://day.liugezhou.online" title="今日前端" target="_blank">今日前端</a><ul></ul><a href="https://run.liugezhou.online" title="Running" target="_blank">Running</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">六个周.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"></a><a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.3" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.3" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.3"><script type="text/javascript" src="/js/search.js?v=1.0.3"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/love.js?v=1.0.3"></script><script type="text/javascript" src="/js/copycode.js?v=1.0.3" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.3"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.3"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.3"></script></div></body></html>